<!DOCTYPE html>
<html lang="en" data-theme="light" style="--card: #ffffff; --card-hover: #f1f5f9; --text: #374151; --muted: #6b7280; --border: rgba(0,0,0,0.1); --modal-bg: #ffffff; --modal-text: #374151; --bg-dark-primary: #f7f9fc; --bg-dark-secondary: #e8edf5; --button-gradient-start: #4A90E2; --button-gradient-end: #357ABD; --gradient: linear-gradient(135deg, #4A90E2, #357ABD); --accent: #36bf6a; --module-border-color: #ff6b6b; --modal-border-color: #ff6b6b;">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opsis TimeSync ‚Äì Annual Management</title>
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="api.js"></script>
    
    <style>
        /* Import Inter font from Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        /* Base reset and font */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        /* Theme variables */
        :root {
            /* TimeSync Blue Theme */
            --timesync-primary: #4A90E2;
            --timesync-secondary: #357ABD;
            --timesync-gradient: linear-gradient(135deg, var(--timesync-primary), var(--timesync-secondary));
            /* Base colours and backgrounds for light mode */
            --bg: #f9fafb;
            --bg-dark-primary: #f9fafb;
            --bg-dark-secondary: #f3f4f6;
            /* Cards use solid light background by default */
            --card: #ffffff;
            --card-hover: #f9fafb;
            /* Text colours for light mode */
            --text: #1f2937;
            --muted: #6b7280;
            /* Border colour for light mode */
            --border: #e5e7eb;
            --accent: var(--timesync-primary);
            /* Brand colours */
            --brand-primary: #495057;
            --brand-secondary: #6c757d;
            /* States */
            --success: #20c997;
            --warning: #ffc107;
            --error: #dc3545;
            /* Typography */
            --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            /* Geometry and premium design */
            --border-radius-xl: 32px;
            --border-radius-lg: 24px;
            --border-radius-md: 16px;
            --card-padding: 3rem 2.5rem;
            --transition-smooth: 0.4s ease;
            /* Primary palette mapping */
            --primary: var(--timesync-primary);
            --secondary: var(--timesync-secondary);
            --gradient: var(--timesync-gradient);
            /* Card and hover effects */
            --card-radius: var(--border-radius-xl);
            --hover-lift: -15px;
            --card-shadow-y: 25px;
            /* Modal and button customization variables */
            --modal-bg: var(--card);
            --modal-text: var(--text);
            --modal-radius: 24px;
            --button-gradient-start: var(--timesync-primary);
            --button-gradient-end: var(--timesync-secondary);
            --button-radius: 16px;
            /* Border colours for each page */
            --dashboard-border: #ff6b6b;
            --schedule-border: #4ecdc4;
            --staff-border: #45b7d1;
            --reports-border: #5f27cd;
            --users-border: #ff9f43;
            --settings-border: #ee5a6f;
            /* Current page border colour */
            --module-border-color: var(--dashboard-border);
            --modal-border-color: var(--dashboard-border);
        }

        html, body {
            margin: 0;
            padding: 0;
            font-family: var(--font);
            background: linear-gradient(135deg, var(--bg-dark-primary) 0%, var(--bg-dark-secondary) 100%);
            font-size: 14px;
            color: var(--text);
            position: relative;
            min-height: 100vh;
        }
        
        a {
            color: inherit;
            text-decoration: none;
        }
        
        button {
            font-family: inherit;
        }
        
        /* Layout */
        .app {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        .sidebar {
            width: 52px;
            background: #f8fafc;
            color: #374151;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 100px 0 12px;
            border-right: 1px solid #e5e7eb;
        }
        
        .sidebar .logo {
            font-size: 24px;
            margin-bottom: 24px;
        }

        .sidebar .nav-logo-container.nav-logo-small {
            margin-bottom: 24px;
        }
        
        .sidebar .nav-icon {
            width: 100%;
            padding: 10px 0;
            display: flex;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: background .2s, color .2s;
        }
        
        .sidebar .nav-icon.active {
            background: #e2e8f0;
            color: var(--timesync-primary);
        }
        
        .sidebar .nav-icon:hover {
            background: #f1f5f9;
        }
        
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            background: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header .title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .header .status {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .header .status span {
            font-size: 18px;
        }
        
        .content {
            flex: 1;
            display: none;
            overflow: auto;
        }
        
        .content.active {
            display: block;
        }
        
        /* Navigation tabs */
        .tabs {
            display: flex;
            gap: 0;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 16px;
        }
        
        .tabs button {
            appearance: none;
            background: none;
            border: none;
            padding: 12px 20px;
            font-size: 13px;
            cursor: pointer;
            color: #6b7280;
            border-bottom: 2px solid transparent;
        }
        
        .tabs button.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            font-weight: 600;
        }
        
        .tabs button:hover {
            background: #f9fafb;
        }
        
        /* Cards and metrics */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .card {
            background: var(--card);
            border-radius: var(--card-radius);
            box-shadow: 0 var(--card-shadow-y) calc(var(--card-shadow-y) * 2) rgba(0,0,0,0.1);
            padding: var(--card-padding);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border: 2px solid var(--module-border-color);
            color: var(--text);
        }

        .card:hover {
            box-shadow: 0 calc(var(--card-shadow-y) * 2) calc(var(--card-shadow-y) * 4) rgba(0,0,0,0.15);
        }
        
        .card h3 {
            margin: 0 0 4px;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
        }
        
        .card .value {
            font-size: 28px;
            font-weight: 700;
            color: #111827;
        }
        
        .card .subtext {
            font-size: 11px;
            color: #6b7280;
        }

        #settings .card {
            display: block;
        }
        
        /* Tables */
        .table-container {
            background: var(--card);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-bottom: 24px;
            border: 1px solid var(--border);
            color: var(--text);
        }
        
        .table-container .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            color: var(--text);
            font-size: 13px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        thead tr {
            background: #f9fafb;
        }
        
        th, td {
            padding: 8px 12px;
            text-align: left;
        }
        
        th {
            font-size: 11px;
            color: #6b7280;
            text-transform: uppercase;
            border-bottom: 1px solid #e5e7eb;
        }
        
        tbody tr:hover {
            background: #f3f4f6;
        }
        
        .empty {
            text-align: center;
            padding: 40px 0;
            color: #9ca3af;
        }
        
        /* Forms & inputs */
        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 16px;
        }
        
        .form-group label {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #374151;
        }
        
        .form-group .required {
            color: #ef4444;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 13px;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
        }
        
        /* Buttons */
        .btn {
            appearance: none;
            border: 1px solid #d1d5db;
            border-radius: var(--button-radius);
            padding: 6px 16px;
            font-size: 13px;
            cursor: pointer;
            background: white;
            transition: background .2s;
        }
        
        .btn:hover {
            background: #f9fafb;
        }
        
        .btn.primary {
            background: linear-gradient(135deg, var(--button-gradient-start), var(--button-gradient-end));
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-weight: 600;
            border-radius: var(--button-radius);
        }
        
        .btn.primary:hover {
            background: linear-gradient(135deg,
                color-mix(in srgb, var(--button-gradient-start) 90%, black 10%),
                color-mix(in srgb, var(--button-gradient-end) 90%, black 10%));
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(74, 144, 226, 0.4);
        }
        
        .btn.danger {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }
        
        .btn.danger:hover {
            background: #dc2626;
        }
        
        .btn.small {
            padding: 4px 8px;
            font-size: 11px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-dialog {
            background: var(--modal-bg);
            color: var(--modal-text);
            border-radius: var(--modal-radius);
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 2px solid var(--modal-border-color);
        }
        
        .modal-header,
        .modal-footer {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-footer {
            border-top: 1px solid #e5e7eb;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--modal-text);
        }
        
        .modal-body {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }
        
        .close-btn {
            appearance: none;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }
        
        .close-btn:hover {
            color: #374151;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            border-radius: 6px;
            color: white;
            display: flex;
            gap: 8px;
            z-index: 1050;
            animation: fadein .3s;
        }
        
        .notification.success {background: #10b981;}
        .notification.error {background: #ef4444;}
        .notification.info {background: #3b82f6;}
        .notification.warning {background: #f59e0b;}
        
        @keyframes fadein {
            from {opacity: 0; transform: translateX(100px);} 
            to {opacity: 1; transform: translateX(0);}
        }

        /* Logo and premium header styles */
        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .nav-logo-container {
            width: 54px;
            height: 54px;
            border-radius: 14px;
            padding: 2px;
            background: linear-gradient(45deg,
                #ff6b6b, #4ecdc4, #45b7d1, #96ceb4,
                #feca57, #ff9ff3, #54a0ff, #5f27cd,
                #00d2d3, #ff9f43, #10ac84, #ee5a6f);
            background-size: 400% 400%;
            animation: gradientShift 4s ease-in-out infinite;
            display: inline-flex;
            justify-content: center;
            align-items: center;
        }

        .nav-logo-container.nav-logo-small {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            padding: 2px;
        }

        .nav-logo-container.nav-logo-small .nav-logo {
            width: 38px;
            height: 38px;
            border-radius: 8px;
        }
        
        .nav-logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .nav-logo::after {
            content: '‚óâ';
            font-size: 24px;
            color: white;
            animation: winkEye 4s ease-in-out infinite;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            25% { background-position: 100% 50%; }
            50% { background-position: 100% 100%; }
            75% { background-position: 0% 100%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes winkEye {
            0%, 85% { transform: scaleY(1); }
            88% { transform: scaleY(0.1); }
            92% { transform: scaleY(1); }
            94% { transform: scaleY(0.1); }
            97% { transform: scaleY(1); }
            100% { transform: scaleY(1); }
        }
        
        .brand-group {
            display: flex;
            flex-direction: column;
            margin-left: 12px;
        }
        
        .brand-text {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--brand-primary);
        }

        .company-name {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--muted);
            margin-top: 2px;
        }
        
        .module-name {
            font-weight: 400;
            background: var(--timesync-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header {
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .status {
            color: var(--muted);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Background system */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: -2;
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 20%, rgba(74, 144, 226, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(53, 122, 189, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 20% 80%, rgba(74, 144, 226, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(53, 122, 189, 0.1) 0%, transparent 50%);
            z-index: -1;
        }

        #dashboard .card {
            background: #ffffff;
            color: #374151;
        }
        
        #dashboard .card:hover {
            background: #f9fafb;
        }

        #staff .modal-dialog,
        #staffManagement .modal-dialog {
            border-width: 2px;
            border-style: solid;
            border-color: var(--modal-border-color);
        }

        /* Schedule modules */
        .schedule-modules {
            display: flex;
            flex-wrap: nowrap;
            justify-content: center;
            gap: 16px;
            margin-bottom: 16px;
            overflow-x: auto;
            margin-left: 0;
            margin-right: 0;
        }
        
        .schedule-modules > .card {
            flex: 1 0 240px;
        }
        
        .search-card {
            border: 2px solid var(--accent);
            background: transparent;
            color: var(--text);
        }
        
        .search-card h3 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
        }
        
        .search-card input {
            border: 1px solid #d1d5db;
            background: #ffffff;
            color: #374151;
            width: 100%;
            padding: 6px 8px;
            border-radius: 4px;
        }
        
        .search-card input::placeholder {
            color: #9ca3af;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 11px;
            color: #374151;
        }
        
        .calendar-header button {
            width: 22px;
            height: 22px;
            border: 1px solid #e5e7eb;
            background: #ffffff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .calendar-header button:hover {
            background: #f9fafb;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e5e7eb;
            padding: 1px;
            border-radius: 4px;
        }
        
        .calendar-grid .day-header {
            font-size: 8px;
            font-weight: 600;
            color: #9ca3af;
            text-align: center;
            padding: 2px 0;
            background: #ffffff;
        }
        
        .calendar-grid .day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #374151;
            background: #ffffff;
            cursor: pointer;
            position: relative;
        }
        
        .calendar-grid .day:hover {
            background: #f3f4f6;
        }
        
        .calendar-grid .other-month {
            color: #d1d5db;
            background: #fafafa;
        }
        
        .calendar-grid .today {
            background: #3b82f6;
            color: #ffffff;
            font-weight: 600;
        }
        
        .calendar-grid .selected {
            border: 2px solid #3b82f6;
            box-sizing: border-box;
        }
        
        .calendar-grid .has-jobs::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 3px;
            height: 3px;
            background: #ef4444;
            border-radius: 50%;
        }
        
        .stats-list div,
        .positions-list div,
        .specialties-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            font-size: 11px;
            color: #374151;
        }
        
        .stats-list span,
        .positions-list span,
        .specialties-list span {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .specialties-list {
            list-style: none;
            padding-left: 0;
            margin-top: 4px;
        }
        
        .specialties-list li {
            font-size: 11px;
            color: #374151;
        }
        
        .row-actions-card h3 {
            margin-top: 0;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }
        
        .row-actions-card button {
            display: block;
            width: 100%;
            margin-bottom: 6px;
            font-size: 11px;
        }
        
        .row-actions-card .log-entry {
            font-size: 10px;
            color: #6b7280;
            margin-bottom: 2px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #d1d5db;
            transition: .4s;
            border-radius: 20px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: #ffffff;
            transition: .4s;
            border-radius: 50%;
        }
        
        .switch input:checked + .slider {
            background-color: #3b82f6;
        }
        
        .switch input:checked + .slider:before {
            transform: translateX(14px);
        }

        .stats-card .stats-list span {
            font-size: 16px;
            font-weight: 700;
        }

        .cert-status-critical {
            background: #fee2e2;
        }
        
        .cert-status-warning {
            background: #fef3c7;
        }
        
        .cert-status-ok {
            background: #ecfdf5;
        }

        /* Column Manager - Drag & Drop */
        .column-row {
            cursor: move;
            transition: background 0.2s;
        }
        
        .column-row:hover {
            background: #f9fafb;
        }
        
        .column-row.dragging {
            opacity: 0.5;
        }
        
        .column-row.drag-over {
            border-top: 2px solid #3b82f6;
        }

        /* View mode buttons */
        .search-view button.active {
            background: #3b82f6;
            color: white;
        }

        /* Skills Matrix Styles */
        .skills-matrix-container {
            overflow-x: auto;
            margin-top: 16px;
        }
        
        .skills-matrix-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }
        
        .skills-matrix-table th {
            background: #f9fafb;
            padding: 8px 6px;
            border: 1px solid #e5e7eb;
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            font-size: 10px;
        }
        
        .skills-matrix-table td {
            padding: 4px 6px;
            border: 1px solid #e5e7eb;
            text-align: center;
        }
        
        .skill-level-indicator {
            display: inline-block;
            width: 100%;
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .skill-level-basic {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .skill-level-intermediate {
            background: #fef3c7;
            color: #92400e;
        }
        
        .skill-level-advanced {
            background: #d1fae5;
            color: #065f46;
        }
        
        .skill-level-expert {
            background: #e9d5ff;
            color: #6b21a8;
        }
        
        .skill-certified {
            display: inline-block;
            color: #10b981;
            font-size: 12px;
        }
        
        .skill-not-certified {
            color: #d1d5db;
        }
    </style>
</head>
<body>
<div id="app" class="app">
    <!-- Sidebar navigation -->
    <div class="sidebar">
        <div class="nav-icon active" data-page="dashboard" title="Dashboard" onclick="switchPage('dashboard')">üìä</div>
        <div class="nav-icon" data-page="schedule" title="Schedule" onclick="switchPage('schedule')">üìÖ</div>
        <div class="nav-icon" data-page="staff" title="Staff" onclick="switchPage('staff')">üë•</div>
        <div class="nav-icon" data-page="reports" title="Reports" onclick="switchPage('reports')">üìà</div>
        <div class="nav-icon" data-page="users" title="Users" onclick="switchPage('users')">üë§</div>
        <div class="nav-icon" data-page="settings" title="Settings" onclick="switchPage('settings')">‚öôÔ∏è</div>
    </div>
    
    <!-- Main content -->
    <div class="main">
        <header class="header">
            <div class="header-left">
                <a href="#" onclick="switchPage('dashboard')" title="Dashboard" class="header-logo">
                    <div class="nav-logo-container">
                        <div class="nav-logo"></div>
                    </div>
                </a>
                <div class="brand-group">
                    <span class="brand-text">Opsis <span class="module-name">TimeSync</span></span>
                    <span id="companyNameDisplay" class="company-name">CVE San Diego</span>
                </div>
            </div>
            <div class="status" id="connectionIndicator">üîä Disconnected</div>
        </header>
        
        <!-- Dashboard Page -->
        <div id="dashboard" class="content active">
            <div class="page-body" style="padding: 24px;">
                <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">Dashboard Overview</h2>
                <div class="metrics-grid">
                    <div class="card">
                        <h3>Total Jobs</h3>
                        <div class="value" id="dashTotalJobs">0</div>
                        <div class="subtext">Active jobs</div>
                    </div>
                    <div class="card">
                        <h3>Active Crew</h3>
                        <div class="value" id="dashActiveCrew">0/0</div>
                        <div class="subtext">Staff utilization</div>
                    </div>
                    <div class="card">
                        <h3>Pending Jobs</h3>
                        <div class="value" id="dashPendingJobs">0</div>
                        <div class="subtext">Awaiting assignment</div>
                    </div>
                    <div class="card">
                        <h3>Efficiency</h3>
                        <div class="value" id="dashEfficiency">0%</div>
                        <div class="subtext">Completion rate</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Schedule Page -->
        <div id="schedule" class="content">
            <div class="page-body" style="padding: 24px; display: flex; flex-direction: column; height: 100%;">
                <div class="tabs">
                    <button class="tab-btn active" data-subtab="jobs" onclick="switchSubtab('schedule','jobs')">Schedule</button>
                    <button class="tab-btn" data-subtab="columns" onclick="switchSubtab('schedule','columns')">Column Manager</button>
                    <button class="tab-btn" data-subtab="filters" onclick="switchSubtab('schedule','filters')">Filters</button>
                </div>
                
                <!-- Subtab: Jobs -->
                <div id="jobs" class="subtab-content" style="flex:1; display: flex; flex-direction: column;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div>
                            <button class="btn primary" id="btnAddJob" onclick="openAddJobModal()">‚ûï Add Job</button>
                            <button class="btn" id="btnAdvancedFilters" onclick="openScheduleFilters()">üîç Filters</button>
                            <button class="btn" id="btnRefresh" onclick="refreshPage()">‚Üª Refresh</button>
                            <button class="btn" id="btnExport" onclick="exportSchedule()">üì• Export CSV</button>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label for="yearSelect">Year:</label>
                            <select id="yearSelect" class="form-control" style="padding:4px 8px;">
                                <option value="2025" selected>2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                            </select>
                            <label for="monthSelect">Month:</label>
                            <select id="monthSelect" class="form-control" style="padding:4px 8px;">
                                <option value="january">January</option>
                                <option value="february">February</option>
                                <option value="march">March</option>
                                <option value="april">April</option>
                                <option value="may">May</option>
                                <option value="june">June</option>
                                <option value="july">July</option>
                                <option value="august">August</option>
                                <option value="september" selected>September</option>
                                <option value="october">October</option>
                                <option value="november">November</option>
                                <option value="december">December</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="schedule-modules">
                        <div class="card search-card">
                            <div class="search-top">
                                <h3>Search Jobs</h3>
                                <input type="text" id="searchJobs" placeholder="Job #, Address, Supervisor...">
                            </div>
                            <div class="search-view" style="margin-top: 8px; display:flex; gap:4px;">
                                <button class="btn small" id="viewSimple">Simple</button>
                                <button class="btn small" id="viewExtended">Extended</button>
                                <button class="btn small active" id="viewComplete">Complete</button>
                            </div>
                        </div>
                        
                        <div class="card calendar-card">
                            <div class="calendar-header">
                                <button id="prevMonth">‚óÄ</button>
                                <span id="calendarMonth">September 2025</span>
                                <button id="nextMonth">‚ñ∂</button>
                            </div>
                            <div id="miniCalendar" class="calendar-grid"></div>
                            <div style="margin-top: 6px; font-size: 10px; color:#6b7280; text-align: center;">Select a date</div>
                        </div>
                        
                        <div class="card stats-card">
                            <h3>Statistics</h3>
                            <div class="stats-list">
                                <div>Supervisors Available: <span id="statSupAvail">0/0</span></div>
                                <div>Workers Available: <span id="statCrewAvail">0/0</span></div>
                                <div>Jobs (Day/Week): <span id="statToday">0</span>/<span id="statWeek">0</span></div>
                            </div>
                        </div>
                        
                        <div class="card status-card">
                            <h3>Status Counts</h3>
                            <ul class="specialties-list" style="margin-top:4px;">
                                <li>Job: <span id="countJOB">0 (0)</span></li>
                                <li>Repair: <span id="countREPAIR">0 (0)</span></li>
                                <li>Teardown: <span id="countTEARDOWN">0 (0)</span></li>
                                <li>Pick Up EQ: <span id="countPICK_UP_EQ">0 (0)</span></li>
                                <li>Class: <span id="countCLASS">0 (0)</span></li>
                                <li>Medical: <span id="countMEDICAL">0 (0)</span></li>
                                <li>Vacation: <span id="countVACATION">0 (0)</span></li>
                                <li>Go Back: <span id="countGO_BACK">0 (0)</span></li>
                                <li>Light Duty: <span id="countLIGHT_DUTY">0 (0)</span></li>
                            </ul>
                        </div>
                        
                        <div class="card positions-card">
                            <h3>Positions</h3>
                            <div class="positions-list">
                                <div>Regular: <span id="countREGULAR">0 (0)</span></div>
                                <div>State: <span id="countSTATE">0 (0)</span></div>
                                <div>Federal: <span id="countFEDERAL">0 (0)</span></div>
                            </div>
                        </div>
                        
                        <div class="card specialties-card" id="specialtiesSup">
                            <h3>Supervisors Specialties</h3>
                            <ul class="specialties-list">
                                <li>Asbestos: <span id="supAsbestosCount">0/0</span></li>
                                <li>Lead: <span id="supLeadCount">0/0</span></li>
                                <li>Mold: <span id="supMoldCount">0/0</span></li>
                                <li>Bio Haz: <span id="supBioCount">0/0</span></li>
                                <li>Bacteria: <span id="supBacteriaCount">0/0</span></li>
                                <li>Contents: <span id="supContentsCount">0/0</span></li>
                                <li>Duct Cleaning: <span id="supDuctCount">0/0</span></li>
                                <li>Drivers: <span id="supDriversCount">0/0</span></li>
                            </ul>
                        </div>
                        
                        <div class="card specialties-card" id="specialtiesCrew">
                            <h3>Crew Specialties</h3>
                            <ul class="specialties-list">
                                <li>Asbestos: <span id="crewAsbestosCount">0/0</span></li>
                                <li>Lead: <span id="crewLeadCount">0/0</span></li>
                                <li>Mold: <span id="crewMoldCount">0/0</span></li>
                                <li>Bio Haz: <span id="crewBioCount">0/0</span></li>
                                <li>Bacteria: <span id="crewBacteriaCount">0/0</span></li>
                                <li>Contents: <span id="crewContentsCount">0/0</span></li>
                                <li>Duct Cleaning: <span id="crewDuctCount">0/0</span></li>
                                <li>Drivers: <span id="crewDriversCount">0/0</span></li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="data-wrapper" style="display:flex; gap:16px; align-items:flex-start;">
                        <div class="table-container" style="flex:1; display:flex; flex-direction:column;">
                            <div class="table-header">
                                <span id="jobsTitle">September 2025 Jobs</span>
                                <span style="font-size: 11px; color: #6b7280;">
                                    <span id="jobCount">0</span> record(s)
                                </span>
                            </div>
                            <div style="flex:1; overflow:auto;">
                                <table id="jobsTable">
                                    <thead><tr id="jobsTableHead"><th>Date</th><th>Job Number</th><th>Status</th></tr></thead>
                                    <tbody id="jobsTableBody"><tr><td colspan="31" class="empty">No jobs found</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="rowActionsCard" class="card row-actions-card" style="width:240px;">
                            <h3>Row Actions</h3>
                            <div id="selectedJobInfo" style="font-size:11px; color:#6b7280; margin-bottom:8px;">Select a row</div>
                            <button class="btn small primary" id="btnEditRow" disabled>Edit</button>
                            <button class="btn small" id="btnDuplicateRow" disabled>Duplicate</button>
                            <button class="btn small danger" id="btnDeleteRow" disabled>Delete</button>
                            <div style="font-size: 10px; color:#374151; margin-top:8px;">Log</div>
                            <div id="operationsLog" style="max-height:120px; overflow:auto; font-size:10px; color:#6b7280;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Subtab: Column Manager -->
                <div id="columns" class="subtab-content" style="display: none; overflow:auto;">
                    <div class="table-container" style="margin-bottom: 24px;">
                        <div class="table-header">Column Manager</div>
                        <div style="padding:16px; background:white;">
                            <div style="margin-bottom:12px; font-size:12px; color:#374151;">
                                Configure visibility, widths, and options for each column. Changes are stored locally. Drag rows to reorder columns.
                            </div>
                            <div style="margin-bottom: 8px;">
                                <button class="btn" id="btnAddColumn">‚ûï Add Column</button>
                                <button class="btn" id="btnSaveColumns">üíæ Save All</button>
                            </div>
                            <table style="width:100%; border-collapse:collapse; font-size:11px;">
                                <thead>
                                    <tr style="background:#f9fafb;">
                                        <th>#</th>
                                        <th>Visible</th>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Required</th>
                                        <th>Width</th>
                                        <th>Options</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="columnsTableBody">
                                    <tr><td colspan="8" class="empty">Loading columns...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Subtab: Filters -->
                <div id="filters" class="subtab-content" style="display: none; overflow:auto;">
                    <div class="card" style="margin-bottom: 24px;">
                        <h3 style="font-size: 16px; font-weight:600; margin-bottom:16px;">Advanced Filters</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Date From</label>
                                <input type="date" id="filterDateFrom" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Date To</label>
                                <input type="date" id="filterDateTo" class="form-control">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Job Number</label>
                                <input type="text" id="filterJobNumber" class="form-control" placeholder="Job #">
                            </div>
                            <div class="form-group">
                                <label>PM / Estimator</label>
                                <select id="filterPM" class="form-control">
                                    <option value="">All</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top: 16px;">
                            <button class="btn primary" id="btnApplyFilters">Apply Filters</button>
                            <button class="btn" id="btnClearFilters">Clear</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Staff Page -->
        <div id="staff" class="content">
            <div class="page-body" style="padding: 24px; display:flex; flex-direction:column; height: 100%;">
                <div class="tabs">
                    <button class="tab-btn active" data-stafftab="overview" onclick="switchSubtab('staff','overview')">Overview</button>
                    <button class="tab-btn" data-stafftab="supervisors" onclick="switchSubtab('staff','supervisors')">Supervisors</button>
                    <button class="tab-btn" data-stafftab="crew" onclick="switchSubtab('staff','crew')">Crew Members</button>
                    <button class="tab-btn" data-stafftab="skills" onclick="switchSubtab('staff','skills')">Skills Matrix</button>
                    <button class="tab-btn" data-stafftab="certifications" onclick="switchSubtab('staff','certifications')">Certifications</button>
                </div>
                
                <div id="overview" class="staff-content" style="flex:1; overflow:auto;">
                    <h2 style="font-size: 18px; font-weight: 600; margin-bottom:16px;">Staff Overview</h2>
                    <div style="display:grid; grid-template-columns: repeat(6, 1fr); gap: 16px; margin-bottom:24px;">
                        <div class="card" style="border-left:4px solid #3b82f6;">
                            <div style="font-size: 11px; color:#6b7280; text-transform:uppercase; margin-bottom:4px;">Total Staff</div>
                            <div style="font-size: 28px; font-weight:700;" id="overviewTotal">0</div>
                        </div>
                        <div class="card" style="border-left:4px solid #10b981;">
                            <div style="font-size: 11px; color:#6b7280; text-transform:uppercase; margin-bottom:4px;">Available</div>
                            <div style="font-size: 28px; font-weight:700;" id="overviewAvailable">0</div>
                        </div>
                        <div class="card" style="border-left:4px solid #8b5cf6;">
                            <div style="font-size: 11px; color:#6b7280; text-transform:uppercase; margin-bottom:4px;">Supervisors</div>
                            <div style="font-size: 28px; font-weight:700;" id="overviewSupervisors">0</div>
                        </div>
                        <div class="card" style="border-left:4px solid #f59e0b;">
                            <div style="font-size: 11px; color:#6b7280; text-transform:uppercase; margin-bottom:4px;">Crew Members</div>
                            <div style="font-size: 28px; font-weight:700;" id="overviewCrew">0</div>
                        </div>
                        <div class="card" style="border-left:4px solid #06b6d4;">
                            <div style="font-size: 11px; color:#6b7280; text-transform:uppercase; margin-bottom:4px;">Certified</div>
                            <div style="font-size: 28px; font-weight:700;" id="overviewCertified">0</div>
                        </div>
                        <div class="card" style="border-left:4px solid #d97706;">
                            <div style="font-size: 11px; color:#6b7280; text-transform:uppercase; margin-bottom:4px;">Certificates (Active / Expiring)</div>
                            <div style="font-size: 22px; font-weight:700; display:flex; gap:4px;"><span id="overviewCertActive">0</span> / <span id="overviewCertExpiring">0</span></div>
                        </div>
                    </div>
                </div>
                
                <div id="supervisors" class="staff-content" style="display:none; flex:1; overflow:auto;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <h2 style="font-size:18px; font-weight:600;">Supervisors</h2>
                        <button class="btn primary" id="btnAddSupervisor">‚ûï Add Supervisor</button>
                    </div>
                    <div class="table-container" style="flex:1;">
                        <div class="table-header">Supervisors List</div>
                        <div style="height:100%; overflow:auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Employee #</th>
                                        <th>Full Name</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Division</th>
                                        <th>Specialties</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="supervisorsTable">
                                    <tr><td colspan="7" class="empty">No supervisors found</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div id="crew" class="staff-content" style="display:none; flex:1; overflow:auto;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <h2 style="font-size:18px; font-weight:600;">Crew Members</h2>
                        <button class="btn primary" id="btnAddCrew">‚ûï Add Crew</button>
                    </div>
                    <div class="table-container" style="flex:1;">
                        <div class="table-header">Crew List</div>
                        <div style="height:100%; overflow:auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Employee #</th>
                                        <th>Full Name</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Division</th>
                                        <th>Specialties</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="crewTable">
                                    <tr><td colspan="7" class="empty">No crew members found</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div id="skills" class="staff-content" style="display:none; flex:1; overflow:auto;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <h2 style="font-size:18px; font-weight:600;">Skills Matrix</h2>
                        <button class="btn primary" id="btnAddSkill">‚ûï Add Skill</button>
                    </div>
                    <div id="skillsMatrixBody" class="skills-matrix-container">
                        <div class="empty">Loading skills matrix...</div>
                    </div>
                </div>
                
                <div id="certifications" class="staff-content" style="display:none; flex:1; overflow:auto;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <h2 style="font-size:18px; font-weight:600;">Certifications</h2>
                        <button class="btn primary" id="btnAddCertification">‚ûï Add Certification</button>
                    </div>
                    <div id="certMetrics" style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px;"></div>
                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                        <label for="certFilterType" style="font-size:12px;">Filter by type:</label>
                        <select id="certFilterType" class="form-control" style="flex:0 0 200px;"><option value="">All Types</option></select>
                    </div>
                    <div class="table-container" style="flex:1;">
                        <div class="table-header">Certifications</div>
                        <div style="height:100%; overflow:auto;" id="certificationsTableBody">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Reports Page -->
        <div id="reports" class="content">
            <div style="padding: 24px;">
                <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">Reports Dashboard</h2>
                <div class="empty" style="padding: 60px; text-align: center;">
                    Reports feature coming soon
                </div>
            </div>
        </div>
        
        <!-- Users Page -->
        <div id="users" class="content">
            <div class="page-body" style="padding:24px;">
                <h2 style="font-size:20px; font-weight:600; margin-bottom:16px;">User Management</h2>
                <div class="card" style="margin-bottom:16px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 style="font-size:16px; font-weight:600;">Users</h3>
                        <button type="button" class="btn primary" id="btnAddUser">‚ûï Add User</button>
                    </div>
                    <div id="usersTableContainer" style="margin-top:16px; overflow-x:auto;"></div>
                </div>
            </div>
        </div>
        
        <!-- Settings Page -->
        <div id="settings" class="content">
            <div class="page-body" style="padding: 24px;">
                <div class="tabs">
                    <button class="tab-btn active" data-settingstab="general">General</button>
                    <button class="tab-btn" data-settingstab="api">API</button>
                    <button class="tab-btn" data-settingstab="appearance">Appearance</button>
                </div>
                
                <div id="general" class="settings-content" style="margin-top:12px;">
                    <div class="card" style="max-width:400px; margin-bottom:16px;">
                        <h3 style="font-size: 16px; font-weight:600; margin-bottom:16px;">General Settings</h3>
                        <div class="form-group">
                            <label>Company Name</label>
                            <input type="text" id="companyName" class="form-control" value="CVE San Diego">
                        </div>
                    </div>
                </div>
                
                <div id="api" class="settings-content" style="display:none; margin-top:12px;">
                    <div class="card" style="max-width:500px; margin-bottom:16px;">
                        <h3 style="font-size:16px; font-weight:600; margin-bottom:16px;">API Configuration</h3>
                        <p style="font-size:12px; color:#6b7280; margin-bottom:12px;">
                            This system uses Supabase. Configure your credentials in <code>config.js</code>.
                        </p>
                        <div class="form-group">
                            <label>Supabase Project URL</label>
                            <input type="text" class="form-control" placeholder="https://xxxxx.supabase.co" readonly style="background:#f3f4f6;">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <div id="apiStatus" style="padding:8px; border-radius:4px; background:#ecfdf5; color:#065f46; font-size:12px;">
                                Check browser console for connection status
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="appearance" class="settings-content" style="display:none; margin-top:12px;">
                    <div class="card" style="max-width:600px; margin-bottom:16px;">
                        <h3 style="font-size:16px; font-weight:600; margin-bottom:16px;">Appearance & Theme</h3>
                        <div class="form-group">
                            <label>Theme Mode</label>
                            <select id="themeSelect" class="form-control">
                                <option value="light">Light</option>
                                <option value="dark">Dark</option>
                            </select>
                        </div>
                        <p style="margin-top:12px; font-size:0.85rem; color: var(--muted);">
                            Modal and module borders automatically use the logo's colours. In light mode, backgrounds are light with dark text; in dark mode, backgrounds are dark with light text.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Add Job Modal -->
<div class="modal" id="modalAddJob">
    <div class="modal-dialog">
        <div class="modal-header">
            <h2 class="modal-title">Add New Job</h2>
            <button class="close-btn" onclick="closeModal('modalAddJob')">√ó</button>
        </div>
        <div class="modal-body">
            <div style="display:flex; gap:0; border-bottom:1px solid #e5e7eb;">
                <button class="btn small" data-jobtab="basic" style="flex:1; border:none; background:none; border-bottom:2px solid #3b82f6; color:#3b82f6;">Basic</button>
                <button class="btn small" data-jobtab="scheduleTab" style="flex:1; border:none; background:none;">Schedule</button>
                <button class="btn small" data-jobtab="teamTab" style="flex:1; border:none; background:none;">Team</button>
                <button class="btn small" data-jobtab="complianceTab" style="flex:1; border:none; background:none;">Compliance</button>
                <button class="btn small" data-jobtab="notesTab" style="flex:1; border:none; background:none;">Notes</button>
            </div>
            <form id="formAddJob">
                <div class="jobtab" id="basic" style="padding-top:16px;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Job Number <span class="required">*</span></label>
                            <input type="text" name="job_number" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select name="status" class="form-control">
                                <option>JOB</option>
                                <option>REPAIR</option>
                                <option>TEARDOWN</option>
                                <option>PICK UP EQ</option>
                                <option>TD & EQ</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Job Address <span class="required">*</span></label>
                        <input type="text" name="job_address" class="form-control" required>
                    </div>
                </div>
                <div class="jobtab" id="scheduleTab" style="display:none; padding-top:16px;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date <span class="required">*</span></label>
                            <input type="date" name="date" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Time</label>
                            <select name="time" class="form-control">
                                <option>8 HRS</option>
                                <option>6 HRS</option>
                                <option>1/2 AM</option>
                                <option>1/2 PM</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Progress</label>
                            <select name="progress" class="form-control">
                                <option>NEW</option>
                                <option>0%</option>
                                <option>25%</option>
                                <option>50%</option>
                                <option>75%</option>
                                <option>100%</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Location</label>
                            <select name="location" class="form-control">
                                <option>LOCAL</option>
                                <option>OUT OF TOWN</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="jobtab" id="teamTab" style="display:none; padding-top:16px;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Project Manager</label>
                            <select name="pm" class="form-control">
                                <option value="">Select PM</option>
                                <option>BC</option>
                                <option>BS</option>
                                <option>JC</option>
                                <option>MD</option>
                                <option>RC</option>
                                <option>SP</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Position</label>
                            <select name="position" class="form-control">
                                <option>REGULAR</option>
                                <option>STATE</option>
                                <option>FEDERAL</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Supervisor</label>
                        <input type="text" name="supervisor" class="form-control" placeholder="Select from staff list">
                    </div>
                    <div class="form-group">
                        <label>Crew Members</label>
                        <input type="text" name="crew" class="form-control" placeholder="Select from staff list">
                    </div>
                </div>
                <div class="jobtab" id="complianceTab" style="display:none; padding-top:16px;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>OSHA</label>
                            <select name="osha" class="form-control">
                                <option>Yes</option>
                                <option>No</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Manifest</label>
                            <select name="manifest" class="form-control">
                                <option>No</option>
                                <option>Haz Manifest</option>
                                <option>Non-Haz Manifest</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Notified</label>
                            <select name="notified" class="form-control">
                                <option>Yes</option>
                                <option>No</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Scheduled</label>
                            <select name="scheduled" class="form-control">
                                <option>Yes</option>
                                <option>No</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="jobtab" id="notesTab" style="display:none; padding-top:16px;">
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea name="notes" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Manifest Notes</label>
                        <textarea name="manifest_notes" class="form-control" rows="3"></textarea>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeModal('modalAddJob')">Cancel</button>
            <button class="btn primary" id="btnSaveJob">Save</button>
        </div>
    </div>
</div>

<!-- Add Supervisor Modal -->
<div class="modal" id="modalAddSupervisor">
    <div class="modal-dialog" style="max-width:600px;">
        <div class="modal-header">
            <h2 class="modal-title">Add Supervisor</h2>
            <button class="close-btn" onclick="closeModal('modalAddSupervisor')">√ó</button>
        </div>
        <div class="modal-body">
            <form id="formAddSupervisor">
                <div class="form-row">
                    <div class="form-group">
                        <label>Employee # <span class="required">*</span></label>
                        <input type="text" name="employeeNumber" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select name="status" class="form-control">
                            <option value="AVAILABLE">Available</option>
                            <option value="ASSIGNED">Assigned</option>
                            <option value="OFF">Off</option>
                            <option value="VACATION">Vacation</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Full Name <span class="required">*</span></label>
                    <input type="text" name="fullName" class="form-control" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Role</label>
                        <input type="text" name="role" class="form-control" value="SUPERVISOR" readonly style="background:#f3f4f6;">
                    </div>
                    <div class="form-group">
                        <label>Division</label>
                        <select name="division" class="form-control">
                            <option value="ASBESTOS">Asbestos</option>
                            <option value="LEAD">Lead Paint</option>
                            <option value="MOLD">Mold</option>
                            <option value="BIO_HAZARD">Bio Hazard</option>
                            <option value="BACTERIA">Bacteria</option>
                            <option value="GENERAL">General</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Specialties (Ctrl/Cmd to select)</label>
                    <select name="specialties" class="form-control" multiple style="height:100px;">
                        <option value="Asbestos">Asbestos</option>
                        <option value="Lead Paint">Lead Paint</option>
                        <option value="Mold">Mold</option>
                        <option value="Bio Hazard">Bio Hazard</option>
                        <option value="Bacteria">Bacteria</option>
                        <option value="Contents">Contents</option>
                        <option value="Duct Cleaning">Duct Cleaning</option>
                        <option value="Driver">Driver</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeModal('modalAddSupervisor')">Cancel</button>
            <button class="btn primary" id="btnSaveSupervisor">Save</button>
        </div>
    </div>
</div>

<!-- Add Crew Modal -->
<div class="modal" id="modalAddCrew">
    <div class="modal-dialog" style="max-width:600px;">
        <div class="modal-header">
            <h2 class="modal-title">Add Crew Member</h2>
            <button class="close-btn" onclick="closeModal('modalAddCrew')">√ó</button>
        </div>
        <div class="modal-body">
            <form id="formAddCrew">
                <div class="form-row">
                    <div class="form-group">
                        <label>Employee # <span class="required">*</span></label>
                        <input type="text" name="employeeNumber" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select name="status" class="form-control">
                            <option value="AVAILABLE">Available</option>
                            <option value="ASSIGNED">Assigned</option>
                            <option value="OFF">Off</option>
                            <option value="VACATION">Vacation</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Full Name <span class="required">*</span></label>
                    <input type="text" name="fullName" class="form-control" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Role</label>
                        <input type="text" name="role" class="form-control" value="CREW" readonly style="background:#f3f4f6;">
                    </div>
                    <div class="form-group">
                        <label>Division</label>
                        <select name="division" class="form-control">
                            <option value="ASBESTOS">Asbestos</option>
                            <option value="LEAD">Lead Paint</option>
                            <option value="MOLD">Mold</option>
                            <option value="BIO_HAZARD">Bio Hazard</option>
                            <option value="BACTERIA">Bacteria</option>
                            <option value="GENERAL">General</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Specialties (Ctrl/Cmd to select)</label>
                    <select name="specialties" class="form-control" multiple style="height:100px;">
                        <option value="Asbestos">Asbestos</option>
                        <option value="Lead Paint">Lead Paint</option>
                        <option value="Mold">Mold</option>
                        <option value="Bio Hazard">Bio Hazard</option>
                        <option value="Bacteria">Bacteria</option>
                        <option value="Contents">Contents</option>
                        <option value="Duct Cleaning">Duct Cleaning</option>
                        <option value="Driver">Driver</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeModal('modalAddCrew')">Cancel</button>
            <button class="btn primary" id="btnSaveCrew">Save</button>
        </div>
    </div>
</div>

<!-- Add Skill Modal -->
<div class="modal" id="modalAddSkill">
    <div class="modal-dialog" style="max-width:500px;">
        <div class="modal-header">
            <h2 class="modal-title">Add New Skill</h2>
            <button class="close-btn" onclick="closeModal('modalAddSkill')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Skill Name <span class="required">*</span></label>
                <input type="text" id="newSkillName" class="form-control">
            </div>
            <div class="form-group">
                <label>Type</label>
                <select id="newSkillType" class="form-control">
                    <option value="certification">Certification</option>
                    <option value="specialty">Specialty</option>
                    <option value="evaluation">Evaluation</option>
                </select>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="newSkillDescription" class="form-control" rows="3"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeModal('modalAddSkill')">Cancel</button>
            <button class="btn primary" id="btnSaveSkill">Add</button>
        </div>
    </div>
</div>

<!-- Add Certification Modal -->
<div class="modal" id="modalAddCertification">
    <div class="modal-dialog" style="max-width:500px;">
        <div class="modal-header">
            <h2 class="modal-title">Add Certification</h2>
            <button class="close-btn" onclick="closeModal('modalAddCertification')">√ó</button>
        </div>
        <div class="modal-body">
            <form id="formAddCertification">
                <div class="form-group">
                    <label>Employee <span class="required">*</span></label>
                    <select name="employee" id="certificationEmployee" class="form-control" required>
                        <option value="">Select Employee</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Certification Type <span class="required">*</span></label>
                    <select name="certificationType" class="form-control" required>
                        <option value="">Select</option>
                        <option value="ASBESTOS_CERT">Asbestos Certification</option>
                        <option value="LEAD_CERT">Lead Paint Certification</option>
                        <option value="MOLD_CERT">Mold Certification</option>
                        <option value="OSHA_30">OSHA 30</option>
                        <option value="OSHA_40">OSHA 40</option>
                        <option value="FIRST_AID">First Aid</option>
                        <option value="CPR">CPR</option>
                        <option value="MEDICAL_EXAM">Medical Exam</option>
                        <option value="PHYSICAL_EXAM">Physical Exam</option>
                        <option value="COMPANY_TRAINING">Company Training</option>
                        <option value="OTHER">Other</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Issue Date <span class="required">*</span></label>
                        <input type="date" name="issueDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Expiry Date <span class="required">*</span></label>
                        <input type="date" name="expiryDate" class="form-control" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Certification Number</label>
                    <input type="text" name="certNumber" class="form-control">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea name="notes" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Attachment (PDF)</label>
                    <input type="file" id="certFile" accept=".pdf" class="form-control">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeModal('modalAddCertification')">Cancel</button>
            <button class="btn primary" id="btnSaveCertification">Save</button>
        </div>
    </div>
</div>

<!-- Edit Certification Modal -->
<div class="modal" id="modalEditCertification">
    <div class="modal-dialog" style="max-width:600px;">
        <div class="modal-header">
            <h2 class="modal-title">Certification Details</h2>
            <button class="close-btn" onclick="closeModal('modalEditCertification')">√ó</button>
        </div>
        <div class="modal-body">
            <form id="formEditCertification">
                <input type="hidden" name="certId">
                <div class="form-group">
                    <label>Employee</label>
                    <input type="text" name="employeeName" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label>Certification Type</label>
                    <input type="text" name="certificationType" class="form-control" readonly>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Issue Date</label>
                        <input type="date" name="issueDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Expiry Date</label>
                        <input type="date" name="expiryDate" class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label>Certification Number</label>
                    <input type="text" name="certNumber" class="form-control">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea name="notes" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Attachment (PDF)</label>
                    <div id="existingCertFile" style="margin-bottom:4px;"></div>
                    <input type="file" id="editCertFile" accept=".pdf" class="form-control">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeModal('modalEditCertification')">Cancel</button>
            <button class="btn primary" id="btnUpdateCertification">Update</button>
            <button class="btn danger" id="btnDeleteCertification">Delete</button>
        </div>
    </div>
</div>

<!-- Column Edit Modal -->
<div class="modal" id="modalEditColumn">
    <div class="modal-dialog" style="max-width:700px;">
        <div class="modal-header">
            <h2 class="modal-title">Edit Column</h2>
            <button class="close-btn" onclick="closeModal('modalEditColumn')">√ó</button>
        </div>
        <div class="modal-body">
            <form id="formEditColumn">
                <input type="hidden" id="editColumnId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Column Name <span class="required">*</span></label>
                        <input type="text" id="editColumnName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Type <span class="required">*</span></label>
                        <select id="editColumnType" class="form-control">
                            <option value="text">Text</option>
                            <option value="textarea">Text (Long)</option>
                            <option value="number">Number</option>
                            <option value="currency">Currency</option>
                            <option value="date">Date</option>
                            <option value="dropdown">Dropdown</option>
                            <option value="multiselect">Multiselect</option>
                            <option value="checkbox">Checkbox</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Width</label>
                        <input type="number" id="editColumnWidth" class="form-control" min="50" max="500" step="10" value="120">
                    </div>
                    <div class="form-group">
                        <label>Required</label>
                        <select id="editColumnRequired" class="form-control">
                            <option value="false">No</option>
                            <option value="true">Yes</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" id="editColumnOptionsContainer" style="display:none;">
                    <label>Dropdown Options (one per line)</label>
                    <textarea id="editColumnOptions" class="form-control" rows="4" placeholder="Option 1\nOption 2\nOption 3"></textarea>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="editColumnDescription" class="form-control" rows="2" placeholder="Optional description"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeModal('modalEditColumn')">Cancel</button>
            <button class="btn primary" id="btnSaveColumn">Save</button>
        </div>
    </div>
</div>

<!-- Add Column Modal -->
<div class="modal" id="modalAddColumn">
    <div class="modal-dialog" style="max-width:500px;">
        <div class="modal-header">
            <h2 class="modal-title">Add Column</h2>
            <button class="close-btn" onclick="closeModal('modalAddColumn')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Column Name <span class="required">*</span></label>
                <input type="text" id="addColumnName" class="form-control" placeholder="Name (use underscores)">
            </div>
            <div class="form-group">
                <label>Column Type <span class="required">*</span></label>
                <select id="addColumnType" class="form-control">
                    <option value="text">Text (Short)</option>
                    <option value="textarea">Text (Long)</option>
                    <option value="number">Number</option>
                    <option value="currency">Currency</option>
                    <option value="date">Date</option>
                    <option value="dropdown">Dropdown (Single Select)</option>
                    <option value="multiselect">Multi-Select</option>
                    <option value="checkbox">Checkbox</option>
                </select>
            </div>
            <div id="addColumnOptionsContainer" class="form-group" style="display:none;">
                <label>Options (one per line)</label>
                <textarea id="addColumnOptions" class="form-control" rows="4" placeholder="Option 1
Option 2
Option 3"></textarea>
            </div>
            <div class="form-group">
                <label>Width (px)</label>
                <input type="number" id="addColumnWidth" class="form-control" value="120" min="30">
            </div>
            <div class="form-group">
                <label>Required</label>
                <select id="addColumnRequired" class="form-control">
                    <option value="false">No</option>
                    <option value="true">Yes</option>
                </select>
            </div>
            <div class="form-group">
                <label>Visible</label>
                <select id="addColumnVisible" class="form-control">
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeModal('modalAddColumn')">Cancel</button>
            <button class="btn primary" id="btnSaveAddColumn">Save</button>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal" id="modalUser">
    <div class="modal-dialog" style="max-width:500px;">
        <div class="modal-header">
            <h2 class="modal-title">Add User</h2>
            <button class="close-btn" onclick="closeModal('modalUser')">√ó</button>
        </div>
        <div class="modal-body">
            <form id="formUser">
                <div class="form-group">
                    <label>Username <span class="required">*</span></label>
                    <input type="text" id="userUsername" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Email <span class="required">*</span></label>
                    <input type="email" id="userEmail" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Password <span class="required">*</span></label>
                    <input type="password" id="userPassword" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="userRole" class="form-control">
                        <option value="ADMIN">ADMIN</option>
                        <option value="MANAGER">MANAGER</option>
                        <option value="USER" selected>USER</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Active</label>
                    <select id="userActive" class="form-control">
                        <option value="true" selected>Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeModal('modalUser')">Cancel</button>
            <button class="btn primary" id="btnSaveUser">Save User</button>
        </div>
    </div>
</div>

<!-- Notifications container -->
<div id="notificationContainer"></div>

<script>
    // Global state
    let currentPage = 'dashboard';
    let currentSubtab = { schedule: 'jobs', staff: 'overview', settings: 'general' };
    let jobs = [];
    let operationLogs = [];
    let editingRowId = null;
    let editingRowIndex = null;
    let columns = [];
    let staffData = { supervisors: [], crew: [], skills: [], certs: [] };
    let viewMode = 'complete';
    let columnConfigLoaded = false;
    let certifications = [];
    let users = [];
    let selectedDate = null;
    let currentCalendarMonth = null;
    let selectedRowIndex = null;
    
    const STATUS_LIST = ['JOB','REPAIR','TEARDOWN','PICK UP EQ','CLASS','MEDICAL','VACATION','GO BACK','LIGHT DUTY'];
    const POSITION_LIST = ['REGULAR','STATE','FEDERAL'];
    const MONTH_NAMES = ['january','february','march','april','may','june','july','august','september','october','november','december'];
    
    const DEFAULT_SCHEMA = [
        {id:1,name:'date',type:'date',required:true,visible:true,width:'120px'},
        {id:2,name:'job_number',type:'text',required:true,visible:true,width:'120px'},
        {id:3,name:'time',type:'dropdown',visible:true,width:'100px',options:['8 HRS','6 HRS','1/2 AM','1/2 PM']},
        {id:4,name:'pm',type:'dropdown',visible:true,width:'80px',options:['BC','BS','JC','MD']},
        {id:5,name:'supervisor',type:'text',visible:true,width:'180px'},
        {id:6,name:'crew',type:'text',visible:true,width:'250px'},
        {id:7,name:'job_address',type:'textarea',required:true,visible:true,width:'300px'},
        {id:8,name:'status',type:'dropdown',visible:true,width:'120px',options:['JOB','REPAIR','TEARDOWN']},
        {id:9,name:'progress',type:'dropdown',visible:true,width:'100px',options:['NEW','RETURN','HOLD','0%','25%','50%','75%','100%']},
        {id:10,name:'position',type:'dropdown',visible:true,width:'100px',options:['REGULAR','STATE','FEDERAL']},
        {id:11,name:'location',type:'dropdown',visible:true,width:'100px',options:['LOCAL','OUT OF TOWN']},
        {id:12,name:'disposal',type:'text',visible:false,width:'100px'},
        {id:13,name:'manifest',type:'text',visible:false,width:'100px'},
        {id:14,name:'notified',type:'dropdown',visible:false,width:'80px',options:['Yes','No']},
        {id:15,name:'osha',type:'dropdown',visible:false,width:'80px',options:['Yes','No']},
        {id:16,name:'mp_total',type:'number',visible:false,width:'100px'},
        {id:17,name:'mp_used',type:'number',visible:false,width:'100px'},
        {id:18,name:'mp_active',type:'number',visible:false,width:'100px'},
        {id:19,name:'change_order',type:'currency',visible:false,width:'120px'},
        {id:20,name:'scheduled',type:'dropdown',visible:false,width:'80px',options:['Yes','No']},
        {id:21,name:'folder',type:'text',visible:false,width:'100px'},
        {id:22,name:'hotel',type:'text',visible:false,width:'120px'},
        {id:23,name:'call_off',type:'text',visible:false,width:'120px'},
        {id:24,name:'notes',type:'textarea',visible:false,width:'300px'},
        {id:25,name:'manifest_notes',type:'textarea',visible:false,width:'300px'}
    ];

    // Helpers
    function $(selector) {
        return document.querySelector(selector);
    }
    
    function $$(selector) {
        return document.querySelectorAll(selector);
    }
    
    function showNotification(message, type='info') {
        const container = document.getElementById('notificationContainer');
        const notif = document.createElement('div');
        notif.className = `notification ${type}`;
        const icons = {success:'‚úì',error:'‚úó',info:'‚Ñπ',warning:'‚ö†'};
        notif.innerHTML = `<span>${icons[type]}</span><span>${message}</span>`;
        container.appendChild(notif);
        setTimeout(() => notif.remove(), 3500);
    }

    function saveLocalConfig() {
        localStorage.setItem('cve_columns', JSON.stringify(columns));
        const currentTheme = $('#themeSelect') ? $('#themeSelect').value : 'light';
        localStorage.setItem('opsis_theme', currentTheme);
    }
    
    function loadLocalConfig() {
        const savedCols = localStorage.getItem('cve_columns');
        if (savedCols) {
            try {
                columns = JSON.parse(savedCols);
                columnConfigLoaded = true;
            } catch(err) {
                columns = [];
            }
        }
        
        const savedTheme = localStorage.getItem('opsis_theme') || 'light';
        applyTheme(savedTheme);
    }

    // API call helper
    async function callAPI(action, payload = {}) {
        try {
            updateConnectionIndicator(true);
            switch(action) {
                case 'getJobs':
                    return await API.getJobs(payload.year, payload.month);
                case 'createJob':
                    return await API.createJob(payload.job, payload.year, payload.month);
                case 'updateJob':
                    return await API.updateJob(payload.rowId, payload.updates, payload.year, payload.month);
                case 'deleteJob':
                    return await API.deleteJob(payload.rowId);
                case 'getStaff':
                    return await API.getStaff(payload.role);
                case 'addStaff':
                    return await API.addStaff(payload.type, payload.data);
                case 'updateStaff':
                    return await API.updateStaff(payload.employeeNumber, payload.updates);
                case 'deleteStaff':
                    return await API.deleteStaff(payload.employeeNumber);
                case 'getCertifications':
                    return await API.getCertifications();
                case 'addCertification':
                    return await API.addCertification(payload);
                case 'updateCertification':
                    return await API.updateCertification(payload.id, payload.updates);
                case 'deleteCertification':
                    return await API.deleteCertification(payload.id);
                case 'getDashboardStats':
                    return await API.getDashboardStats();
                case 'getUsers':
                    return await API.getUsers();
                case 'addUser':
                    return await API.addUser(payload);
                case 'updateUser':
                    return await API.updateUser(payload.username, payload.updates);
                case 'deleteUser':
                    return await API.deleteUser(payload.username);
                case 'getSkills':
                    return await API.getSkills();
                case 'getEmployeeSkills':
                    return await API.getEmployeeSkills();
                case 'addEmployeeSkill':
                    return await API.addEmployeeSkill(payload);
                case 'updateEmployeeSkill':
                    return await API.updateEmployeeSkill(payload.id, payload.updates);
                case 'deleteEmployeeSkill':
                    return await API.deleteEmployeeSkill(payload.id);
                default:
                    console.log('Action not implemented:', action);
                    return { success: true };
            }
        } catch(error) {
            console.error('API Error:', error);
            updateConnectionIndicator(false);
            return { success: false, error: error.message };
        }
    }

    function updateConnectionIndicator(connected=false) {
        const indicator = document.getElementById('connectionIndicator');
        if (connected) {
            indicator.textContent = 'üîä Connected';
            indicator.style.color = '#10b981';
        } else {
            indicator.textContent = 'üîä Disconnected';
            indicator.style.color = '#ef4444';
        }
    }

    // Theme application - FIXED: Removed 'auto' mode interference
    function applyTheme(mode) {
        const root = document.documentElement;
        localStorage.setItem('opsis_theme', mode);
        
        if (mode === 'dark') {
            root.style.setProperty('--card', 'rgba(255,255,255,0.05)');
            root.style.setProperty('--card-hover', 'rgba(255,255,255,0.1)');
            root.style.setProperty('--text', '#e5e7eb');
            root.style.setProperty('--muted', '#9ca3af');
            root.style.setProperty('--border', 'rgba(255,255,255,0.1)');
            root.style.setProperty('--modal-bg', 'rgba(255,255,255,0.05)');
            root.style.setProperty('--modal-text', '#e5e7eb');
            root.style.setProperty('--bg-dark-primary', '#1d1d1f');
            root.style.setProperty('--bg-dark-secondary', '#2d2d2f');
            document.body.style.background = 'linear-gradient(135deg, #1d1d1f 0%, #2d2d2f 100%)';
        } else {
            root.style.setProperty('--card', '#ffffff');
            root.style.setProperty('--card-hover', '#f1f5f9');
            root.style.setProperty('--text', '#374151');
            root.style.setProperty('--muted', '#6b7280');
            root.style.setProperty('--border', 'rgba(0,0,0,0.1)');
            root.style.setProperty('--modal-bg', '#ffffff');
            root.style.setProperty('--modal-text', '#374151');
            root.style.setProperty('--bg-dark-primary', '#f7f9fc');
            root.style.setProperty('--bg-dark-secondary', '#e8edf5');
            document.body.style.background = 'linear-gradient(135deg, #f7f9fc 0%, #e8edf5 100%)';
        }
        
        const primary = getComputedStyle(root).getPropertyValue('--timesync-primary').trim();
        const secondary = getComputedStyle(root).getPropertyValue('--timesync-secondary').trim();
        root.style.setProperty('--button-gradient-start', primary);
        root.style.setProperty('--button-gradient-end', secondary);
        root.style.setProperty('--gradient', 'linear-gradient(135deg, ' + primary + ', ' + secondary + ')');
        root.style.setProperty('--accent', primary);
    }

    // Navigation
    function switchPage(page) {
        currentPage = page;
        document.querySelectorAll('.nav-icon').forEach(icon => {
            icon.classList.toggle('active', icon.dataset.page === page);
        });
        document.querySelectorAll('.content').forEach(content => {
            content.classList.toggle('active', content.id === page);
        });
        
        const root = document.documentElement;
        const borderMapping = {
            dashboard: getComputedStyle(root).getPropertyValue('--dashboard-border').trim(),
            schedule: getComputedStyle(root).getPropertyValue('--schedule-border').trim(),
            staff: getComputedStyle(root).getPropertyValue('--staff-border').trim(),
            reports: getComputedStyle(root).getPropertyValue('--reports-border').trim(),
            users: getComputedStyle(root).getPropertyValue('--users-border').trim(),
            settings: getComputedStyle(root).getPropertyValue('--settings-border').trim()
        };
        const newBorder = borderMapping[page] || borderMapping.dashboard;
        root.style.setProperty('--module-border-color', newBorder);
        root.style.setProperty('--modal-border-color', newBorder);

        if (page === 'dashboard') loadDashboard();
        if (page === 'schedule') loadSchedule();
        if (page === 'staff') loadStaff();
        if (page === 'users') loadUsers();
    }

    // Subtabs
    function switchSubtab(section, tab) {
        currentSubtab[section] = tab;
        if (section === 'schedule') {
            document.querySelectorAll('#schedule .tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.subtab === tab);
            });
            document.querySelectorAll('#schedule .subtab-content').forEach(cont => {
                cont.style.display = cont.id === tab ? 'flex' : 'none';
            });
            if (tab === 'columns' && !columnConfigLoaded) loadColumns();
        } else if (section === 'staff') {
            document.querySelectorAll('#staff .tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.stafftab === tab);
            });
            document.querySelectorAll('#staff .staff-content').forEach(cont => {
                cont.style.display = cont.id === tab ? 'block' : 'none';
            });
            if (tab === 'supervisors') loadSupervisors();
            if (tab === 'crew') loadCrew();
            if (tab === 'skills') loadSkillsMatrix();
            if (tab === 'certifications') loadCertifications();
        } else if (section === 'settings') {
            document.querySelectorAll('#settings .tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.settingstab === tab);
            });
            document.querySelectorAll('#settings .settings-content').forEach(cont => {
                cont.style.display = cont.id === tab ? 'block' : 'none';
            });
        }
    }

    // Dashboard Data
    async function loadDashboard() {
        const result = await callAPI('getDashboardStats');
        if (result.success) {
            const stats = result.stats || {};
            $('#dashTotalJobs').textContent = stats.activeJobs || 0;
            $('#dashActiveCrew').textContent = `${stats.availableStaff||0}/${stats.totalStaff||0}`;
            $('#dashPendingJobs').textContent = stats.pendingJobs || 0;
            $('#dashEfficiency').textContent = (stats.efficiency || 0) + '%';
        }
    }

    // Schedule Data
    async function loadSchedule() {
        const year = parseInt($('#yearSelect').value);
        const month = $('#monthSelect').value;
        const result = await callAPI('getJobs', {year, month});
        if (result.success) {
            jobs = result.jobs || [];
            renderJobsTable();
            document.getElementById('jobCount').textContent = result.total || jobs.length;
        } else {
            jobs = [];
            renderJobsTable();
            document.getElementById('jobCount').textContent = 0;
        }
        updateScheduleStats();
        renderMiniCalendar();
    }

    function renderJobsTable() {
        const tableHead = document.getElementById('jobsTableHead');
        const tableBody = document.getElementById('jobsTableBody');
        
        let visibleCols = columns.length ? columns.filter(c => c.visible) : DEFAULT_SCHEMA.filter(c=>c.visible);
        
        // FIXED: Apply view mode filters
        if (viewMode === 'simple') {
            visibleCols = visibleCols.filter(c => ['date','job_number','status','job_address'].includes(c.name));
        } else if (viewMode === 'extended') {
            visibleCols = visibleCols.filter(c => ['date','job_number','time','pm','supervisor','crew','job_address','status','progress'].includes(c.name));
        }
        
        if (!columns.length) columns = JSON.parse(JSON.stringify(DEFAULT_SCHEMA));
        
        if (visibleCols.length === 0) {
            tableHead.innerHTML = '<th>Date</th><th>Job Number</th><th>Address</th><th>Status</th>';
            visibleCols = [{name:'date'},{name:'job_number'},{name:'job_address'},{name:'status'}];
        } else {
            tableHead.innerHTML = visibleCols.map(col => `<th>${col.name.replace(/_/g,' ').toUpperCase()}</th>`).join('');
        }
        
        if (!jobs || jobs.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${visibleCols.length}" class="empty">No jobs found</td></tr>`;
            return;
        }
        
        tableBody.innerHTML = jobs.map((job, idx) => {
            return `<tr data-index="${idx}">` + visibleCols.map(col => {
                let value = job[col.name] || '';
                if (col.type === 'date' && value) {
                    const date = new Date(value);
                    value = date.toLocaleDateString('en-US');
                }
                if (col.type === 'currency' && value) {
                    value = parseFloat(value).toLocaleString('en-US',{style:'currency',currency:'USD'});
                }
                if (Array.isArray(value)) {
                    return `<td>${value.join(', ')}</td>`;
                }
                return `<td>${value}</td>`;
            }).join('') + `</tr>`;
        }).join('');
        
        Array.from(tableBody.querySelectorAll('tr')).forEach((row, index) => {
            row.addEventListener('click', () => selectJobRow(index));
        });
    }

    function updateScheduleStats() {
        const today = new Date();
        const selected = selectedDate ? new Date(selectedDate) : today;
        selected.setHours(0,0,0,0);
        
        const weekStart = new Date(selected);
        weekStart.setDate(selected.getDate() - selected.getDay());
        weekStart.setHours(0,0,0,0);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        
        let jobsDay = 0;
        let jobsWeek = 0;
        const statusCounts = {};
        STATUS_LIST.forEach(s => { statusCounts[s] = {day:0, week:0}; });
        const positionCounts = {};
        POSITION_LIST.forEach(p => { positionCounts[p] = {day:0, week:0}; });
        
        jobs.forEach(job => {
            if (!job.date) return;
            const d = new Date(job.date);
            d.setHours(0,0,0,0);
            const isDay = d.getTime() === selected.getTime();
            const isWeek = d >= weekStart && d <= weekEnd;
            if (isDay) jobsDay++;
            if (isWeek) jobsWeek++;
            
            const status = job.status || '';
            const pos = job.position || '';
            if (STATUS_LIST.includes(status)) {
                if (isDay) statusCounts[status].day++;
                if (isWeek) statusCounts[status].week++;
            }
            if (POSITION_LIST.includes(pos)) {
                if (isDay) positionCounts[pos].day++;
                if (isWeek) positionCounts[pos].week++;
            }
        });
        
        const year = parseInt($('#yearSelect').value);
        const monthName = $('#monthSelect').value;
        document.getElementById('jobsTitle').textContent = `${monthName.charAt(0).toUpperCase() + monthName.slice(1)} ${year} Jobs`;
        document.getElementById('statToday').textContent = jobsDay;
        document.getElementById('statWeek').textContent = jobsWeek;
        
        const supAvail = staffData.supervisors.filter(s => s.status === 'AVAILABLE').length;
        const supTotal = staffData.supervisors.length;
        const crewAvail = staffData.crew.filter(c => c.status === 'AVAILABLE').length;
        const crewTotal = staffData.crew.length;
        document.getElementById('statSupAvail').textContent = `${supAvail}/${supTotal}`;
        document.getElementById('statCrewAvail').textContent = `${crewAvail}/${crewTotal}`;
        
        STATUS_LIST.forEach(s => {
            const elId = 'count' + s.replace(/\s+/g,'_');
            const el = document.getElementById(elId);
            if (el) {
                const counts = statusCounts[s];
                el.textContent = `${counts.day} (${counts.week})`;
            }
        });
        
        POSITION_LIST.forEach(p => {
            const elId = 'count' + p;
            const el = document.getElementById(elId);
            if (el) {
                const counts = positionCounts[p];
                el.textContent = `${counts.day} (${counts.week})`;
            }
        });
        
        updateSpecialtiesCounts();
    }

    function addOperationLog(action, jobNumber, message) {
        const now = new Date();
        const entry = `${now.toLocaleString()} ‚Ä¢ ${action} ${jobNumber || ''} ‚Äî ${message}`;
        operationLogs.unshift(entry);
        if (operationLogs.length > 50) {
            operationLogs.pop();
        }
        const logContainer = document.getElementById('operationsLog');
        if (logContainer) {
            logContainer.innerHTML = operationLogs.map(l => `<div class="log-entry">${l}</div>`).join('');
        }
    }

    function editJobRow() {
        if (selectedRowIndex == null || !jobs[selectedRowIndex]) return;
        const job = jobs[selectedRowIndex];
        editingRowIndex = selectedRowIndex;
        editingRowId = job.row_id;
        
        const form = document.getElementById('formAddJob');
        if (!form) return;
        form.job_number.value = job.job_number || '';
        form.status.value = job.status || '';
        form.job_address.value = job.job_address || '';
        
        const dateVal = job.date;
        form.date.value = dateVal ? new Date(dateVal).toISOString().split('T')[0] : '';
        form.time.value = job.time || '';
        form.progress.value = job.progress || '';
        form.location.value = job.location || '';
        form.pm.value = job.pm || '';
        form.position.value = job.position || '';
        form.supervisor.value = job.supervisor || '';
        form.crew.value = job.crew || '';
        form.osha.value = job.osha || '';
        form.manifest.value = job.manifest || '';
        form.notified.value = job.notified || '';
        form.scheduled.value = job.scheduled || '';
        form.notes.value = job.notes || '';
        form.manifest_notes.value = job.manifest_notes || '';
        
        document.getElementById('modalAddJob').classList.add('show');
        document.querySelectorAll('#modalAddJob .jobtab').forEach(c => c.style.display='none');
        document.getElementById('basic').style.display='block';
        document.querySelectorAll('#modalAddJob [data-jobtab]').forEach(b => {
            b.style.borderBottomColor='transparent';
            b.style.color = '#374151';
        });
        document.querySelector('#modalAddJob [data-jobtab="basic"]').style.borderBottomColor='#3b82f6';
        document.querySelector('#modalAddJob [data-jobtab="basic"]').style.color='#3b82f6';
    }

    async function duplicateJobRow() {
        if (selectedRowIndex == null || !jobs[selectedRowIndex]) return;
        const original = jobs[selectedRowIndex];
        const year = parseInt($('#yearSelect').value);
        const month = $('#monthSelect').value;
        const newJob = {};
        Object.keys(original).forEach(k => {
            if (['row_id','id','created_at','modified_at','updated_at'].includes(k.toLowerCase())) return;
            newJob[k] = original[k];
        });
        const res = await callAPI('createJob', {job:newJob, year, month});
        if (res.success) {
            addOperationLog('Duplicate', original.job_number || '', 'Job duplicated');
            showNotification('Job duplicated','success');
            loadSchedule();
        } else {
            showNotification('Failed to duplicate job','error');
        }
    }

    async function deleteJobRow() {
        if (selectedRowIndex == null || !jobs[selectedRowIndex]) return;
        const job = jobs[selectedRowIndex];
        const rowId = job.row_id;
        if (!rowId) return;
        if (!confirm('Are you sure you want to delete this job?')) return;
        const year = parseInt($('#yearSelect').value);
        const month = $('#monthSelect').value;
        const res = await callAPI('deleteJob', {rowId, year, month});
        if (res.success) {
            addOperationLog('Delete', job.job_number || '', 'Job deleted');
            showNotification('Job deleted','success');
            loadSchedule();
        } else {
            showNotification('Failed to delete job','error');
        }
    }

    // Staff Data
    async function loadStaff() {
        try {
            await loadSupervisors();
        } catch(e) {}
        try {
            await loadCrew();
        } catch(e) {}
        updateStaffOverview();
    }

    async function loadSupervisors() {
        const result = await callAPI('getStaff', {role:'SUPERVISOR'});
        if (result.success) {
            staffData.supervisors = result.staff || [];
            const tbody = document.getElementById('supervisorsTable');
            if (!staffData.supervisors.length) {
                tbody.innerHTML = `<tr><td colspan="7" class="empty">No supervisors found</td></tr>`;
            } else {
                tbody.innerHTML = staffData.supervisors.map(s => {
                    let specialties = s.specialties || [];
                    if (typeof specialties === 'string') {
                        try {
                            specialties = JSON.parse(specialties);
                        } catch(e) {
                            specialties = [];
                        }
                    }
                    const specialtiesStr = Array.isArray(specialties) ? specialties.join(', ') : '';
                    return `<tr>
                        <td>${s.employee_number || ''}</td>
                        <td>${s.full_name || ''}</td>
                        <td><span class="badge badge-info">${s.role}</span></td>
                        <td><span class="badge ${s.status==='AVAILABLE'? 'badge-success':'badge-warning'}">${s.status}</span></td>
                        <td>${s.division || ''}</td>
                        <td>${specialtiesStr}</td>
                        <td><button class="btn small" data-edit="supervisor" data-id="${s.employee_number}">Edit</button> <button class="btn small danger" data-delete="supervisor" data-id="${s.employee_number}">Delete</button></td>
                    </tr>`;
                }).join('');
            }
            updateScheduleStats();
            updateStaffOverview();
        }
    }

    async function loadCrew() {
        const result = await callAPI('getStaff', {role:'CREW'});
        if (result.success) {
            staffData.crew = result.staff || [];
            const tbody = document.getElementById('crewTable');
            if (!staffData.crew.length) {
                tbody.innerHTML = `<tr><td colspan="7" class="empty">No crew members found</td></tr>`;
            } else {
                tbody.innerHTML = staffData.crew.map(c => {
                    let specialties = c.specialties || [];
                    if (typeof specialties === 'string') {
                        try {
                            specialties = JSON.parse(specialties);
                        } catch(e) {
                            specialties = [];
                        }
                    }
                    const specialtiesStr = Array.isArray(specialties) ? specialties.join(', ') : '';
                    return `<tr>
                        <td>${c.employee_number || ''}</td>
                        <td>${c.full_name || ''}</td>
                        <td><span class="badge badge-info">${c.role}</span></td>
                        <td><span class="badge ${c.status==='AVAILABLE'? 'badge-success':'badge-warning'}">${c.status}</span></td>
                        <td>${c.division || ''}</td>
                        <td>${specialtiesStr}</td>
                        <td><button class="btn small" data-edit="crew" data-id="${c.employee_number}">Edit</button> <button class="btn small danger" data-delete="crew" data-id="${c.employee_number}">Delete</button></td>
                    </tr>`;
                }).join('');
            }
            updateScheduleStats();
            updateStaffOverview();
        }
    }

    function updateSpecialtiesCounts() {
        const specKeys = ['Asbestos','Lead','Mold','Bio Haz','Bacteria','Contents','Duct Cleaning','Drivers'];
        const supCounts = {};
        const supAvailCounts = {};
        const crewCounts = {};
        const crewAvailCounts = {};
        specKeys.forEach(k => {
            supCounts[k] = 0;
            supAvailCounts[k] = 0;
            crewCounts[k] = 0;
            crewAvailCounts[k] = 0;
        });
        
        staffData.supervisors.forEach(s => {
            let specs = s.specialties || [];
            if (typeof specs === 'string') {
                try { specs = JSON.parse(specs); } catch(e) { specs = []; }
            }
            const arr = Array.isArray(specs) ? specs : specs.toString().split(',').map(sp => sp.trim());
            arr.forEach(sp => {
                specKeys.forEach(k => {
                    const spSan = sp.toLowerCase().replace(/\s+/g,'');
                    const keySan = k.toLowerCase().replace(/\s+/g,'');
                    if (spSan.includes(keySan)) {
                        supCounts[k]++;
                        if (s.status === 'AVAILABLE') {
                            supAvailCounts[k]++;
                        }
                    }
                });
            });
        });
        
        staffData.crew.forEach(c => {
            let specs = c.specialties || [];
            if (typeof specs === 'string') {
                try { specs = JSON.parse(specs); } catch(e) { specs = []; }
            }
            const arr = Array.isArray(specs) ? specs : specs.toString().split(',').map(sp => sp.trim());
            arr.forEach(sp => {
                specKeys.forEach(k => {
                    const spSan = sp.toLowerCase().replace(/\s+/g,'');
                    const keySan = k.toLowerCase().replace(/\s+/g,'');
                    if (spSan.includes(keySan)) {
                        crewCounts[k]++;
                        if (c.status === 'AVAILABLE') {
                            crewAvailCounts[k]++;
                        }
                    }
                });
            });
        });
        
        const specMap = {
            'Asbestos': 'Asbestos',
            'Lead': 'Lead',
            'Mold': 'Mold',
            'Bio Haz': 'Bio',
            'Bacteria': 'Bacteria',
            'Contents': 'Contents',
            'Duct Cleaning': 'Duct',
            'Drivers': 'Drivers'
        };
        
        specKeys.forEach(k => {
            const idPart = specMap[k
                ] || k.replace(/\s+/g,'');
            const supEl = document.getElementById('sup' + idPart + 'Count');
            const crewEl = document.getElementById('crew' + idPart + 'Count');
            if (supEl) supEl.textContent = `${supAvailCounts[k]}/${supCounts[k]}`;
            if (crewEl) crewEl.textContent = `${crewAvailCounts[k]}/${crewCounts[k]}`;
        });
    }

    function renderMiniCalendar() {
        const year = parseInt($('#yearSelect').value);
        const monthName = $('#monthSelect').value;
        const monthIndex = MONTH_NAMES.indexOf(monthName);
        currentCalendarMonth = new Date(year, monthIndex, 1);
        const calendar = document.getElementById('miniCalendar');
        const monthLabel = document.getElementById('calendarMonth');
        
        if (monthLabel) {
            monthLabel.textContent = `${monthName.charAt(0).toUpperCase() + monthName.slice(1)} ${year}`;
        }
        
        const jobsByDate = {};
        jobs.forEach(job => {
            const dateVal = job.date;
            if (!dateVal) return;
            const d = new Date(dateVal);
            const y = d.getFullYear();
            const m = d.getMonth() + 1;
            const day = d.getDate();
            const dateStr = `${y}-${String(m).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            jobsByDate[dateStr] = (jobsByDate[dateStr] || 0) + 1;
        });
        
        const firstDay = currentCalendarMonth.getDay();
        const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
        
        calendar.innerHTML = '';
        
        const headers = ['S','M','T','W','T','F','S'];
        headers.forEach(h => {
            const cell = document.createElement('div');
            cell.className = 'day-header';
            cell.textContent = h;
            calendar.appendChild(cell);
        });
        
        for (let i = 0; i < firstDay; i++) {
            const blank = document.createElement('div');
            blank.className = 'day other-month';
            calendar.appendChild(blank);
        }
        
        for (let d = 1; d <= daysInMonth; d++) {
            const cell = document.createElement('div');
            cell.className = 'day';
            const dateStr = `${year}-${String(monthIndex+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            cell.dataset.date = dateStr;
            cell.textContent = d;
            
            const t = new Date();
            if (t.getFullYear() === year && t.getMonth() === monthIndex && t.getDate() === d) {
                cell.classList.add('today');
            }
            if (selectedDate && selectedDate === dateStr) {
                cell.classList.add('selected');
            }
            if (jobsByDate[dateStr]) {
                cell.classList.add('has-jobs');
            }
            cell.addEventListener('click', () => {
                selectDate(dateStr);
            });
            calendar.appendChild(cell);
        }
        
        const totalCells = headers.length + firstDay + daysInMonth;
        const remainder = totalCells % 7;
        if (remainder !== 0) {
            const blanks = 7 - remainder;
            for (let i = 0; i < blanks; i++) {
                const blank = document.createElement('div');
                blank.className = 'day other-month';
                calendar.appendChild(blank);
            }
        }
    }

    function selectDate(dateStr) {
        selectedDate = dateStr;
        document.querySelectorAll('#miniCalendar .day').forEach(cell => {
            if (cell.dataset.date) {
                if (cell.dataset.date === dateStr) {
                    cell.classList.add('selected');
                } else {
                    cell.classList.remove('selected');
                }
            }
        });
        updateScheduleStats();
    }

    function changeCalendarMonth(offset) {
        let year = parseInt($('#yearSelect').value);
        let monthName = $('#monthSelect').value;
        let monthIndex = MONTH_NAMES.indexOf(monthName);
        monthIndex += offset;
        if (monthIndex < 0) {
            monthIndex = 11;
            year--;
        } else if (monthIndex > 11) {
            monthIndex = 0;
            year++;
        }
        $('#yearSelect').value = year;
        $('#monthSelect').value = MONTH_NAMES[monthIndex];
        selectedDate = null;
        loadSchedule();
    }

    function selectJobRow(index) {
        selectedRowIndex = index;
        const rows = document.querySelectorAll('#jobsTableBody tr');
        rows.forEach((r,i) => {
            if (i === index) {
                r.style.background = '#e0e7ff';
            } else {
                r.style.background = '';
            }
        });
        const job = jobs[index];
        const infoEl = document.getElementById('selectedJobInfo');
        const btnEdit = document.getElementById('btnEditRow');
        const btnDup = document.getElementById('btnDuplicateRow');
        const btnDel = document.getElementById('btnDeleteRow');
        if (job && infoEl) {
            const dateLabel = job.date ? new Date(job.date).toLocaleDateString('en-US') : '';
            infoEl.textContent = `Job #${job.job_number || ''} ‚Äî ${dateLabel}`;
            if (btnEdit) btnEdit.disabled = false;
            if (btnDup) btnDup.disabled = false;
            if (btnDel) btnDel.disabled = false;
        } else {
            if (infoEl) infoEl.textContent = 'Select a row';
            if (btnEdit) btnEdit.disabled = true;
            if (btnDup) btnDup.disabled = true;
            if (btnDel) btnDel.disabled = true;
        }
    }

    // Skills Matrix - COMPLETE IMPLEMENTATION
    async function loadSkillsMatrix() {
        const container = document.getElementById('skillsMatrixBody');
        if (!container) return;
        
        try {
            // Load skills and employee skills from Supabase
            const [skillsResult, empSkillsResult] = await Promise.all([
                callAPI('getSkills'),
                callAPI('getEmployeeSkills')
            ]);
            
            if (!skillsResult.success || !empSkillsResult.success) {
                container.innerHTML = '<div class="empty">Failed to load skills data</div>';
                return;
            }
            
            const skills = skillsResult.skills || [];
            const employeeSkills = empSkillsResult.employeeSkills || [];
            
            if (skills.length === 0) {
                container.innerHTML = '<div class="empty">No skills defined. Click "Add Skill" to create skills.</div>';
                return;
            }
            
            // Combine supervisors and crew
            const allStaff = [...staffData.supervisors, ...staffData.crew];
            
            if (allStaff.length === 0) {
                container.innerHTML = '<div class="empty">No staff members found</div>';
                return;
            }
            
            // Build skills matrix table
            let html = '<table class="skills-matrix-table">';
            html += '<thead><tr>';
            html += '<th style="min-width:150px;">Employee</th>';
            html += '<th style="min-width:80px;">Role</th>';
            skills.forEach(skill => {
                html += `<th style="min-width:100px;">${skill.skill_name}</th>`;
            });
            html += '</tr></thead>';
            html += '<tbody>';
            
            allStaff.forEach(emp => {
                const empNum = emp.employee_number;
                const empName = emp.full_name;
                const empRole = emp.role;
                
                html += '<tr>';
                html += `<td>${empName}</td>`;
                html += `<td><span class="badge badge-${empRole === 'SUPERVISOR' ? 'info' : 'secondary'}">${empRole}</span></td>`;
                
                skills.forEach(skill => {
                    const empSkill = employeeSkills.find(es => 
                        es.employee_number === empNum && es.skill_name === skill.skill_name
                    );
                    
                    if (empSkill) {
                        const level = empSkill.proficiency_level || 'basic';
                        const certified = empSkill.certified;
                        html += '<td>';
                        html += `<div class="skill-level-indicator skill-level-${level}">${level}</div>`;
                        if (certified) {
                            html += `<div class="skill-certified">‚úì</div>`;
                        }
                        html += '</td>';
                    } else {
                        html += '<td style="color:#d1d5db;">‚Äî</td>';
                    }
                });
                
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
            
        } catch(error) {
            console.error('Error loading skills matrix:', error);
            container.innerHTML = '<div class="empty">Error loading skills matrix</div>';
        }
    }

    async function loadCertifications() {
        const res = await callAPI('getCertifications');
        const container = document.getElementById('certificationsTableBody');
        const metricsContainer = document.getElementById('certMetrics');
        const filterSelect = document.getElementById('certFilterType');
        
        certifications = [];
        if (res.success) {
            certifications = res.certifications || [];
        }
        
        if (filterSelect) {
            const types = new Set();
            certifications.forEach(c => {
                const t = c.certification_type;
                if (t) types.add(t);
            });
            const prev = filterSelect.value;
            filterSelect.innerHTML = '<option value="">All Types</option>';
            Array.from(types).sort().forEach(t => {
                filterSelect.innerHTML += `<option value="${t}">${t.replace(/_/g,' ')}</option>`;
            });
            if (prev && types.has(prev)) {
                filterSelect.value = prev;
            }
        }
        
        renderCertificationsTable();
        updateStaffOverview();
    }

    function renderCertificationsTable() {
        const container = document.getElementById('certificationsTableBody');
        const metricsContainer = document.getElementById('certMetrics');
        const filterSelect = document.getElementById('certFilterType');
        if (!container) return;
        
        let list = certifications.slice();
        
        if (filterSelect && filterSelect.value) {
            list = list.filter(c => {
                const t = c.certification_type;
                return t === filterSelect.value;
            });
        }
        
        if (!list.length) {
            container.innerHTML = '<div class="empty">No certifications found</div>';
            if (metricsContainer) metricsContainer.innerHTML = '';
            return;
        }
        
        let critical = 0;
        let warning = 0;
        let ok = 0;
        const today = new Date();
        
        let html = '<table style="width:100%; border-collapse:collapse; font-size:11px;"><thead><tr>';
        const cols = ['Employee','Type','Issue Date','Expiry Date','Cert #','Notes'];
        cols.forEach(h => {
            html += `<th style="text-transform:uppercase; font-weight:600; color:#6b7280; padding:8px 6px; border-bottom:1px solid #e5e7eb;">${h}</th>`;
        });
        html += '</tr></thead><tbody>';
        
        list.forEach(c => {
            const issue = c.issue_date;
            const expiry = c.expiry_date;
            let expiryDate = expiry ? new Date(expiry) : null;
            let statusClass = 'cert-status-ok';
            if (expiryDate && !isNaN(expiryDate)) {
                const diff = (expiryDate.getTime() - today.getTime()) / 86400000;
                const days = Math.floor(diff);
                if (days <= 30) {
                    statusClass = 'cert-status-critical';
                    critical++;
                } else if (days <= 60) {
                    statusClass = 'cert-status-warning';
                    warning++;
                } else {
                    ok++;
                }
            } else {
                ok++;
            }
            
            html += `<tr class="${statusClass}" style="cursor:pointer;">`;
            html += `<td style="padding:6px 8px; border-bottom:1px solid #f3f4f6;">${c.employee_name || ''}</td>`;
            const certType = c.certification_type || '';
            html += `<td style="padding:6px 8px; border-bottom:1px solid #f3f4f6;">${certType.replace(/_/g,' ')}</td>`;
            const issueStr = issue ? new Date(issue).toLocaleDateString('en-US') : '';
            html += `<td style="padding:6px 8px; border-bottom:1px solid #f3f4f6;">${issueStr}</td>`;
            const expiryStr = expiry ? new Date(expiry).toLocaleDateString('en-US') : '';
            html += `<td style="padding:6px 8px; border-bottom:1px solid #f3f4f6;">${expiryStr}</td>`;
            html += `<td style="padding:6px 8px; border-bottom:1px solid #f3f4f6;">${c.cert_number || ''}</td>`;
            let noteStr = (c.notes || '');
            if (c.file_data) {
                noteStr += ` <a href="data:application/pdf;base64,${c.file_data}" target="_blank" title="View PDF">üìÑ</a>`;
            }
            html += `<td style="padding:6px 8px; border-bottom:1px solid #f3f4f6;">${noteStr}</td>`;
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
        
        if (metricsContainer) {
            metricsContainer.innerHTML = `
                <div class="card" style="border-left:4px solid #ef4444;">
                    <div class="value">${critical}</div>
                    <div class="subtext">Critical (&lt;30d)</div>
                </div>
                <div class="card" style="border-left:4px solid #f59e0b;">
                    <div class="value">${warning}</div>
                    <div class="subtext">Expiring (&lt;60d)</div>
                </div>
                <div class="card" style="border-left:4px solid #10b981;">
                    <div class="value">${ok}</div>
                    <div class="subtext">Active (‚â•60d)</div>
                </div>`;
        }
        
        const rows = container.querySelectorAll('tbody tr');
        rows.forEach((row, idx) => {
            row.addEventListener('click', () => {
                openEditCertificationModal(list[idx]);
            });
        });
    }

    function openEditCertificationModal(cert) {
        const modal = document.getElementById('modalEditCertification');
        const form = document.getElementById('formEditCertification');
        if (!modal || !form) return;
        
        form.certId.value = cert.id || '';
        form.employeeName.value = cert.employee_name || '';
        
        const certType = cert.certification_type || '';
        form.certificationType.value = certType.replace(/_/g,' ');
        
        const issueVal = cert.issue_date || '';
        if (issueVal) {
            const d = new Date(issueVal);
            form.issueDate.value = d.toISOString().substring(0,10);
        } else {
            form.issueDate.value = '';
        }
        const expVal = cert.expiry_date || '';
        if (expVal) {
            const d2 = new Date(expVal);
            form.expiryDate.value = d2.toISOString().substring(0,10);
        } else {
            form.expiryDate.value = '';
        }
        form.certNumber.value = cert.cert_number || '';
        form.notes.value = cert.notes || '';
        
        const ex = document.getElementById('existingCertFile');
        if (ex) {
            const fileData = cert.file_data;
            const fileName = cert.file_name || 'View PDF';
            if (fileData) {
                ex.innerHTML = `<a href="data:application/pdf;base64,${fileData}" target="_blank">${fileName}</a>`;
            } else {
                ex.innerHTML = '';
            }
        }
        modal.classList.add('show');
    }

    // Columns Manager with Drag & Drop - FIXED
    async function loadColumns() {
        if (columns.length) {
            renderColumnsTable();
            return;
        }
        columns = JSON.parse(JSON.stringify(DEFAULT_SCHEMA));
        renderColumnsTable();
    }
    
    function renderColumnsTable() {
        const tbody = document.getElementById('columnsTableBody');
        if (!columns.length) {
            tbody.innerHTML = '<tr><td colspan="8" class="empty">No columns</td></tr>';
            return;
        }
        
        tbody.innerHTML = columns.map((col, idx) => {
            const optionsPreview = col.options && col.options.length ? col.options.slice(0,3).map(o => `<span style="background:#f3f4f6; padding:2px 4px; border-radius:4px; margin-right:4px;">${o}</span>`).join('') : '-';
            return `<tr class="column-row" data-index="${idx}" draggable="true">
                <td>${col.id}</td>
                <td>
                    <label class="switch">
                        <input type="checkbox" ${col.visible?'checked':''} data-toggle="${col.id}">
                        <span class="slider"></span>
                    </label>
                </td>
                <td>${col.name}</td>
                <td>${col.type}</td>
                <td>${col.required? 'Yes':'No'}</td>
                <td><input type="number" value="${parseInt(col.width)}" data-width="${col.id}" style="width:60px;" /></td>
                <td>${optionsPreview}</td>
                <td><button class="btn small" data-edit-column="${col.id}">Edit</button></td>
            </tr>`;
        }).join('');
        
        attachColumnListeners();
    }

    // FIXED: Drag & Drop implementation for columns
    function attachColumnListeners() {
        const tbody = document.getElementById('columnsTableBody');
        if (!tbody) return;
        
        // Toggle visibility
        tbody.querySelectorAll('input[data-toggle]').forEach(input => {
            input.onchange = () => {
                const id = parseInt(input.dataset.toggle);
                const col = columns.find(c => c.id === id);
                if (col) col.visible = input.checked;
                saveLocalConfig();
                renderJobsTable();
            };
        });
        
        // Width input changes
        tbody.querySelectorAll('input[data-width]').forEach(input => {
            input.onchange = () => {
                const id = parseInt(input.dataset.width);
                const col = columns.find(c => c.id === id);
                if (col) col.width = input.value + 'px';
                saveLocalConfig();
                renderJobsTable();
            };
        });
        
        // Edit column button
        tbody.querySelectorAll('[data-edit-column]').forEach(btn => {
            btn.onclick = () => {
                const id = parseInt(btn.dataset.editColumn);
                openEditColumnModal(id);
            };
        });
        
        // Drag & Drop functionality
        const rows = tbody.querySelectorAll('.column-row');
        let draggedElement = null;
        
        rows.forEach(row => {
            row.addEventListener('dragstart', (e) => {
                draggedElement = row;
                row.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });
            
            row.addEventListener('dragend', (e) => {
                row.classList.remove('dragging');
                draggedElement = null;
            });
            
            row.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                if (draggedElement && draggedElement !== row) {
                    const allRows = Array.from(tbody.querySelectorAll('.column-row'));
                    const draggedIndex = allRows.indexOf(draggedElement);
                    const targetIndex = allRows.indexOf(row);
                    
                    if (draggedIndex < targetIndex) {
                        row.parentNode.insertBefore(draggedElement, row.nextSibling);
                    } else {
                        row.parentNode.insertBefore(draggedElement, row);
                    }
                }
            });
            
            row.addEventListener('drop', (e) => {
                e.preventDefault();
                
                // Reorder columns array based on new DOM order
                const newOrder = Array.from(tbody.querySelectorAll('.column-row')).map(r => {
                    const idx = parseInt(r.dataset.index);
                    return columns[idx];
                });
                
                columns = newOrder;
                saveLocalConfig();
                renderJobsTable();
                showNotification('Column order updated', 'success');
            });
        });
    }

    function openEditColumnModal(id) {
        const col = columns.find(c => c.id === id);
        if (!col) return;
        
        $('#editColumnId').value = col.id;
        $('#editColumnName').value = col.name;
        $('#editColumnType').value = col.type;
        $('#editColumnWidth').value = parseInt(col.width);
        $('#editColumnRequired').value = col.required ? 'true' : 'false';
        $('#editColumnDescription').value = col.description || '';
        
        if (col.type === 'dropdown' || col.type === 'multiselect') {
            $('#editColumnOptionsContainer').style.display = 'block';
            $('#editColumnOptions').value = col.options ? col.options.join('\n') : '';
        } else {
            $('#editColumnOptionsContainer').style.display = 'none';
            $('#editColumnOptions').value = '';
        }
        
        document.getElementById('modalEditColumn').classList.add('show');
    }

    async function loadCertificationEmployees() {
        const result = await callAPI('getStaff', {});
        const select = document.getElementById('certificationEmployee');
        select.innerHTML = '<option value="">Select Employee</option>';
        if (result.success) {
            const staff = result.staff || [];
            staff.forEach(s => {
                const empNum = s.employee_number || '';
                const fullName = s.full_name || '';
                select.innerHTML += `<option value="${empNum}">${fullName}</option>`;
            });
        }
    }

    // Users Management - COMPLETE IMPLEMENTATION
    async function loadUsers() {
        try {
            const res = await callAPI('getUsers');
            if (res.success) {
                users = res.users || [];
            } else {
                users = [];
            }
        } catch (e) {
            console.error('Failed to load users', e);
            users = [];
        }
        renderUsersTable();
    }
    
    function renderUsersTable() {
        const container = document.getElementById('usersTableContainer');
        if (!container) return;
        
        if (!users || !users.length) {
            container.innerHTML = '<div class="empty">No users found</div>';
            return;
        }
        
        let html = '<table style="width:100%; border-collapse:collapse; font-size:12px;">';
        html += '<thead><tr><th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">Username</th><th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">Email</th><th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">Role</th><th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">Status</th><th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">Actions</th></tr></thead><tbody>';
        
        users.forEach((u, idx) => {
            const uname = u.username || '';
            const email = u.email || '';
            const role = u.role || '';
            const active = (u.active === false || u.active === 'false') ? 'Inactive' : 'Active';
            html += `<tr><td style="padding:6px 8px; border-bottom:1px solid var(--border);">${uname}</td>`;
            html += `<td style="padding:6px 8px; border-bottom:1px solid var(--border);">${email}</td>`;
            html += `<td style="padding:6px 8px; border-bottom:1px solid var(--border);">${role}</td>`;
            html += `<td style="padding:6px 8px; border-bottom:1px solid var(--border);">${active}</td>`;
            html += `<td style="padding:6px 8px; border-bottom:1px solid var(--border);"><button class="btn small" data-edit-user="${idx}">Edit</button> <button class="btn small danger" data-delete-user="${idx}">Delete</button></td></tr>`;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
        
        container.querySelectorAll('button[data-edit-user]').forEach(btn => {
            btn.onclick = () => {
                const idx = parseInt(btn.dataset.editUser);
                openUserModal(users[idx], idx);
            };
        });
        
        container.querySelectorAll('button[data-delete-user]').forEach(btn => {
            btn.onclick = async () => {
                const idx = parseInt(btn.dataset.deleteUser);
                const user = users[idx];
                if (!confirm('Delete this user?')) return;
                try {
                    const res = await callAPI('deleteUser', { username: user.username });
                    if (res.success) {
                        showNotification('User deleted', 'success');
                        loadUsers();
                    } else {
                        showNotification(res.error || 'Failed to delete user', 'error');
                    }
                } catch (e) {
                    console.error('Delete user failed', e);
                    showNotification('Error deleting user', 'error');
                }
            };
        });
    }
    
    function openUserModal(user = null, index = null) {
        const modal = document.getElementById('modalUser');
        if (!modal) return;
        
        const title = modal.querySelector('.modal-title');
        const usernameInput = document.getElementById('userUsername');
        const emailInput = document.getElementById('userEmail');
        const passwordInput = document.getElementById('userPassword');
        const roleSelect = document.getElementById('userRole');
        const activeSelect = document.getElementById('userActive');
        
        if (user) {
            title.textContent = 'Edit User';
            usernameInput.value = user.username || '';
            emailInput.value = user.email || '';
            passwordInput.value = '';
            passwordInput.placeholder = 'Leave blank to keep current password';
            roleSelect.value = user.role || 'USER';
            activeSelect.value = (user.active === false || user.active === 'false') ? 'false' : 'true';
            usernameInput.disabled = true;
            modal.dataset.editIndex = index;
        } else {
            title.textContent = 'Add User';
            usernameInput.value = '';
            emailInput.value = '';
            passwordInput.value = '';
            passwordInput.placeholder = 'Enter password';
            roleSelect.value = 'USER';
            activeSelect.value = 'true';
            usernameInput.disabled = false;
            delete modal.dataset.editIndex;
        }
        
        modal.classList.add('show');
    }
    
    async function saveUser() {
        const modal = document.getElementById('modalUser');
        if (!modal) return;
        
        const username = document.getElementById('userUsername').value.trim();
        const email = document.getElementById('userEmail').value.trim();
        const password = document.getElementById('userPassword').value.trim();
        const role = document.getElementById('userRole').value;
        const active = document.getElementById('userActive').value === 'true';
        
        if (!username || !email) {
            showNotification('Username and email are required', 'error');
            return;
        }
        
        const editIndex = modal.dataset.editIndex ? parseInt(modal.dataset.editIndex) : null;
        
        if (editIndex !== null) {
            const oldUser = users[editIndex];
            const payload = { username: oldUser.username, updates: { role, active } };
            if (password) payload.updates.password = password;
            if (email !== oldUser.email) payload.updates.email = email;
            
            try {
                const res = await callAPI('updateUser', payload);
                if (res.success) {
                    showNotification('User updated', 'success');
                    closeModal('modalUser');
                    loadUsers();
                } else {
                    showNotification(res.error || 'Failed to update user', 'error');
                }
            } catch (e) {
                console.error('Update user error', e);
                showNotification('Error updating user', 'error');
            }
        } else {
            if (!password) {
                showNotification('Password is required for new users', 'error');
                return;
            }
            
            const payload = { username, email, password, role, active };
            try {
                const res = await callAPI('addUser', payload);
                if (res.success) {
                    showNotification('User added', 'success');
                    closeModal('modalUser');
                    loadUsers();
                } else {
                    showNotification(res.error || 'Failed to add user', 'error');
                }
            } catch (e) {
                console.error('Add user error', e);
                showNotification('Error adding user', 'error');
            }
        }
    }

    function updateStaffOverview() {
        try {
            const totalSup = staffData && staffData.supervisors ? staffData.supervisors.length : 0;
            const totalCrew = staffData && staffData.crew ? staffData.crew.length : 0;
            const total = totalSup + totalCrew;
            
            let availableSup = 0;
            let availableCrew = 0;
            if (staffData && staffData.supervisors) {
                availableSup = staffData.supervisors.filter(s => s.status === 'AVAILABLE').length;
            }
            if (staffData && staffData.crew) {
                availableCrew = staffData.crew.filter(c => c.status === 'AVAILABLE').length;
            }
            const available = availableSup + availableCrew;
            
            if (document.getElementById('overviewTotal')) document.getElementById('overviewTotal').textContent = total;
            if (document.getElementById('overviewAvailable')) document.getElementById('overviewAvailable').textContent = available;
            if (document.getElementById('overviewSupervisors')) document.getElementById('overviewSupervisors').textContent = totalSup;
            if (document.getElementById('overviewCrew')) document.getElementById('overviewCrew').textContent = totalCrew;
            
            let active = 0;
            let expiring = 0;
            const today = new Date();
            (certifications || []).forEach(cert => {
                const expiry = cert.expiry_date;
                if (!expiry) return;
                const expiryDate = new Date(expiry);
                if (isNaN(expiryDate.getTime())) return;
                const diff = (expiryDate.getTime() - today.getTime()) / 86400000;
                const days = Math.floor(diff);
                if (days < 0) return;
                if (days <= 60) expiring++;
                else active++;
            });
            
            if (document.getElementById('overviewCertified')) document.getElementById('overviewCertified').textContent = active + expiring;
            if (document.getElementById('overviewCertActive')) document.getElementById('overviewCertActive').textContent = active;
            if (document.getElementById('overviewCertExpiring')) document.getElementById('overviewCertExpiring').textContent = expiring;
        } catch(e) {
            console.error('updateStaffOverview error', e);
        }
    }

    // Utility functions
    function openAddJobModal() {
        const modal = document.getElementById('modalAddJob');
        if (!modal) return;
        modal.classList.add('show');
        const form = document.getElementById('formAddJob');
        if (form && form.reset) form.reset();
        
        // Reset editing state
        editingRowId = null;
        editingRowIndex = null;
        
        document.querySelectorAll('#modalAddJob .jobtab').forEach(c => c.style.display = 'none');
        const basic = document.getElementById('basic');
        if (basic) basic.style.display = 'block';
        
        document.querySelectorAll('#modalAddJob [data-jobtab]').forEach(btn => {
            btn.style.borderBottomColor = 'transparent';
            btn.style.color = '#374151';
        });
        const basicBtn = document.querySelector('#modalAddJob [data-jobtab="basic"]');
        if (basicBtn) {
            basicBtn.style.borderBottomColor = '#3b82f6';
            basicBtn.style.color = '#3b82f6';
        }
    }

    function openScheduleFilters() {
        switchSubtab('schedule', 'filters');
    }

    function refreshPage() {
        loadSchedule();
        loadDashboard();
    }

    async function exportSchedule() {
        const yearSelect = document.getElementById('yearSelect');
        const monthSelect = document.getElementById('monthSelect');
        if (!yearSelect || !monthSelect) return;
        const year = parseInt(yearSelect.value);
        const month = monthSelect.value;
        
        const cols = columns.filter(c => c.visible);
        if (!cols.length) return;
        
        let csv = cols.map(c => c.name).join(',') + '\n';
        jobs.forEach(job => {
            const row = cols.map(col => {
                let val = job[col.name] || '';
                if (col.type === 'date' && val) {
                    val = new Date(val).toLocaleDateString('en-US');
                }
                const cellStr = (val+'').replace(/"/g,'""');
                if (cellStr.includes(',') || cellStr.includes('"')) {
                    return '"' + cellStr + '"';
                }
                return cellStr;
            });
            csv += row.join(',') + '\n';
        });
        
        const blob = new Blob([csv], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `jobs_${year}_${month}.csv`;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        showNotification('CSV exported', 'success');
    }

    function closeModal(id) {
        const modal = document.getElementById(id);
        if (modal) modal.classList.remove('show');
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
        loadLocalConfig();
        
        // Initialize theme
        const savedTheme = localStorage.getItem('opsis_theme') || 'light';
        const themeSelectEl = document.getElementById('themeSelect');
        if (themeSelectEl) {
            themeSelectEl.value = savedTheme;
            themeSelectEl.addEventListener('change', () => {
                applyTheme(themeSelectEl.value);
            });
        }

        // Initialize company name
        const companyNameDisplay = document.getElementById('companyNameDisplay');
        const companyNameInput = document.getElementById('companyName');
        if (companyNameInput && companyNameDisplay) {
            const storedCompany = localStorage.getItem('cve_companyName') || companyNameInput.value || '';
            companyNameInput.value = storedCompany;
            companyNameDisplay.textContent = storedCompany;
            companyNameInput.addEventListener('input', () => {
                const name = companyNameInput.value.trim();
                localStorage.setItem('cve_companyName', name);
                companyNameDisplay.textContent = name;
            });
        }

        // User management buttons - FIXED
        const addUserBtn = document.getElementById('btnAddUser');
        if (addUserBtn) {
            addUserBtn.addEventListener('click', () => {
                openUserModal();
            });
        }
        
        const saveUserBtn = document.getElementById('btnSaveUser');
        if (saveUserBtn) {
            saveUserBtn.addEventListener('click', () => {
                saveUser();
            });
        }
        
        // Setup nav clicks
        document.querySelectorAll('.nav-icon').forEach(icon => {
            icon.addEventListener('click', () => {
                switchPage(icon.dataset.page);
            });
        });
        
        // Schedule subtabs
        document.querySelectorAll('#schedule .tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.subtab;
                switchSubtab('schedule', tab);
            });
        });
        
        // Staff subtabs
        document.querySelectorAll('#staff .tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.stafftab;
                switchSubtab('staff', tab);
            });
        });

        // Apply page-specific border colour
        const activeIcon = document.querySelector('.nav-icon.active');
        if (activeIcon) {
            const activePage = activeIcon.dataset.page;
            if (activePage) switchPage(activePage);
        }
        
        // Settings tabs
        document.querySelectorAll('#settings .tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.settingstab;
                switchSubtab('settings', tab);
            });
        });
        
        // FIXED: View mode buttons
        document.getElementById('viewSimple').addEventListener('click', () => {
            viewMode='simple';
            document.querySelectorAll('.search-view button').forEach(b => b.classList.remove('active'));
            document.getElementById('viewSimple').classList.add('active');
            renderJobsTable();
        });
        document.getElementById('viewExtended').addEventListener('click', () => {
            viewMode='extended';
            document.querySelectorAll('.search-view button').forEach(b => b.classList.remove('active'));
            document.getElementById('viewExtended').classList.add('active');
            renderJobsTable();
        });
        document.getElementById('viewComplete').addEventListener('click', () => {
            viewMode='complete';
            document.querySelectorAll('.search-view button').forEach(b => b.classList.remove('active'));
            document.getElementById('viewComplete').classList.add('active');
            renderJobsTable();
        });
        
        // Year/Month change
        $('#yearSelect').addEventListener('change', loadSchedule);
        $('#monthSelect').addEventListener('change', loadSchedule);
        
        // Search jobs
        $('#searchJobs').addEventListener('input', () => {
            const term = $('#searchJobs').value.trim().toLowerCase();
            if (!term) {renderJobsTable(); return;}
            const filtered = jobs.filter(job => {
                return Object.values(job).some(val => (val+'').toLowerCase().includes(term));
            });
            const oldJobs = jobs;
            jobs = filtered;
            renderJobsTable();
            jobs = oldJobs;
        });
        
        // Save columns
        $('#btnSaveColumns').addEventListener('click', async () => {
            saveLocalConfig();
            showNotification('Columns saved locally!','success');
        });
        
        // Add column
        $('#btnAddColumn').addEventListener('click', () => {
            $('#addColumnName').value = '';
            $('#addColumnType').value = 'text';
            $('#addColumnWidth').value = 120;
            $('#addColumnRequired').value = 'false';
            $('#addColumnVisible').value = 'true';
            $('#addColumnOptions').value = '';
            document.getElementById('addColumnOptionsContainer').style.display = 'none';
            document.getElementById('modalAddColumn').classList.add('show');
        });

        $('#addColumnType').addEventListener('change', () => {
            const val = $('#addColumnType').value;
            const cont = document.getElementById('addColumnOptionsContainer');
            cont.style.display = (val === 'dropdown' || val === 'multiselect') ? 'block' : 'none';
        });
        
        $('#btnSaveAddColumn').addEventListener('click', async () => {
            const name = $('#addColumnName').value.trim();
            if (!name) {
                showNotification('Enter column name','error');
                return;
            }
            const type = $('#addColumnType').value;
            const widthVal = $('#addColumnWidth').value || '120';
            const required = $('#addColumnRequired').value === 'true';
            const visible = $('#addColumnVisible').value === 'true';
            let options = [];
            if (type === 'dropdown' || type === 'multiselect') {
                options = $('#addColumnOptions').value.split('\n').map(o => o.trim()).filter(o => o);
            }
            const newCol = {
                id: columns.length ? Math.max(...columns.map(c => c.id)) + 1 : 1,
                name, 
                type, 
                width: widthVal + 'px', 
                required, 
                visible, 
                options
            };
            columns.push(newCol);
            renderColumnsTable();
            saveLocalConfig();
            document.getElementById('modalAddColumn').classList.remove('show');
            showNotification('Column added','success');
        });
        
        // Add job modal
        $('#btnAddJob').addEventListener('click', () => {
            openAddJobModal();
        });
        
        // Job form tab switching
        document.querySelectorAll('#modalAddJob [data-jobtab]').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.jobtab;
                document.querySelectorAll('#modalAddJob .jobtab').forEach(c => c.style.display='none');
                document.getElementById(tab).style.display='block';
                document.querySelectorAll('#modalAddJob [data-jobtab]').forEach(b => {
                    b.style.borderBottomColor='transparent';
                    b.style.color = '#374151';
                });
                btn.style.borderBottomColor='#3b82f6';
                btn.style.color='#3b82f6';
            });
        });
        
        // Save job
        $('#btnSaveJob').addEventListener('click', async () => {
            const form = document.getElementById('formAddJob');
            const data = Object.fromEntries(new FormData(form).entries());
            
            if (!data.job_number || !data.job_address || !data.date) {
                showNotification('Fill required fields','error');
                return;
            }
            
            const year = parseInt($('#yearSelect').value);
            const month = $('#monthSelect').value;
            
            if (editingRowId) {
                const updates = Object.assign({}, data);
                const res = await callAPI('updateJob', {rowId: editingRowId, updates: updates, year, month});
                if (res.success) {
                    addOperationLog('Update', data.job_number, 'Job updated');
                    showNotification('Job updated','success');
                    editingRowId = null;
                    editingRowIndex = null;
                    document.getElementById('modalAddJob').classList.remove('show');
                    loadSchedule();
                } else {
                    showNotification('Failed to update job','error');
                }
            } else {
                const res = await callAPI('createJob', {job:data, year, month});
                if (res.success) {
                    addOperationLog('Create', data.job_number, 'Job created');
                    showNotification('Job created','success');
                    document.getElementById('modalAddJob').classList.remove('show');
                    loadSchedule();
                } else {
                    showNotification('Failed to create job','error');
                }
            }
        });
        
        // Add supervisor & crew modals
        $('#btnAddSupervisor').addEventListener('click', () => {
            document.getElementById('formAddSupervisor').reset();
            document.getElementById('modalAddSupervisor').classList.add('show');
        });
        $('#btnAddCrew').addEventListener('click', () => {
            document.getElementById('formAddCrew').reset();
            document.getElementById('modalAddCrew').classList.add('show');
        });
        
        // Save supervisor
        $('#btnSaveSupervisor').addEventListener('click', async () => {
            const form = document.getElementById('formAddSupervisor');
            const data = Object.fromEntries(new FormData(form).entries());
            if (!data.employeeNumber || !data.fullName) {
                showNotification('Fill Employee # and Full Name','error');
                return;
            }
            const specials = [...form.elements['specialties'].selectedOptions].map(opt => opt.value);
            const staffObj = {
                employeeNumber: data.employeeNumber.trim(),
                fullName: data.fullName.trim(),
                role: 'SUPERVISOR',
                status: data.status,
                division: data.division,
                specialties: specials
            };
            const res = await callAPI('addStaff', {type:'supervisor', data: staffObj});
            if (res.success) {
                showNotification('Supervisor added','success');
                document.getElementById('modalAddSupervisor').classList.remove('show');
                loadSupervisors();
            } else {
                showNotification('Failed to add supervisor','error');
            }
        });
        
        // Save crew
        $('#btnSaveCrew').addEventListener('click', async () => {
            const form = document.getElementById('formAddCrew');
            const data = Object.fromEntries(new FormData(form).entries());
            if (!data.employeeNumber || !data.fullName) {
                showNotification('Fill Employee # and Full Name','error');
                return;
            }
            const specials = [...form.elements['specialties'].selectedOptions].map(opt => opt.value);
            const staffObj = {
                employeeNumber: data.employeeNumber.trim(),
                fullName: data.fullName.trim(),
                role: 'CREW',
                status: data.status,
                division: data.division,
                specialties: specials
            };
            const res = await callAPI('addStaff', {type:'crew', data: staffObj});
            if (res.success) {
                showNotification('Crew member added','success');
                document.getElementById('modalAddCrew').classList.remove('show');
                loadCrew();
            } else {
                showNotification('Failed to add crew member','error');
            }
        });
        
        // Add skill modal
        $('#btnAddSkill').addEventListener('click', () => {
            document.getElementById('modalAddSkill').classList.add('show');
        });
        $('#btnSaveSkill').addEventListener('click', async () => {
            showNotification('Skills feature coming soon','info');
            document.getElementById('modalAddSkill').classList.remove('show');
        });
        
        // Add certification modal
        $('#btnAddCertification').addEventListener('click', () => {
            loadCertificationEmployees();
            document.getElementById('modalAddCertification').classList.add('show');
        });
        
        $('#btnSaveCertification').addEventListener('click', async () => {
            const form = document.getElementById('formAddCertification');
            const data = Object.fromEntries(new FormData(form).entries());
            if (!data.employee || !data.certificationType || !data.issueDate || !data.expiryDate) {
                showNotification('Fill required fields','error');
                return;
            }
            
            const fileInput = document.getElementById('certFile');
            if (fileInput && fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];
                const base64 = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const result = e.target.result || '';
                        const b64 = result.split(',')[1] || '';
                        resolve(b64);
                    };
                    reader.readAsDataURL(file);
                });
                data.fileData = base64;
                data.fileName = file.name;
            }
            
            const empSelect = document.getElementById('certificationEmployee');
            data.employee_name = empSelect.options[empSelect.selectedIndex].text;
            data.employee_number = data.employee;
            delete data.employee;
            
            const res = await callAPI('addCertification', data);
            if (res.success) {
                showNotification('Certification added','success');
                document.getElementById('modalAddCertification').classList.remove('show');
                loadCertifications();
            } else {
                showNotification('Failed to add certification','error');
            }
        });

        // Certification filter
        const filterTypeSelect = document.getElementById('certFilterType');
        if (filterTypeSelect) {
            filterTypeSelect.addEventListener('change', () => {
                renderCertificationsTable();
            });
        }
        
        // Certification edit modal actions
        const btnUpdateCert = document.getElementById('btnUpdateCertification');
        if (btnUpdateCert) {
            btnUpdateCert.addEventListener('click', async () => {
                const form = document.getElementById('formEditCertification');
                const certId = form.certId.value;
                const updates = {
                    issue_date: form.issueDate.value,
                    expiry_date: form.expiryDate.value,
                    cert_number: form.certNumber.value,
                    notes: form.notes.value
                };
                const fileInput = document.getElementById('editCertFile');
                if (fileInput && fileInput.files && fileInput.files[0]) {
                    const file = fileInput.files[0];
                    const base64 = await new Promise(resolve => {
                        const reader = new FileReader();
                        reader.onload = e => {
                            const resData = e.target.result || '';
                            resolve(resData.split(',')[1] || '');
                        };
                        reader.readAsDataURL(file);
                    });
                    updates.file_data = base64;
                    updates.file_name = file.name;
                }
                const res = await callAPI('updateCertification', {id: certId, updates});
                if (res.success) {
                    showNotification('Certification updated','success');
                    const idx = certifications.findIndex(c => c.id === certId);
                    if (idx !== -1) {
                        Object.assign(certifications[idx], updates);
                    }
                    document.getElementById('modalEditCertification').classList.remove('show');
                    renderCertificationsTable();
                } else {
                    showNotification('Failed to update','error');
                }
            });
        }
        
        const btnDeleteCert = document.getElementById('btnDeleteCertification');
        if (btnDeleteCert) {
            btnDeleteCert.addEventListener('click', async () => {
                const form = document.getElementById('formEditCertification');
                const certId = form.certId.value;
                if (!confirm('Delete this certification?')) return;
                const res = await callAPI('deleteCertification', {id: certId});
                if (res.success) {
                    showNotification('Certification deleted','success');
                    certifications = certifications.filter(c => c.id !== certId);
                    document.getElementById('modalEditCertification').classList.remove('show');
                    renderCertificationsTable();
                } else {
                    showNotification('Failed to delete','error');
                }
            });
        }
        
        // Modal close buttons
        document.querySelectorAll('[data-close]').forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.dataset.close;
                document.getElementById(target).classList.remove('show');
            });
        });
        
        document.querySelectorAll('.close-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const modal = btn.closest('.modal');
                if (modal) modal.classList.remove('show');
            });
        });
        
        // Filter buttons
        $('#btnApplyFilters').addEventListener('click', async () => {
            showNotification('Advanced filters feature coming soon','info');
        });
        $('#btnClearFilters').addEventListener('click', () => {
            $('#filterDateFrom').value = '';
            $('#filterDateTo').value = '';
            $('#filterJobNumber').value = '';
            $('#filterPM').value = '';
            loadSchedule();
        });
        
        // Refresh data
        $('#btnRefresh').addEventListener('click', () => {
            refreshPage();
        });
        
        // Row action buttons
        const btnEditRow = document.getElementById('btnEditRow');
        const btnDuplicateRow = document.getElementById('btnDuplicateRow');
        const btnDeleteRow = document.getElementById('btnDeleteRow');
        if (btnEditRow) {
            btnEditRow.addEventListener('click', () => {
                editJobRow();
            });
        }
        if (btnDuplicateRow) {
            btnDuplicateRow.addEventListener('click', () => {
                duplicateJobRow();
            });
        }
        if (btnDeleteRow) {
            btnDeleteRow.addEventListener('click', () => {
                deleteJobRow();
            });
        }
        
        // Calendar navigation
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        if (prevMonthBtn) {
            prevMonthBtn.addEventListener('click', () => changeCalendarMonth(-1));
        }
        if (nextMonthBtn) {
            nextMonthBtn.addEventListener('click', () => changeCalendarMonth(1));
        }

        // Edit column save
        $('#btnSaveColumn').addEventListener('click', () => {
            const id = parseInt($('#editColumnId').value);
            const col = columns.find(c => c.id === id);
            if (!col) return;
            col.name = $('#editColumnName').value.trim();
            col.type = $('#editColumnType').value;
            col.width = $('#editColumnWidth').value + 'px';
            col.required = $('#editColumnRequired').value === 'true';
            if (col.type === 'dropdown' || col.type === 'multiselect') {
                const opts = $('#editColumnOptions').value.split('\n').map(o => o.trim()).filter(o => o);
                col.options = opts;
            } else {
                col.options = [];
            }
            col.description = $('#editColumnDescription').value;
            renderColumnsTable();
            document.getElementById('modalEditColumn').classList.remove('show');
            saveLocalConfig();
            renderJobsTable();
            showNotification('Column saved','success');
        });

        // Apply initial state
        switchPage('dashboard');
        loadSchedule();
        loadDashboard();
        loadStaff();
    });

    // Expose utility functions globally
    window.openAddJobModal = openAddJobModal;
    window.openScheduleFilters = openScheduleFilters;
    window.refreshPage = refreshPage;
    window.exportSchedule = exportSchedule;
    window.closeModal = closeModal;
    window.openUserModal = openUserModal;
    window.saveUser = saveUser;
    window.switchPage = switchPage;
    window.switchSubtab = switchSubtab;
</script>
</body>
</html>
