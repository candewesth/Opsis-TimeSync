<!DOCTYPE html>
<!-- saved from url=(0147)file:///private/var/folders/c3/drp7t6pj3s9_k5mk2pzzbmjr0000gn/T/remote-file-preview-E258FD49-3D55-44D8-84FF-EBA6A5692457/cve_sd_system_updated.html -->
<html lang="en" data-theme="light" style="--card: #ffffff; --card-hover: #f1f5f9; --text: #374151; --muted: #6b7280; --border: rgba(0,0,0,0.1); --modal-bg: #ffffff; --modal-text: #374151; --bg-dark-primary: #f7f9fc; --bg-dark-secondary: #e8edf5; --button-gradient-start: #4A90E2; --button-gradient-end: #357ABD; --gradient: linear-gradient(135deg, #4A90E2, #357ABD); --accent: #36bf6a; --module-border-color: #ff6b6b; --modal-border-color: #ff6b6b;"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opsis TimeSync â€“ Annual Management</title>
    <style>
        /* Import Inter font from Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        /* Base reset and font */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        /* Theme variables */
        :root {
            /* TimeSync Blue Theme */
            --timesync-primary: #4A90E2;
            --timesync-secondary: #357ABD;
            --timesync-gradient: linear-gradient(135deg, var(--timesync-primary), var(--timesync-secondary));
            /* Base colours and backgrounds for light mode */
            --bg: #f9fafb;
            --bg-dark-primary: #f9fafb;
            --bg-dark-secondary: #f3f4f6;
            /* Cards use solid light background by default */
            --card: #ffffff;
            --card-hover: #f9fafb;
            /* Text colours for light mode */
            --text: #1f2937;
            --muted: #6b7280;
            /* Border colour for light mode */
            --border: #e5e7eb;
            --accent: var(--timesync-primary);
            /* Brand colours */
            --brand-primary: #495057;
            --brand-secondary: #6c757d;
            /* States */
            --success: #20c997;
            --warning: #ffc107;
            --error: #dc3545;
            /* Typography */
            --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            /* Geometry and premium design (do not modify) */
            --border-radius-xl: 32px;
            --border-radius-lg: 24px;
            --border-radius-md: 16px;
            --card-padding: 3rem 2.5rem;
            --transition-smooth: 0.4s ease;
            /* Primary palette mapping */
            --primary: var(--timesync-primary);
            --secondary: var(--timesync-secondary);
            --gradient: var(--timesync-gradient);
            /* Card and hover effects */
            --card-radius: var(--border-radius-xl);
            --hover-lift: -15px;
            --card-shadow-y: 25px;
            /* Modal and button customization variables */
            --modal-bg: var(--card);
            --modal-text: var(--text);
            --modal-radius: 24px;
            --button-gradient-start: var(--timesync-primary);
            --button-gradient-end: var(--timesync-secondary);
            --button-radius: 16px;
            /* Use the animated logo gradient colours for modal and module borders */
            /* Define border colours for each page (taken from logo gradient) */
            --dashboard-border: #ff6b6b;
            --schedule-border: #4ecdc4;
            --staff-border: #45b7d1;
            --reports-border: #5f27cd;
            --users-border: #ff9f43;
            --settings-border: #ee5a6f;
            /* Current page border colour for modules and modals (updated via JS) */
            --module-border-color: var(--dashboard-border);
            --modal-border-color: var(--dashboard-border);
        }
        :root[data-theme="dark"] {
            /* Dark theme uses same palette as default for TimeSync */
            --bg: #1d1d1f;
            --card: rgba(255,255,255,0.05);
            --text: #e5e7eb;
            --muted: #9ca3af;
            --border: rgba(255,255,255,0.1);
            --accent: var(--timesync-primary);
        }

        html, body {
            margin: 0;
            padding: 0;
            font-family: var(--font);
            background: linear-gradient(135deg, var(--bg-dark-primary) 0%, var(--bg-dark-secondary) 100%);
            font-size: 14px;
            color: var(--text);
            position: relative;
            min-height: 100vh;
        }
        a {
            color: inherit;
            text-decoration: none;
        }
        button {
            font-family: inherit;
        }
        /* Layout */
        .app {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        .sidebar {
            width: 52px;
            /* Use a light background with subtle border for a clean, minimal look */
            background: #f8fafc;
            color: #374151;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Leave space at the top for the header bar so icons sit lower.
               Increase the top padding to move the navigation icons further down, ensuring
               clear separation between the header bar and the sidebar items. */
            padding: 100px 0 12px;
            border-right: 1px solid #e5e7eb;
        }
        .sidebar .logo {
            font-size: 24px;
            margin-bottom: 24px;
        }

        /* Position the small logo at the top of the sidebar */
        .sidebar .nav-logo-container.nav-logo-small {
            margin-bottom: 24px;
        }
        .sidebar .nav-icon {
            width: 100%;
            padding: 10px 0;
            display: flex;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: background .2s, color .2s;
        }
        .sidebar .nav-icon.active {
            background: #e2e8f0;
            color: var(--timesync-primary);
        }
        .sidebar .nav-icon:hover {
            background: #f1f5f9;
        }
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .header {
            background: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header .title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }
        .header .status {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .header .status span {
            font-size: 18px;
        }
        .content {
            flex: 1;
            display: none;
            overflow: auto;
        }
        .content.active {
            display: block;
        }
        /* Navigation tabs */
        .tabs {
            display: flex;
            gap: 0;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 16px;
        }
        .tabs button {
            appearance: none;
            background: none;
            border: none;
            padding: 12px 20px;
            font-size: 13px;
            cursor: pointer;
            color: #6b7280;
            border-bottom: 2px solid transparent;
        }
        .tabs button.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            font-weight: 600;
        }
        .tabs button:hover {
            background: #f9fafb;
        }
        /* Cards and metrics */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        .card {
            background: var(--card);
            border-radius: var(--card-radius);
            box-shadow: 0 var(--card-shadow-y) calc(var(--card-shadow-y) * 2) rgba(0,0,0,0.1);
            padding: var(--card-padding);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            /* Use page-specific border colour */
            border: 2px solid var(--module-border-color);
            color: var(--text);
        }

        /* Hover effects for cards (appearance customization) */
        .card:hover {
            /* Remove upward translation on hover to avoid modules shifting */
            box-shadow: 0 calc(var(--card-shadow-y) * 2) calc(var(--card-shadow-y) * 4) rgba(0,0,0,0.15);
        }
        .card h3 {
            margin: 0 0 4px;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
        }
        .card .value {
            font-size: 28px;
            font-weight: 700;
            color: #111827;
        }
        .card .subtext {
            font-size: 11px;
            color: #6b7280;
        }

        /* Override card layout inside settings to allow all form fields to be visible */
        #settings .card {
            display: block;
        }
        /* Tables */
        .table-container {
            background: var(--card);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-bottom: 24px;
            border: 1px solid var(--border);
            color: var(--text);
        }
        .table-container .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            color: var(--text);
            font-size: 13px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        thead tr {
            background: #f9fafb;
        }
        th, td {
            padding: 8px 12px;
            text-align: left;
        }
        th {
            font-size: 11px;
            color: #6b7280;
            text-transform: uppercase;
            border-bottom: 1px solid #e5e7eb;
        }
        tbody tr:hover {
            background: #f3f4f6;
        }
        .empty {
            text-align: center;
            padding: 40px 0;
            color: #9ca3af;
        }
        /* Forms & inputs */
        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 16px;
        }
        .form-group label {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #374151;
        }
        .form-group .required {
            color: #ef4444;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 13px;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
        }
        /* Buttons */
        .btn {
            appearance: none;
            border: 1px solid #d1d5db;
            /* Use customizable button radius */
            border-radius: var(--button-radius);
            padding: 6px 16px;
            font-size: 13px;
            cursor: pointer;
            background: white;
            transition: background .2s;
        }
        .btn:hover {
            background: #f9fafb;
        }
        .btn.primary {
        /* Use customizable gradient colours for primary buttons */
        /* Premium primary button: use gradient and generous padding */
        background: linear-gradient(135deg, var(--button-gradient-start), var(--button-gradient-end));
        color: white;
        border: none;
        padding: 1rem 2rem;
        font-weight: 600;
        border-radius: var(--button-radius);
        }
        .btn.primary:hover {
        /* Darken the gradient on hover using button gradient variables */
        background: linear-gradient(135deg,
            color-mix(in srgb, var(--button-gradient-start) 90%, black 10%),
            color-mix(in srgb, var(--button-gradient-end) 90%, black 10%));
        /* Lift the button slightly and add a shadow for premium feel */
        transform: translateY(-3px);
        box-shadow: 0 15px 40px rgba(74, 144, 226, 0.4);
        }
        .btn.danger {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }
        .btn.danger:hover {
            background: #dc2626;
        }
        .btn.small {
            padding: 4px 8px;
            font-size: 11px;
        }
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-dialog {
            /* Use modal variables and apply coloured border from logo */
            background: var(--modal-bg);
            color: var(--modal-text);
            border-radius: var(--modal-radius);
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            /* Border uses page-specific colour */
            border: 2px solid var(--modal-border-color);
        }
        .modal-header,
        .modal-footer {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-footer {
            border-top: 1px solid #e5e7eb;
        }
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            /* Use modal text colour */
            color: var(--modal-text);
        }
        .modal-body {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }
        .close-btn {
            appearance: none;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }
        .close-btn:hover {
            color: #374151;
        }
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            border-radius: 6px;
            color: white;
            display: flex;
            gap: 8px;
            z-index: 1050;
            animation: fadein .3s;
        }
        .notification.success {background: #10b981;}
        .notification.error {background: #ef4444;}
        .notification.info {background: #3b82f6;}
        .notification.warning {background: #f59e0b;}
        @keyframes fadein {
            from {opacity: 0; transform: translateX(100px);} to {opacity: 1; transform: translateX(0);}
        }

        /* Logo and premium header styles */
        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .nav-logo-container {
            width: 54px;
            height: 54px;
            border-radius: 14px;
            padding: 2px;
            background: linear-gradient(45deg,
                #ff6b6b, #4ecdc4, #45b7d1, #96ceb4,
                #feca57, #ff9ff3, #54a0ff, #5f27cd,
                #00d2d3, #ff9f43, #10ac84, #ee5a6f);
            background-size: 400% 400%;
            animation: gradientShift 4s ease-in-out infinite;
            display: inline-flex;
            justify-content: center;
            align-items: center;
        }

        /* Smaller logo used in the sidebar */
        .nav-logo-container.nav-logo-small {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            padding: 2px;
        }

        .nav-logo-container.nav-logo-small .nav-logo {
            width: 38px;
            height: 38px;
            border-radius: 8px;
        }
        .nav-logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        .nav-logo::after {
            content: 'â—‰';
            font-size: 24px;
            color: white;
            animation: winkEye 4s ease-in-out infinite;
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            25% { background-position: 100% 50%; }
            50% { background-position: 100% 100%; }
            75% { background-position: 0% 100%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes winkEye {
            0%, 85% { transform: scaleY(1); }
            88% { transform: scaleY(0.1); }
            92% { transform: scaleY(1); }
            94% { transform: scaleY(0.1); }
            97% { transform: scaleY(1); }
            100% { transform: scaleY(1); }
        }
        .brand-group {
            display: flex;
            flex-direction: column;
            margin-left: 12px;
        }
        .brand-text {
            font-size: 1.5rem;
            font-weight: 700;
            /* Use a neutral gray for the Opsis name so it remains legible on a light background */
            color: var(--brand-primary);
        }

        /* Company name displayed below the brand text */
        .company-name {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--muted);
            margin-top: 2px;
        }
        .module-name {
            font-weight: 400;
            background: var(--timesync-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        /* Premium header styling */
        .header {
            /* Light, minimal header similar to Apple style */
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
        }
        .status {
            color: var(--muted);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Background system with grid and radial highlights */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: -2;
        }
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 20%, rgba(74, 144, 226, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(53, 122, 189, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 20% 80%, rgba(74, 144, 226, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(53, 122, 189, 0.1) 0%, transparent 50%);
            z-index: -1;
        }

        /* Updated card styles for premium design */
        .card {
            background: var(--card);
            /* Use page-specific border colour */
            border: 2px solid var(--module-border-color);
            border-radius: var(--border-radius-xl);
            padding: var(--card-padding);
            backdrop-filter: blur(20px);
            transition: all var(--transition-smooth);
            color: var(--text);
        }
        .card:hover {
            background: var(--card-hover);
            /* Remove upward translation on hover to avoid modules shifting */
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
        }

        /*
         * Primary button styles are defined earlier using the variables
         * --button-gradient-start, --button-gradient-end, --button-radius, etc.
         * Duplicate definitions removed to avoid conflicts.
         */

        /* Reports dashboard styles */
        .reports-container {
            padding: 24px;
        }
        .reports-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(6px);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .reports-header .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        .reports-header select,
        .reports-header input {
            padding: 4px 8px;
            font-size: 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: white;
            min-width: 120px;
        }
        .reports-header .btn {
            padding: 4px 8px;
            font-size: 12px;
        }
        .reports-header .last-sync {
            font-size: 11px;
            color: #6b7280;
            margin-top: 8px;
        }
        .reports-kpis {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .report-card {
            background: var(--card);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 12px;
            /* Use the page-specific module border colour on report cards */
            border: 2px solid var(--module-border-color);
            color: var(--text);
        }
        .report-card .title {
            font-size: 10px;
            font-weight: 600;
            color: var(--muted);
            margin-bottom: 6px;
            text-transform: uppercase;
        }
        .report-card .value {
            font-size: 22px;
            font-weight: 700;
            color: var(--text);
        }

        /* Page-specific card backgrounds for improved contrast on light theme */
        #dashboard .card {
            /* Light fill for dashboard modules to contrast with coloured borders */
            background: #ffffff;
            color: #374151;
        }
        #dashboard .card:hover {
            background: #f9fafb;
        }

        /* Staff page: ensure modal border thickness appears uniform on all sides */
        #staff .modal-dialog,
        #staffManagement .modal-dialog {
            border-width: 2px;
            border-style: solid;
            border-color: var(--modal-border-color);
        }
        .report-card .subtext {
            font-size: 10px;
            color: var(--muted);
            margin-top: 4px;
        }
        .report-card .progress-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            width: 100%;
            margin-top: 4px;
        }
        .report-card .progress-bar div {
            height: 100%;
            background: #3b82f6;
            width: 0%;
        }
        .reports-panels {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .report-panel {
            background: var(--card);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            padding: 16px;
            flex: 1;
            min-width: 220px;
            /* Use page-specific module border colour for report panels */
            border: 2px solid var(--module-border-color);
            color: var(--text);
        }
        .report-panel h3 {
            margin-top: 0;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
        }
        .status-row,
        .worker-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 6px;
        }
        .status-row .bar,
        .worker-row .bar {
            height: 6px;
            border-radius: 3px;
            margin-left: 6px;
            margin-right: 6px;
            flex: 1;
        }
        .reports-trends h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #374151;
        }
        #jobsTrendList {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .trend-item {
            flex: 1;
            min-width: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
            color: #374151;
        }
        .trend-item .bar-container {
            width: 100%;
            height: 40px;
            background: #e5e7eb;
            border-radius: 4px;
            position: relative;
            margin-bottom: 4px;
            overflow: hidden;
        }
        .trend-item .bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #3b82f6;
            border-radius: 4px 4px 0 0;
        }
        .reports-table h3 {
            margin-top: 0;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
        }

        /* Additional report dashboard styles */
        .reports-panels-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .donut-chart {
            position: relative;
            width: 140px;
            height: 140px;
            border-radius: 50%;
            margin: 0 auto;
        }
        .donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            box-shadow: 0 0 0 2px #e5e7eb;
        }
        .legend {
            margin-top: 12px;
            font-size: 10px;
        }
        .legend .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            cursor: pointer;
        }
        .legend .legend-item:hover {
            text-decoration: underline;
        }
        .legend .color-box {
            display: inline-block;
            width: 8px;
            height: 8px;
            margin-right: 6px;
            border-radius: 2px;
        }
        .report-summary {
            font-size: 12px;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        .bar-container {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            margin-bottom: 6px;
            overflow: hidden;
        }
        .bar-fill {
            height: 100%;
            background: #3b82f6;
            border-radius: 3px;
        }
        .week-item {
            font-size: 12px;
            margin-bottom: 6px;
        }
        .week-item .bar-container {
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
        }
        .week-item .bar-fill {
            height: 100%;
            background: #3b82f6;
            border-radius: 3px;
        }
        .alert-item {
            font-size: 12px;
            margin-bottom: 4px;
        }
        .alert-item .badge {
            padding: 1px 4px;
            border-radius: 4px;
            font-size: 10px;
            margin-left: 4px;
            background: #f3f4f6;
        }
        .alert-critical {
            color: #991b1b;
        }
        .alert-warning {
            color: #92400e;
        }
        .alert-ok {
            color: #065f46;
        }
    
        /*
         * Custom schedule modules and mini calendar definitions added for enhanced functionality
         */
        .schedule-modules {
            /* Layout for Schedule summary modules in a single horizontal row */
            display: flex;
            flex-wrap: nowrap;
            justify-content: center;
            gap: 16px;
            margin-bottom: 16px;
            overflow-x: auto;
            /* Remove max-width constraint to allow full width */
            margin-left: 0;
            margin-right: 0;
        }
        /* Each card inside the schedule modules shares space equally but has a minimum width */
        .schedule-modules > .card {
            flex: 1 0 240px;
        }
        .search-card {
            /* A search card with only a coloured border */
            border: 2px solid var(--accent);
            background: transparent;
            color: var(--text);
        }
        .search-card h3 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
        }
        .search-card input {
            border: 1px solid #d1d5db;
            background: #ffffff;
            color: #374151;
            width: 100%;
            padding: 6px 8px;
            border-radius: 4px;
        }
        .search-card input::placeholder {
            color: #9ca3af;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 11px;
            color: #374151;
        }
        .calendar-header button {
            width: 22px;
            height: 22px;
            border: 1px solid #e5e7eb;
            background: #ffffff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .calendar-header button:hover {
            background: #f9fafb;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e5e7eb;
            padding: 1px;
            border-radius: 4px;
        }
        .calendar-grid .day-header {
            font-size: 8px;
            font-weight: 600;
            color: #9ca3af;
            text-align: center;
            padding: 2px 0;
            background: #ffffff;
        }
        .calendar-grid .day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #374151;
            background: #ffffff;
            cursor: pointer;
            position: relative;
        }
        .calendar-grid .day:hover {
            background: #f3f4f6;
        }
        .calendar-grid .other-month {
            color: #d1d5db;
            background: #fafafa;
        }
        .calendar-grid .today {
            background: #3b82f6;
            color: #ffffff;
            font-weight: 600;
        }
        .calendar-grid .selected {
            border: 2px solid #3b82f6;
            box-sizing: border-box;
        }
        .calendar-grid .has-jobs::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 3px;
            height: 3px;
            background: #ef4444;
            border-radius: 50%;
        }
        .stats-list div,
        .positions-list div,
        .specialties-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            font-size: 11px;
            color: #374151;
        }
        .stats-list span,
        .positions-list span,
        .specialties-list span {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }
        .specialties-list {
            list-style: none;
            padding-left: 0;
            margin-top: 4px;
        }
        .specialties-list li {
            font-size: 11px;
            color: #374151;
        }
        .row-actions-card h3 {
            margin-top: 0;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }
        .row-actions-card button {
            display: block;
            width: 100%;
            margin-bottom: 6px;
            font-size: 11px;
        }
        .row-actions-card .log-entry {
            font-size: 10px;
            color: #6b7280;
            margin-bottom: 2px;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #d1d5db;
            transition: .4s;
            border-radius: 20px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: #ffffff;
            transition: .4s;
            border-radius: 50%;
        }
        .switch input:checked + .slider {
            background-color: #3b82f6;
        }
        .switch input:checked + .slider:before {
            transform: translateX(14px);
        }

        /* Additional custom styles injected for new modules and improvements */
        
        /* Enlarge numbers in the statistics card */
        .stats-card .stats-list span {
            font-size: 16px;
            font-weight: 700;
        }

        /* Slider switch style for column visibility toggles */
        .switch {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .4s;
            border-radius: 34px;
        }
        .slider::before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        .switch input:checked + .slider {
            background-color: #10b981;
        }
        .switch input:checked + .slider::before {
            transform: translateX(16px);
        }

        /* Certification status colors for expiry highlighting */
        .cert-status-critical {
            background: #fee2e2;
        }
        .cert-status-warning {
            background: #fef3c7;
        }
        .cert-status-ok {
            background: #ecfdf5;
        }
    </style>
</head>
<body>
<div id="app" class="app">
    <!-- Sidebar navigation -->
    <div class="sidebar">
        <!-- The logo has been moved to the top left of the header; no separate logo in the sidebar -->
        <div class="nav-icon active" data-page="dashboard" title="Dashboard" onclick="switchPage(&#39;dashboard&#39;)">ðŸ“Š</div>
        <div class="nav-icon" data-page="schedule" title="Schedule" onclick="switchPage(&#39;schedule&#39;)">ðŸ“</div>
        <div class="nav-icon" data-page="staff" title="Staff" onclick="switchPage(&#39;staff&#39;)">ðŸ‘¥</div>
        <div class="nav-icon" data-page="reports" title="Reports" onclick="switchPage(&#39;reports&#39;)">ðŸ“ˆ</div>
        <div class="nav-icon" data-page="users" title="Users" onclick="switchPage(&#39;users&#39;)">ðŸ‘¤</div>
        <div class="nav-icon" data-page="settings" title="Settings" onclick="switchPage(&#39;settings&#39;)">âš™ï¸</div>
    </div>
    <!-- Main content -->
    <div class="main">
        <header class="header">
            <div class="header-left">
                <!-- Animated Opsis logo anchored to the dashboard -->
                <a href="file:///private/var/folders/c3/drp7t6pj3s9_k5mk2pzzbmjr0000gn/T/remote-file-preview-E258FD49-3D55-44D8-84FF-EBA6A5692457/cve_sd_system_updated.html#" onclick="switchPage(&#39;dashboard&#39;)" title="Dashboard" class="header-logo">
                    <div class="nav-logo-container">
                        <div class="nav-logo"></div>
                    </div>
                </a>
                <!-- Brand name and company displayed to the right of the logo -->
                <div class="brand-group">
                    <span class="brand-text">Opsis <span class="module-name">TimeSync</span></span>
                    <span id="companyNameDisplay" class="company-name">CVE San Diego</span>
                </div>
            </div>
            <div class="status" id="connectionIndicator">ðŸ“Š Disconnected</div>
        </header>
        <!-- Dashboard Page -->
        <div id="dashboard" class="content active">
            <div class="page-body" style="padding: 24px;">
                <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">Dashboard Overview</h2>
                <div class="metrics-grid">
                    <div class="card">
                        <h3>Total Jobs</h3>
                        <div class="value" id="dashTotalJobs">0</div>
                        <div class="subtext">Active jobs</div>
                    </div>
                    <div class="card">
                        <h3>Active Crew</h3>
                        <div class="value" id="dashActiveCrew">0/0</div>
                        <div class="subtext">Staff utilization</div>
                    </div>
                    <div class="card">
                        <h3>Pending Jobs</h3>
                        <div class="value" id="dashPendingJobs">0</div>
                        <div class="subtext">Awaiting assignment</div>
                    </div>
                    <div class="card">
                        <h3>Efficiency</h3>
                        <div class="value" id="dashEfficiency">0%</div>
                        <div class="subtext">Completion rate</div>
                    </div>
                </div>
                <!-- Charts -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px;">
                    <div class="card" style="height: 260px;">
                        <h3 style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px;">Monthly Performance</h3>
                        <div id="chartPerformance" style="height: 200px; display: flex; align-items: center; justify-content: center; color: #9ca3af;">
                            Connect to API to display chart
                        </div>
                    </div>
                    <div class="card" style="height: 260px;">
                        <h3 style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px;">Job Status</h3>
                        <div id="chartStatus" style="height: 200px; display: flex; align-items: center; justify-content: center; color: #9ca3af;">
                            Connect to API to display chart
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Schedule Page -->
        <div id="schedule" class="content">
            <div class="page-body" style="padding: 24px; display: flex; flex-direction: column; height: 100%;">
                <!-- Tabs within Schedule -->
                <div class="tabs">
                    <button class="tab-btn active" data-subtab="jobs" onclick="switchSubtab(&#39;schedule&#39;,&#39;jobs&#39;)">Schedule</button>
                    <button class="tab-btn" data-subtab="columns" onclick="switchSubtab(&#39;schedule&#39;,&#39;columns&#39;)">Column Manager</button>
                    <button class="tab-btn" data-subtab="filters" onclick="switchSubtab(&#39;schedule&#39;,&#39;filters&#39;)">Filters</button>
                </div>
                <!-- Subtab: Jobs -->
                <div id="jobs" class="subtab-content" style="flex:1; display: flex; flex-direction: column;">
                    <!-- Actions Bar -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div>
                            <button class="btn primary" id="btnAddJob" onclick="openAddJobModal()">âž• Add Job</button>
                            <button class="btn" id="btnAdvancedFilters" onclick="openScheduleFilters()">ðŸ“Š Filters</button>
                            <button class="btn" id="btnRefresh" onclick="refreshPage()">â†» Refresh</button>
                            <button class="btn" id="btnExport" onclick="exportSchedule()">ðŸ“¥ Export CSV</button>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label for="yearSelect">Year:</label>
                            <select id="yearSelect" class="form-control" style="padding:4px 8px;">
                                <option value="2025" selected="">2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                            </select>
                            <label for="monthSelect">Month:</label>
                            <select id="monthSelect" class="form-control" style="padding:4px 8px;">
                                <option value="January">January</option>
                                <option value="February">February</option>
                                <option value="March">March</option>
                                <option value="April">April</option>
                                <option value="May">May</option>
                                <option value="June">June</option>
                                <option value="July">July</option>
                                <option value="August">August</option>
                                <option value="September" selected="">September</option>
                                <option value="October">October</option>
                                <option value="November">November</option>
                                <option value="December">December</option>
                            </select>
                        </div>
                    </div>
                    <!-- Stats & Filters Section -->
                    <div class="schedule-modules">
                        <div class="card search-card">
                            <div class="search-top">
                                <h3>Search Jobs</h3>
                                <input type="text" id="searchJobs" placeholder="Job #, Address, Supervisor...">
                            </div>
                            <div class="search-view" style="margin-top: 8px; display:flex; gap:4px;">
                                <button class="btn small" id="viewSimple">Simple</button>
                                <button class="btn small" id="viewExtended">Extended</button>
                                <button class="btn small active" id="viewComplete">Complete</button>
                            </div>
                        </div>
                        <div class="card calendar-card">
                            <div class="calendar-header">
                                <button id="prevMonth">â—€</button>
                                <span id="calendarMonth">September 2025</span>
                                <button id="nextMonth">â–¶</button>
                            </div>
                            <div id="miniCalendar" class="calendar-grid"><div class="day-header">S</div><div class="day-header">M</div><div class="day-header">T</div><div class="day-header">W</div><div class="day-header">T</div><div class="day-header">F</div><div class="day-header">S</div><div class="day other-month"></div><div class="day" data-date="2025-09-01">1</div><div class="day" data-date="2025-09-02">2</div><div class="day" data-date="2025-09-03">3</div><div class="day" data-date="2025-09-04">4</div><div class="day" data-date="2025-09-05">5</div><div class="day" data-date="2025-09-06">6</div><div class="day" data-date="2025-09-07">7</div><div class="day" data-date="2025-09-08">8</div><div class="day" data-date="2025-09-09">9</div><div class="day" data-date="2025-09-10">10</div><div class="day" data-date="2025-09-11">11</div><div class="day" data-date="2025-09-12">12</div><div class="day" data-date="2025-09-13">13</div><div class="day" data-date="2025-09-14">14</div><div class="day" data-date="2025-09-15">15</div><div class="day" data-date="2025-09-16">16</div><div class="day" data-date="2025-09-17">17</div><div class="day" data-date="2025-09-18">18</div><div class="day" data-date="2025-09-19">19</div><div class="day" data-date="2025-09-20">20</div><div class="day" data-date="2025-09-21">21</div><div class="day" data-date="2025-09-22">22</div><div class="day" data-date="2025-09-23">23</div><div class="day" data-date="2025-09-24">24</div><div class="day" data-date="2025-09-25">25</div><div class="day" data-date="2025-09-26">26</div><div class="day" data-date="2025-09-27">27</div><div class="day" data-date="2025-09-28">28</div><div class="day" data-date="2025-09-29">29</div><div class="day" data-date="2025-09-30">30</div><div class="day other-month"></div><div class="day other-month"></div><div class="day other-month"></div><div class="day other-month"></div></div>
                            <div style="margin-top: 6px; font-size: 10px; color:#6b7280; text-align: center;">Select a date</div>
                        </div>
                        <div class="card stats-card">
                            <h3>Statistics</h3>
                            <div class="stats-list">
                                <div>Supervisors Available: <span id="statSupAvail">0/0</span></div>
                                <div>Workers Available: <span id="statCrewAvail">0/0</span></div>
                                <div>Jobs (Day/Week): <span id="statToday">0</span>/<span id="statWeek">0</span></div>
                            </div>
                        </div>
                        <!-- Status Counts Module -->
                        <div class="card status-card">
                            <h3>Status Counts</h3>
                            <ul class="specialties-list" style="margin-top:4px;">
                                <li>Job: <span id="countJOB">0 (0)</span></li>
                                <li>Repair: <span id="countREPAIR">0 (0)</span></li>
                                <li>Teardown: <span id="countTEARDOWN">0 (0)</span></li>
                                <li>Pick Up EQ: <span id="countPICK_UP_EQ">0 (0)</span></li>
                                <li>Class: <span id="countCLASS">0 (0)</span></li>
                                <li>Medical: <span id="countMEDICAL">0 (0)</span></li>
                                <li>Vacation: <span id="countVACATION">0 (0)</span></li>
                                <li>Go Back: <span id="countGO_BACK">0 (0)</span></li>
                                <li>Light Duty: <span id="countLIGHT_DUTY">0 (0)</span></li>
                            </ul>
                        </div>
                        <div class="card positions-card">
                            <h3>Positions</h3>
                            <div class="positions-list">
                                <div>Regular: <span id="countREGULAR">0 (0)</span></div>
                                <div>State: <span id="countSTATE">0 (0)</span></div>
                                <div>Federal: <span id="countFEDERAL">0 (0)</span></div>
                            </div>
                        </div>
                        <div class="card specialties-card" id="specialtiesSup">
                            <h3>Supervisors Specialties</h3>
                            <ul class="specialties-list">
                                <li>Asbestos: <span id="supAsbestosCount">0/0</span></li>
                                <li>Lead: <span id="supLeadCount">0/0</span></li>
                                <li>Mold: <span id="supMoldCount">0/0</span></li>
                                <li>Bio Haz: <span id="supBioCount">0/0</span></li>
                                <li>Bacteria: <span id="supBacteriaCount">0/0</span></li>
                                <li>Contents: <span id="supContentsCount">0/0</span></li>
                                <li>Duct Cleaning: <span id="supDuctCount">0/0</span></li>
                                <li>Drivers: <span id="supDriversCount">0/0</span></li>
                            </ul>
                        </div>
                        <div class="card specialties-card" id="specialtiesCrew">
                            <h3>Crew Specialties</h3>
                            <ul class="specialties-list">
                                <li>Asbestos: <span id="crewAsbestosCount">0/0</span></li>
                                <li>Lead: <span id="crewLeadCount">0/0</span></li>
                                <li>Mold: <span id="crewMoldCount">0/0</span></li>
                                <li>Bio Haz: <span id="crewBioCount">0/0</span></li>
                                <li>Bacteria: <span id="crewBacteriaCount">0/0</span></li>
                                <li>Contents: <span id="crewContentsCount">0/0</span></li>
                                <li>Duct Cleaning: <span id="crewDuctCount">0/0</span></li>
                                <li>Drivers: <span id="crewDriversCount">0/0</span></li>
                            </ul>
                        </div>
                    </div>
<!-- Jobs Table -->
<div class="data-wrapper" style="display:flex; gap:16px; align-items:flex-start;">
    <div class="table-container" style="flex:1; display:flex; flex-direction:column;">
        <div class="table-header">
            <span id="jobsTitle">September 2025 Jobs</span>
            <span style="font-size: 11px; color: #6b7280;">
                <span id="jobCount">0</span> record(s)
            </span>
        </div>
        <div style="flex:1; overflow:auto;">
            <table id="jobsTable">
                <thead><tr id="jobsTableHead"><th>Date</th><th>Job Number</th><th>Time</th><th>PM</th><th>Supervisor</th><th>Crew</th><th>Job Address</th><th>Status</th><th>Progress</th><th>Position</th><th>Location</th><th>Disposal</th><th>Manifest</th><th>Notified</th><th>OSHA</th><th>MP Total</th><th>MP Used</th><th>MP Active</th><th>Change Order</th><th>Scheduled</th><th>Folder</th><th>Hotel</th><th>Call Off</th><th>Notes</th><th>Manifest Notes</th><th>Manifest Number</th><th>Generator ID</th><th>Survey</th><th>Contract</th><th>Manifest Returned</th><th>Samples Returned</th></tr></thead>
                <tbody id="jobsTableBody"><tr><td colspan="31" class="empty">No jobs found</td></tr></tbody>
            </table>
        </div>
    </div>
    <div id="rowActionsCard" class="card row-actions-card" style="width:240px;">
        <h3>Row Actions</h3>
        <div id="selectedJobInfo" style="font-size:11px; color:#6b7280; margin-bottom:8px;">Select a row</div>
        <button class="btn small primary" id="btnEditRow" disabled="">Edit</button>
        <button class="btn small" id="btnDuplicateRow" disabled="">Duplicate</button>
        <button class="btn small danger" id="btnDeleteRow" disabled="">Delete</button>
        <div style="font-size: 10px; color:#374151; margin-top:8px;">Log</div>
        <div id="operationsLog" style="max-height:120px; overflow:auto; font-size:10px; color:#6b7280;"></div>
    </div>
</div>

<!-- User Modal -->
<div class="modal" id="modalUser">
    <div class="modal-dialog" style="max-width:500px;">
        <div class="modal-header">
            <h2 class="modal-title">Add User</h2>
            <button class="close-btn" onclick="closeModal(&#39;modalUser&#39;)">Ã—</button>
        </div>
        <div class="modal-body">
            <form id="formUser">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="userUsername" class="form-control" required="">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="userPassword" class="form-control" required="">
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="userRole" class="form-control">
                        <option value="ADMIN">ADMIN</option>
                        <option value="MANAGER">MANAGER</option>
                        <option value="USER">USER</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Active</label>
                    <select id="userActive" class="form-control">
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeModal(&#39;modalUser&#39;)">Cancel</button>
            <button class="btn primary" id="btnSaveUser" onclick="saveUser()" data-bound="1">Save User</button>
        </div>
    </div>
</div>

                </div>
                <!-- Subtab: Column Manager -->
                <div id="columns" class="subtab-content" style="display: none; overflow:auto;">
                    <div class="table-container" style="margin-bottom: 24px;">
                        <div class="table-header">Column Manager</div>
                        <div style="padding:16px; background:white;">
                            <div style="margin-bottom:12px; font-size:12px; color:#374151;">
                                Configure visibility, widths, and options for each column. Changes are stored locally and can be synced with the sheet.
                            </div>
                            <div style="margin-bottom: 8px;">
                                <button class="btn" id="btnAddColumn">âž• Add Column</button>
                                <button class="btn" id="btnSaveColumns">ðŸ’¾ Save All</button>
                            </div>
                            <table style="width:100%; border-collapse:collapse; font-size:11px;">
                                <thead>
                                    <tr style="background:#f9fafb;">
                                        <th>#</th>
                                        <th>Visible</th>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Required</th>
                                        <th>Width</th>
                                        <th>Options</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="columnsTableBody">
                                    <tr><td colspan="8" class="empty">Loading columns...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- Subtab: Filters -->
                <div id="filters" class="subtab-content" style="display: none; overflow:auto;">
                    <div class="card" style="margin-bottom: 24px;">
                        <h3 style="font-size: 16px; font-weight:600; margin-bottom:16px;">Advanced Filters</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Date From</label>
                                <input type="date" id="filterDateFrom" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Date To</label>
                                <input type="date" id="filterDateTo" class="form-control">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Job Number</label>
                                <input type="text" id="filterJobNumber" class="form-control" placeholder="Job #">
                            </div>
                            <div class="form-group">
                                <label>PM / Estimator</label>
                                <select id="filterPM" class="form-control">
                                    <option value="">All</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Position</label>
                                <select id="filterPosition" class="form-control">
                                    <option value="">All</option>
                                    <option value="REGULAR">Regular</option>
                                    <option value="STATE">State</option>
                                    <option value="FEDERAL">Federal</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <select id="filterStatus" class="form-control">
                                    <option value="">All</option>
                                    <option value="JOB">JOB</option>
                                    <option value="REPAIR">REPAIR</option>
                                    <option value="TEARDOWN">TEARDOWN</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Progress</label>
                                <select id="filterProgress" class="form-control">
                                    <option value="">All</option>
                                    <option value="NEW">NEW</option>
                                    <option value="0%">0%</option>
                                    <option value="25%">25%</option>
                                    <option value="50%">50%</option>
                                    <option value="75%">75%</option>
                                    <option value="100%">100%</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Location</label>
                                <select id="filterLocation" class="form-control">
                                    <option value="">All</option>
                                    <option value="LOCAL">LOCAL</option>
                                    <option value="OUT OF TOWN">OUT OF TOWN</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top: 16px;">
                            <button class="btn primary" id="btnApplyFilters">Apply Filters</button>
                            <button class="btn" id="btnClearFilters">Clear</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Staff Page -->
        <div id="staff" class="content">
            <div class="page-body" style="padding: 24px; display:flex; flex-direction:column; height: 100%;">
                <!-- Staff Tabs -->
                <div class="tabs">
                    <button class="tab-btn active" data-stafftab="overview" onclick="switchSubtab(&#39;staff&#39;,&#39;overview&#39;)">Overview</button>
                    <button class="tab-btn" data-stafftab="supervisors" onclick="switchSubtab(&#39;staff&#39;,&#39;supervisors&#39;)">Supervisors</button>
                    <button class="tab-btn" data-stafftab="crew" onclick="switchSubtab(&#39;staff&#39;,&#39;crew&#39;)">Crew Members</button>
                    <button class="tab-btn" data-stafftab="skills" onclick="switchSubtab(&#39;staff&#39;,&#39;skills&#39;)">Skills Matrix</button>
                    <button class="tab-btn" data-stafftab="certifications" onclick="switchSubtab(&#39;staff&#39;,&#39;certifications&#39;)">Certifications</button>
                </div>
                <!-- Staff content areas -->
                <div id="overview" class="staff-content" style="flex:1; overflow:auto;">
                    <h2 style="font-size: 18px; font-weight: 600; margin-bottom:16px;">Staff Overview</h2>
                    <div style="display:grid; grid-template-columns: repeat(6, 1fr); gap: 16px; margin-bottom:24px;">
                        <div class="card" style="border-left:4px solid #3b82f6;">
                            <div style="font-size: 11px; color:#6b7280; text-transform:uppercase; margin-bottom:4px;">Total Staff</div>
                            <div style="font-size: 28px; font-weight:700;" id="overviewTotal">0</div>
                        </div>
                        <div class="card" style="border-left:4px solid #10b981;">
                            <div style="font-size: 11px; color:#6b7280; text-transform:uppercase; margin-bottom:4px;">Available</div>
                            <div style="font-size: 28px; font-weight:700;" id="overviewAvailable">0</div>
                        </div>
                        <div class="card" style="border-left:4px solid #8b5cf6;">
                            <div style="font-size: 11px; color:#6b7280; text-transform:uppercase; margin-bottom:4px;">Supervisors</div>
                            <div style="font-size: 28px; font-weight:700;" id="overviewSupervisors">0</div>
                        </div>
                        <div class="card" style="border-left:4px solid #f59e0b;">
                            <div style="font-size: 11px; color:#6b7280; text-transform:uppercase; margin-bottom:4px;">Crew Members</div>
                            <div style="font-size: 28px; font-weight:700;" id="overviewCrew">0</div>
                        </div>
                        <div class="card" style="border-left:4px solid #06b6d4;">
                            <div style="font-size: 11px; color:#6b7280; text-transform:uppercase; margin-bottom:4px;">Certified</div>
                            <div style="font-size: 28px; font-weight:700;" id="overviewCertified">0</div>
                        </div>
                        <div class="card" style="border-left:4px solid #d97706;">
                            <div style="font-size: 11px; color:#6b7280; text-transform:uppercase; margin-bottom:4px;">Certificates (Active / Expiring)</div>
                            <div style="font-size: 22px; font-weight:700; display:flex; gap:4px;"><span id="overviewCertActive">0</span> / <span id="overviewCertExpiring">0</span></div>
                        </div>
                    </div>
                </div>
                <div id="supervisors" class="staff-content" style="display:none; flex:1; overflow:auto;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <h2 style="font-size:18px; font-weight:600;">Supervisors</h2>
                        <button class="btn primary" id="btnAddSupervisor">âž• Add Supervisor</button>
                    </div>
                    <div class="table-container" style="flex:1;">
                        <div class="table-header">Supervisors List</div>
                        <div style="height:100%; overflow:auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Employee #</th>
                                        <th>Full Name</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Division</th>
                                        <th>Specialties</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="supervisorsTable">
                                    <tr><td colspan="7" class="empty">No supervisors found</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="crew" class="staff-content" style="display:none; flex:1; overflow:auto;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <h2 style="font-size:18px; font-weight:600;">Crew Members</h2>
                        <button class="btn primary" id="btnAddCrew">âž• Add Crew</button>
                    </div>
                    <div class="table-container" style="flex:1;">
                        <div class="table-header">Crew List</div>
                        <div style="height:100%; overflow:auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Employee #</th>
                                        <th>Full Name</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Division</th>
                                        <th>Specialties</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="crewTable">
                                    <tr><td colspan="7" class="empty">No crew members found</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="skills" class="staff-content" style="display:none; flex:1; overflow:auto;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <h2 style="font-size:18px; font-weight:600;">Skills Matrix</h2>
                        <button class="btn primary" id="btnAddSkill">âž• Add Skill</button>
                    </div>
                    <div style="overflow-x:auto;">
                        <div id="skillsMatrixBody">Loading skills matrix...</div>
                    </div>
                </div>
                <div id="certifications" class="staff-content" style="display:none; flex:1; overflow:auto;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <h2 style="font-size:18px; font-weight:600;">Certifications</h2>
                        <button class="btn primary" id="btnAddCertification">âž• Add Certification</button>
                    </div>
                    <!-- Metrics for certifications: expiring soon, critical, active -->
                    <div id="certMetrics" style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px;"></div>
                    <!-- Filter options for certifications -->
                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                        <label for="certFilterType" style="font-size:12px;">Filter by type:</label>
                        <select id="certFilterType" class="form-control" style="flex:0 0 200px;"><option value="">All Types</option></select>
                    </div>
                    <div class="table-container" style="flex:1;">
                        <div class="table-header">Certifications</div>
                        <div style="height:100%; overflow:auto;" id="certificationsTableBody">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Reports Page -->
        <div id="reports" class="content">
            <div class="reports-container">
                <div class="reports-header">
                    <div class="filters">
                        <select id="reportPeriod">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month" selected="">This Month</option>
                            <option value="custom">Custom</option>
                        </select>
                        <input type="date" id="reportFrom" style="display:none;">
                        <input type="date" id="reportTo" style="display:none;">
                        <select id="reportSupervisor"></select>
                        <select id="reportLocation"></select>
                        <select id="reportStatus"></select>
                        <select id="reportPosition"></select>
                        <button class="btn small" id="reportRefresh">Update</button>
                        <button class="btn small" id="reportExport">Export CSV</button>
                        <button class="btn small" id="reportCompare">Compare</button>
                    </div>
                    <div class="last-sync" id="reportLastSync">Last updated just now</div>
                </div>
                <div class="reports-kpis">
                    <div class="report-card">
                        <div class="title">Total Jobs</div>
                        <div class="value" id="kpiTotalJobs">0</div>
                        <div class="subtext">Jobs in period</div>
                    </div>
                    <div class="report-card">
                        <div class="title">Completed / Pending</div>
                        <div class="value"><span id="kpiCompleted">0</span> / <span id="kpiPending">0</span></div>
                        <div class="subtext">
                            <div class="progress-bar"><div id="kpiProgressBar"></div></div>
                        </div>
                    </div>
                    <div class="report-card">
                        <div class="title">Total Hours</div>
                        <div class="value" id="kpiHours">0</div>
                        <div class="subtext">Hours worked</div>
                    </div>
                    <div class="report-card">
                        <div class="title">Efficiency</div>
                        <div class="value" id="kpiEfficiency">0%</div>
                        <div class="subtext">Completed / Total</div>
                    </div>
                    <div class="report-card">
                        <div class="title">Avg Efficiency (Worker)</div>
                        <div class="value" id="kpiAvgEff">0%</div>
                        <div class="subtext">Avg. completed per worker</div>
                    </div>
                    <div class="report-card">
                        <div class="title">Alerts / Incidences</div>
                        <div class="value" id="kpiAlerts">0</div>
                        <div class="subtext">Holds, Pushes, Unnotified</div>
                    </div>
                </div>
                <!-- Panels Row: Distribution & Productivity -->
                <div class="reports-panels-row">
                    <div class="report-panel" id="statusDistributionPanel">
                        <h3>Status Distribution</h3>
                        <div class="donut-chart" id="statusDonutChart">
                            <div class="donut-center" id="statusDonutCenter"></div>
                        </div>
                        <div class="legend" id="statusLegend"></div>
                    </div>
                    <div class="report-panel" id="productivityPanel">
                        <h3>Productivity by Worker</h3>
                        <div id="productivityList"></div>
                    </div>
                </div>
                <!-- Panels Row: Equipment, Finance, HR -->
                <div class="reports-panels-row">
                    <div class="report-panel" id="equipmentPanel">
                        <h3>Equipment State</h3>
                        <div id="equipmentSummary"></div>
                    </div>
                    <div class="report-panel" id="financePanel">
                        <h3>Financial Analysis</h3>
                        <div id="financeSummary"></div>
                    </div>
                    <div class="report-panel" id="hrPanel">
                        <h3>Human Resources</h3>
                        <div id="hrSummary"></div>
                    </div>
                </div>
                <!-- Panels Row: Weekly Summary & Alerts -->
                <div class="reports-panels-row">
                    <div class="report-panel" id="weeklyPanel">
                        <h3>Weekly Summary</h3>
                        <div id="weeklySummary"></div>
                    </div>
                    <div class="report-panel" id="alertsPanel">
                        <h3>Alerts &amp; Notifications</h3>
                        <div id="alertsList"></div>
                    </div>
                </div>
                <!-- Trends -->
                <div class="reports-trends">
                    <h3>Jobs Trend</h3>
                    <div id="jobsTrendList"></div>
                </div>
                <div class="reports-table">
                    <h3>Detailed Jobs</h3>
                    <div class="table-container">
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr id="reportsTableHeaders"></tr>
                                </thead>
                                <tbody id="reportsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Settings Page -->
        <!-- Users Page -->
        <div id="users" class="content">
            <div class="page-body" style="padding:24px;">
                <h2 style="font-size:20px; font-weight:600; margin-bottom:16px;">User Management</h2>
                <div class="card" style="margin-bottom:16px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 style="font-size:16px; font-weight:600;">Users</h3>
                        <!-- Call modal directly to ensure it always opens -->
                        <button type="button" class="btn primary" id="btnAddUser" onclick="event.preventDefault(); event.stopPropagation(); document.getElementById(&#39;modalUser&#39;).classList.add(&#39;show&#39;)" data-bound="1">âž• Add User</button>
                    </div>
                    <div id="usersTableContainer" style="margin-top:16px; overflow-x:auto;"></div>
                </div>
            </div>
        </div>

        <div id="settings" class="content">
            <div class="page-body" style="padding: 24px;">
                <div class="tabs">
                    <button class="tab-btn active" data-settingstab="general">General</button>
                    <button class="tab-btn" data-settingstab="api">API</button>
                    <button class="tab-btn" data-settingstab="spreadsheet">Spreadsheet</button>
                    <button class="tab-btn" data-settingstab="schema">Schema</button>
                    <button class="tab-btn" data-settingstab="appearance">Appearance</button>
                </div>
                <div id="general" class="settings-content" style="margin-top:12px;">
                    <div class="card" style="max-width:400px; margin-bottom:16px;">
                        <h3 style="font-size: 16px; font-weight:600; margin-bottom:16px;">General Settings</h3>
                        <div class="form-group">
                            <label>Company Name</label>
                            <input type="text" id="companyName" class="form-control" value="CVE San Diego" data-bound="1">
                        </div>
                    </div>
                </div>
                <div id="api" class="settings-content" style="display:none; margin-top:12px;">
                    <div class="card" style="max-width:500px; margin-bottom:16px;">
                        <h3 style="font-size:16px; font-weight:600; margin-bottom:16px;">API Configuration</h3>
                        <div class="form-group">
                            <label>Google Apps Script URL</label>
                            <input type="text" id="gasUrl" class="form-control" placeholder="https://script.google.com/macros/s/...">
                        </div>
                        <div class="form-group">
                            <label>Spreadsheet ID</label>
                            <input type="text" class="form-control" value="1ZZhv7DSFR1EfvC8Urz3JTUiIYQ5lViDyZe9QB0sl1o8" readonly="">
                        </div>
                        <div style="margin-top:16px; display:flex; gap:8px;">
                            <button class="btn primary" id="btnSaveApi">ðŸ’¾ Save</button>
                            <button class="btn" id="btnTestApi">ðŸ”— Test Connection</button>
                        </div>
                        <div style="margin-top:20px; padding:16px; background:#eff6ff; border:1px solid #bfdbfe; border-radius:6px;">
                            <div style="font-size:12px; font-weight:600; color:#1e40af; margin-bottom:6px;">Initialize Sheets</div>
                            <div style="font-size:11px; color:#1e3a8a; margin-bottom:8px;">Initialize annual sheets with the correct structure.</div>
                            <div style="display:flex; gap:4px;">
                                <button class="btn small primary" data-year="2025">Init 2025</button>
                                <button class="btn small primary" data-year="2026">Init 2026</button>
                                <button class="btn small primary" data-year="2027">Init 2027</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Spreadsheet Settings -->
                <div id="spreadsheet" class="settings-content" style="display:none; margin-top:12px;">
                    <div class="card" style="max-width:600px; margin-bottom:16px;">
                        <h3 style="font-size:16px; font-weight:600; margin-bottom:16px;">Spreadsheet Setup</h3>
                        <div class="form-group">
                            <label>Spreadsheet ID</label>
                            <input type="text" id="sheetId" class="form-control" placeholder="Paste Spreadsheet ID">
                        </div>
                        <div class="form-group">
                            <label>Active Year</label>
                            <select id="activeYearSelect" class="form-control">
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                            </select>
                        </div>
                        <div style="margin-top:16px; display:flex; gap:8px;">
                            <button class="btn" id="btnTestSheet" data-bound="1">ðŸ”— Test Connection</button>
                            <button class="btn" id="btnEnsureYear" data-bound="1">âž• Init Year</button>
                            <button class="btn" id="btnSwitchYear" data-bound="1">ðŸ“… Set Active Year</button>
                        </div>
                        <p id="sheetStatus" style="font-size:12px; color:var(--muted); margin-top:8px;"></p>
                    </div>
                </div>

                <!-- Schema Settings -->
                <div id="schema" class="settings-content" style="display:none; margin-top:12px;">
                    <div class="card" style="max-width:650px; margin-bottom:16px;">
                        <h3 style="font-size:16px; font-weight:600; margin-bottom:16px;">Schema Mapping</h3>
                        <div class="form-group">
                            <label>Jobs Sheet</label>
                            <input type="text" id="jobsSheetName" class="form-control" placeholder="Jobs_2025">
                        </div>
                        <div style="margin-top:16px; display:flex; gap:8px;">
                            <button class="btn" id="btnReadSchema" data-bound="1">ðŸ“„ Read Schema</button>
                            <button class="btn" id="btnAppendReserved" data-bound="1">âž• Append Reserved</button>
                        </div>
                        <div id="schemaForm" style="margin-top:16px;"></div>
                        <div style="margin-top:16px;">
                            <button class="btn primary" id="btnSaveSchema" data-bound="1">ðŸ’¾ Save Mapping</button>
                        </div>
                    </div>
                </div>
            <div id="appearance" class="settings-content" style="display:none; margin-top:12px;" data-moved="1">
            <div class="card" style="max-width:600px; margin-bottom:16px;">
                <h3 style="font-size:16px; font-weight:600; margin-bottom:16px;">Appearance &amp; Theme</h3>
                <div class="form-group">
                    <label>Theme Mode</label>
                    <select id="themeSelect" class="form-control" data-bound="1">
                        <option value="auto">Auto (OS)</option>
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                    </select>
                </div>
                <!-- Simplified appearance settings: choose theme mode only -->
                <p style="margin-top:12px; font-size:0.85rem; color: var(--muted);">Modal and module borders automatically use the logoâ€™s colours. In light mode, backgrounds are light with dark text; in dark mode, backgrounds are dark with light text.</p>
            </div>
        </div></div>
        </div>
    </div>
</div>
        <!-- Appearance Settings -->
        

<!-- Modals -->
<!-- Add Job Modal -->
<div class="modal" id="modalAddJob">
    <div class="modal-dialog">
        <div class="modal-header">
            <h2 class="modal-title">Add New Job</h2>
            <button class="close-btn" data-close="modalAddJob">Ã—</button>
        </div>
        <div class="modal-body">
            <!-- Job form with tabs -->
            <div style="display:flex; gap:0; border-bottom:1px solid #e5e7eb;">
                <button class="btn small" data-jobtab="basic" style="flex:1; border:none; background:none; border-bottom:2px solid #3b82f6; color:#3b82f6;">Basic</button>
                <button class="btn small" data-jobtab="scheduleTab" style="flex:1; border:none; background:none;">Schedule</button>
                <button class="btn small" data-jobtab="teamTab" style="flex:1; border:none; background:none;">Team</button>
                <button class="btn small" data-jobtab="complianceTab" style="flex:1; border:none; background:none;">Compliance</button>
                <button class="btn small" data-jobtab="notesTab" style="flex:1; border:none; background:none;">Notes</button>
            </div>
            <form id="formAddJob">
                <!-- Basic -->
                <div class="jobtab" id="basic" style="padding-top:16px;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Job Number <span class="required">*</span></label>
                            <input type="text" name="Job_Number" class="form-control" required="">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select name="Status" class="form-control">
                                <option>JOB</option>
                                <option>REPAIR</option>
                                <option>TEARDOWN</option>
                                <option>PICK UP EQ</option>
                                <option>TD &amp; EQ</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Job Address <span class="required">*</span></label>
                        <input type="text" name="Job_Address" class="form-control" required="">
                    </div>
                </div>
                <!-- Schedule -->
                <div class="jobtab" id="scheduleTab" style="display:none; padding-top:16px;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date <span class="required">*</span></label>
                            <input type="date" name="Date" class="form-control" required="">
                        </div>
                        <div class="form-group">
                            <label>Time</label>
                            <select name="Time" class="form-control">
                                <option>8 HRS</option>
                                <option>6 HRS</option>
                                <option>1/2 AM</option>
                                <option>1/2 PM</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Progress</label>
                            <select name="Progress" class="form-control">
                                <option>NEW</option>
                                <option>0%</option>
                                <option>25%</option>
                                <option>50%</option>
                                <option>75%</option>
                                <option>100%</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Location</label>
                            <select name="Location" class="form-control">
                                <option>LOCAL</option>
                                <option>OUT OF TOWN</option>
                            </select>
                        </div>
                    </div>
                </div>
                <!-- Team -->
                <div class="jobtab" id="teamTab" style="display:none; padding-top:16px;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Project Manager</label>
                            <select name="PM" class="form-control">
                                <option value="">Select PM</option>
                                <option>BC</option>
                                <option>BS</option>
                                <option>JC</option>
                                <option>MD</option>
                                <option>RC</option>
                                <option>SP</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Position</label>
                            <select name="Position" class="form-control">
                                <option>REGULAR</option>
                                <option>STATE</option>
                                <option>FEDERAL</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Supervisor</label>
                        <input type="text" name="Supervisor" class="form-control" placeholder="Select from staff list">
                    </div>
                    <div class="form-group">
                        <label>Crew Members</label>
                        <input type="text" name="Crew" class="form-control" placeholder="Select from staff list">
                    </div>
                </div>
                <!-- Compliance -->
                <div class="jobtab" id="complianceTab" style="display:none; padding-top:16px;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>OSHA</label>
                            <select name="OSHA" class="form-control">
                                <option>Yes</option>
                                <option>No</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Manifest</label>
                            <select name="Manifest" class="form-control">
                                <option>No</option>
                                <option>Haz Manifest</option>
                                <option>Non-Haz Manifest</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Notified</label>
                            <select name="Notified" class="form-control">
                                <option>Yes</option>
                                <option>No</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Scheduled</label>
                            <select name="Scheduled" class="form-control">
                                <option>Yes</option>
                                <option>No</option>
                            </select>
                        </div>
                    </div>
                </div>
                <!-- Notes -->
                <div class="jobtab" id="notesTab" style="display:none; padding-top:16px;">
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea name="Notes" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Manifest Notes</label>
                        <textarea name="Manifest_Notes" class="form-control" rows="3"></textarea>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn" data-close="modalAddJob" onclick="closeModal(&#39;modalAddJob&#39;)">Cancel</button>
            <button class="btn primary" id="btnSaveJob">Save</button>
        </div>
    </div>
</div>
<!-- Add Supervisor Modal -->
<div class="modal" id="modalAddSupervisor">
    <div class="modal-dialog" style="max-width:600px;">
        <div class="modal-header">
            <h2 class="modal-title">Add Supervisor</h2>
            <button class="close-btn" data-close="modalAddSupervisor">Ã—</button>
        </div>
        <div class="modal-body">
            <form id="formAddSupervisor">
                <div class="form-row">
                    <div class="form-group">
                        <label>Employee # <span class="required">*</span></label>
                        <input type="text" name="employeeNumber" class="form-control" required="">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select name="status" class="form-control">
                            <option value="AVAILABLE">Available</option>
                            <option value="ASSIGNED">Assigned</option>
                            <option value="OFF">Off</option>
                            <option value="VACATION">Vacation</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Full Name <span class="required">*</span></label>
                    <input type="text" name="fullName" class="form-control" required="">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Role</label>
                        <input type="text" name="role" class="form-control" value="SUPERVISOR" readonly="" style="background:#f3f4f6;">
                    </div>
                    <div class="form-group">
                        <label>Division</label>
                        <select name="division" class="form-control">
                            <option value="ASBESTOS">Asbestos</option>
                            <option value="LEAD">Lead Paint</option>
                            <option value="MOLD">Mold</option>
                            <option value="BIO_HAZARD">Bio Hazard</option>
                            <option value="BACTERIA">Bacteria</option>
                            <option value="GENERAL">General</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Specialties (Ctrl/Cmd to select)</label>
                    <select name="specialties" class="form-control" multiple="" style="height:100px;">
                        <option value="Asbestos">Asbestos</option>
                        <option value="Lead Paint">Lead Paint</option>
                        <option value="Mold">Mold</option>
                        <option value="Bio Hazard">Bio Hazard</option>
                        <option value="Bacteria">Bacteria</option>
                        <option value="Contents">Contents</option>
                        <option value="Duct Cleaning">Duct Cleaning</option>
                        <option value="Driver">Driver</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn" data-close="modalAddSupervisor">Cancel</button>
            <button class="btn primary" id="btnSaveSupervisor">Save</button>
        </div>
    </div>
</div>
<!-- Add Crew Modal -->
<div class="modal" id="modalAddCrew">
    <div class="modal-dialog" style="max-width:600px;">
        <div class="modal-header">
            <h2 class="modal-title">Add Crew Member</h2>
            <button class="close-btn" data-close="modalAddCrew">Ã—</button>
        </div>
        <div class="modal-body">
            <form id="formAddCrew">
                <div class="form-row">
                    <div class="form-group">
                        <label>Employee # <span class="required">*</span></label>
                        <input type="text" name="employeeNumber" class="form-control" required="">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select name="status" class="form-control">
                            <option value="AVAILABLE">Available</option>
                            <option value="ASSIGNED">Assigned</option>
                            <option value="OFF">Off</option>
                            <option value="VACATION">Vacation</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Full Name <span class="required">*</span></label>
                    <input type="text" name="fullName" class="form-control" required="">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Role</label>
                        <input type="text" name="role" class="form-control" value="CREW" readonly="" style="background:#f3f4f6;">
                    </div>
                    <div class="form-group">
                        <label>Division</label>
                        <select name="division" class="form-control">
                            <option value="ASBESTOS">Asbestos</option>
                            <option value="LEAD">Lead Paint</option>
                            <option value="MOLD">Mold</option>
                            <option value="BIO_HAZARD">Bio Hazard</option>
                            <option value="BACTERIA">Bacteria</option>
                            <option value="GENERAL">General</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Specialties (Ctrl/Cmd to select)</label>
                    <select name="specialties" class="form-control" multiple="" style="height:100px;">
                        <option value="Asbestos">Asbestos</option>
                        <option value="Lead Paint">Lead Paint</option>
                        <option value="Mold">Mold</option>
                        <option value="Bio Hazard">Bio Hazard</option>
                        <option value="Bacteria">Bacteria</option>
                        <option value="Contents">Contents</option>
                        <option value="Duct Cleaning">Duct Cleaning</option>
                        <option value="Driver">Driver</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn" data-close="modalAddCrew">Cancel</button>
            <button class="btn primary" id="btnSaveCrew">Save</button>
        </div>
    </div>
</div>
<!-- Add Skill Modal -->
<div class="modal" id="modalAddSkill">
    <div class="modal-dialog" style="max-width:500px;">
        <div class="modal-header">
            <h2 class="modal-title">Add New Skill</h2>
            <button class="close-btn" data-close="modalAddSkill">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Skill Name <span class="required">*</span></label>
                <input type="text" id="newSkillName" class="form-control">
            </div>
            <div class="form-group">
                <label>Type</label>
                <select id="newSkillType" class="form-control">
                    <option value="certification">Certification</option>
                    <option value="specialty">Specialty</option>
                    <option value="evaluation">Evaluation</option>
                </select>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="newSkillDescription" class="form-control" rows="3"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" data-close="modalAddSkill">Cancel</button>
            <button class="btn primary" id="btnSaveSkill">Add</button>
        </div>
    </div>
</div>
<!-- Add Certification Modal -->
<div class="modal" id="modalAddCertification">
    <div class="modal-dialog" style="max-width:500px;">
        <div class="modal-header">
            <h2 class="modal-title">Add Certification</h2>
            <button class="close-btn" data-close="modalAddCertification">Ã—</button>
        </div>
        <div class="modal-body">
            <form id="formAddCertification">
                <div class="form-group">
                    <label>Employee <span class="required">*</span></label>
                    <select name="employee" id="certificationEmployee" class="form-control" required="">
                        <option value="">Select Employee</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Certification Type <span class="required">*</span></label>
                    <select name="certificationType" class="form-control" required="">
                        <option value="">Select</option>
                        <option value="ASBESTOS_CERT">Asbestos Certification</option>
                        <option value="LEAD_CERT">Lead Paint Certification</option>
                        <option value="MOLD_CERT">Mold Certification</option>
                        <option value="OSHA_30">OSHA 30</option>
                        <option value="OSHA_40">OSHA 40</option>
                        <option value="FIRST_AID">First Aid</option>
                        <option value="CPR">CPR</option>
                        <option value="MEDICAL_EXAM">Medical Exam</option>
                        <option value="PHYSICAL_EXAM">Physical Exam</option>
                        <option value="COMPANY_TRAINING">Company Training</option>
                        <option value="OTHER">Other</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Issue Date <span class="required">*</span></label>
                        <input type="date" name="issueDate" class="form-control" required="">
                    </div>
                    <div class="form-group">
                        <label>Expiry Date <span class="required">*</span></label>
                        <input type="date" name="expiryDate" class="form-control" required="">
                    </div>
                </div>
                <div class="form-group">
                    <label>Certification Number</label>
                    <input type="text" name="certNumber" class="form-control">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea name="notes" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Attachment (PDF)</label>
                    <input type="file" id="certFile" accept=".pdf" class="form-control">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn" data-close="modalAddCertification">Cancel</button>
            <button class="btn primary" id="btnSaveCertification">Save</button>
        </div>
    </div>
</div>

<!-- Column Edit Modal -->
<div class="modal" id="modalEditColumn">
    <div class="modal-dialog" style="max-width:700px;">
        <div class="modal-header">
            <h2 class="modal-title">Edit Column</h2>
            <button class="close-btn" data-close="modalEditColumn">Ã—</button>
        </div>
        <div class="modal-body">
            <form id="formEditColumn">
                <input type="hidden" id="editColumnId">
                <!-- Column Name & Type -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Column Name <span class="required">*</span></label>
                        <input type="text" id="editColumnName" class="form-control" required="">
                    </div>
                    <div class="form-group">
                        <label>Type <span class="required">*</span></label>
                        <select id="editColumnType" class="form-control">
                            <option value="text">Text</option>
                            <option value="textarea">Text (Long)</option>
                            <option value="number">Number</option>
                            <option value="currency">Currency</option>
                            <option value="date">Date</option>
                            <option value="dropdown">Dropdown</option>
                            <option value="multiselect">Multiselect</option>
                            <option value="checkbox">Checkbox</option>
                        </select>
                    </div>
                </div>
                <!-- Width & Required -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Width</label>
                        <input type="number" id="editColumnWidth" class="form-control" min="50" max="500" step="10" value="120">
                    </div>
                    <div class="form-group">
                        <label>Required</label>
                        <select id="editColumnRequired" class="form-control">
                            <option value="false">No</option>
                            <option value="true">Yes</option>
                        </select>
                    </div>
                </div>
                <!-- Dropdown Options -->
                <div class="form-group" id="editColumnOptionsContainer" style="display:none;">
                    <label>Dropdown Options (one per line)</label>
                    <textarea id="editColumnOptions" class="form-control" rows="4" placeholder="Option 1\nOption 2\nOption 3"></textarea>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="editColumnDescription" class="form-control" rows="2" placeholder="Optional description"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn" data-close="modalEditColumn">Cancel</button>
            <button class="btn primary" id="btnSaveColumn">Save</button>
        </div>
    </div>
</div>

<!-- Add Column Modal -->
<div class="modal" id="modalAddColumn">
    <div class="modal-dialog" style="max-width:500px;">
        <div class="modal-header">
            <h2 class="modal-title">Add Column</h2>
            <button class="close-btn" data-close="modalAddColumn">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Column Name <span class="required">*</span></label>
                <input type="text" id="addColumnName" class="form-control" placeholder="Name (use underscores)">
            </div>
            <div class="form-group">
                <label>Column Type <span class="required">*</span></label>
                <select id="addColumnType" class="form-control">
                    <option value="text">Text (Short)</option>
                    <option value="textarea">Text (Long)</option>
                    <option value="number">Number</option>
                    <option value="currency">Currency</option>
                    <option value="date">Date</option>
                    <option value="dropdown">Dropdown (Single Select)</option>
                    <option value="multiselect">Multi-Select</option>
                    <option value="checkbox">Checkbox</option>
                </select>
            </div>
            <div id="addColumnOptionsContainer" class="form-group" style="display:none;">
                <label>Options (one per line)</label>
                <textarea id="addColumnOptions" class="form-control" rows="4" placeholder="Option 1
Option 2
Option 3"></textarea>
            </div>
            <div class="form-group">
                <label>Width (px)</label>
                <input type="number" id="addColumnWidth" class="form-control" value="120" min="30">
            </div>
            <div class="form-group">
                <label>Required</label>
                <select id="addColumnRequired" class="form-control">
                    <option value="false">No</option>
                    <option value="true">Yes</option>
                </select>
            </div>
            <div class="form-group">
                <label>Visible</label>
                <select id="addColumnVisible" class="form-control">
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" data-close="modalAddColumn">Cancel</button>
            <button class="btn primary" id="btnSaveAddColumn">Save</button>
        </div>
    </div>
</div>

<!-- Edit Certification Modal -->
<div class="modal" id="modalEditCertification">
    <div class="modal-dialog" style="max-width:600px;">
        <div class="modal-header">
            <h2 class="modal-title">Certification Details</h2>
            <button class="close-btn" data-close="modalEditCertification">Ã—</button>
        </div>
        <div class="modal-body">
            <form id="formEditCertification">
                <input type="hidden" name="certId">
                <div class="form-group">
                    <label>Employee</label>
                    <input type="text" name="employeeName" class="form-control" readonly="">
                </div>
                <div class="form-group">
                    <label>Certification Type</label>
                    <input type="text" name="certificationType" class="form-control" readonly="">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Issue Date</label>
                        <input type="date" name="issueDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Expiry Date</label>
                        <input type="date" name="expiryDate" class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label>Certification Number</label>
                    <input type="text" name="certNumber" class="form-control">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea name="notes" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Attachment (PDF)</label>
                    <div id="existingCertFile" style="margin-bottom:4px;"></div>
                    <input type="file" id="editCertFile" accept=".pdf" class="form-control">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn" data-close="modalEditCertification">Cancel</button>
            <button class="btn primary" id="btnUpdateCertification">Update</button>
            <button class="btn danger" id="btnDeleteCertification">Delete</button>
        </div>
    </div>
</div>

<!-- Notifications container -->
<div id="notificationContainer"></div>

<!-- Login Modal -->
<div class="modal" id="modalLogin">
    <div class="modal-dialog">
        <div class="modal-header">
            <h2 class="modal-title">Login</h2>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="loginUsername" class="form-control" placeholder="Your username">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" class="form-control" placeholder="Your password">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn primary" id="btnLogin" data-bound="1">Login</button>
        </div>
    </div>
</div>

<script>
    // Global state
    let currentPage = 'dashboard';
    let currentSubtab = { schedule: 'jobs', staff: 'overview', settings: 'general' };
    let jobs = [];
    // Logs of operations performed on jobs (edit/duplicate/delete)
    let operationLogs = [];
    // Track editing job row id and index when editing an existing job
    let editingRowId = null;
    let editingRowIndex = null;
    // Operation logs for row actions (edit, duplicate, delete) shown in the Row Actions panel
    // (operationLogs, editingRowId and editingRowIndex are declared above)
    let columns = [];
    let staffData = { supervisors: [], crew: [], skills: [], certs: [] };
    let gasUrl = '';
    let viewMode = 'complete';
    let columnConfigLoaded = false;

    // Certifications data loaded from backend
    let certifications = [];

    // Users data loaded from backend
    let users = [];

    // Additional state for Schedule functionality
    let selectedDate = null; // currently selected date in 'YYYY-MM-DD' format
    let currentCalendarMonth = null; // Date object representing first day of current calendar month
    const STATUS_LIST = ['JOB','REPAIR','TEARDOWN','PICK UP EQ','CLASS','MEDICAL','VACATION','GO BACK','LIGHT DUTY'];
    const POSITION_LIST = ['REGULAR','STATE','FEDERAL'];
    const MONTH_NAMES = ['January','February','March','April','May','June','July','August','September','October','November','December'];

    // Reports dashboard state
    let reportsInitialized = false;
    let reportJobs = [];
    let reportFilteredJobs = [];
    let reportLastSync = null;
    const REPORT_STATUS_LIST = ['JOB','REPAIR','TEARDOWN','PICK UP EQ','CLASS','MEDICAL','VACATION','GO BACK','LIGHT DUTY'];
    const REPORT_STATUS_COLORS = {
        'JOB': '#3b82f6',
        'REPAIR': '#ef4444',
        'TEARDOWN': '#f59e0b',
        'PICK UP EQ': '#ec4899',
        'CLASS': '#8b5cf6',
        'MEDICAL': '#10b981',
        'VACATION': '#6ee7b7',
        'GO BACK': '#6366f1',
        'LIGHT DUTY': '#d97706'
    };
    const LOCATION_LIST = ['LOCAL','OUT OF TOWN'];
    // Selected row index for row actions
    let selectedRowIndex = null;
    // OPSIS TimeSync additional global state
    // Spreadsheet ID currently connected
    let opsisSheetId = '';
    // Active year for jobs (e.g. 2025)
    let activeYear = new Date().getFullYear();
    // Authentication token and role
    let opsisToken = null;
    let opsisRole = null;
    // Schema mapping object (logical fields to header names)
    let schemaMapping = null;
    // Login state
    // Default login state is true so the app can be used without credentials during testing
    let isLoggedIn = true;

    // Column schema definition (31 columns) to map to backend
    const DEFAULT_SCHEMA = [
        {id:1,name:'Date',type:'date',required:true,visible:true,width:'120px'},
        {id:2,name:'Job_Number',type:'text',required:true,visible:true,width:'120px'},
        {id:3,name:'Time',type:'dropdown',visible:true,width:'100px',options:['8 HRS','6 HRS','1/2 AM','1/2 PM']},
        {id:4,name:'PM',type:'dropdown',visible:true,width:'80px',options:['BC','BS','JC','MD']},
        {id:5,name:'Supervisor',type:'multiselect',visible:true,width:'180px',options:[]},
        {id:6,name:'Crew',type:'multiselect',visible:true,width:'250px',options:[]},
        {id:7,name:'Job_Address',type:'textarea',required:true,visible:true,width:'300px'},
        {id:8,name:'Status',type:'dropdown',visible:true,width:'120px',options:['JOB','REPAIR','TEARDOWN']},
        {id:9,name:'Progress',type:'dropdown',visible:true,width:'100px',options:['NEW','RETURN','HOLD','0%','25%','50%','75%','100%']},
        {id:10,name:'Position',type:'dropdown',visible:true,width:'100px',options:[]},
        {id:11,name:'Location',type:'dropdown',visible:true,width:'100px',options:['LOCAL','OUT OF TOWN']},
        {id:12,name:'Disposal',type:'dropdown',visible:true,width:'100px',options:[]},
        {id:13,name:'Manifest',type:'dropdown',visible:true,width:'100px',options:[]},
        {id:14,name:'Notified',type:'dropdown',visible:true,width:'80px',options:['Yes','No']},
        {id:15,name:'OSHA',type:'dropdown',visible:true,width:'80px',options:['Yes','No']},
        {id:16,name:'MP_Total',type:'number',visible:true,width:'100px'},
        {id:17,name:'MP_Used',type:'number',visible:true,width:'100px'},
        {id:18,name:'MP_Active',type:'number',visible:true,width:'100px'},
        {id:19,name:'Change_Order',type:'currency',visible:true,width:'120px'},
        {id:20,name:'Scheduled',type:'dropdown',visible:true,width:'80px',options:['Yes','No']},
        {id:21,name:'Folder',type:'dropdown',visible:true,width:'100px',options:[]},
        {id:22,name:'Hotel',type:'dropdown',visible:true,width:'120px',options:[]},
        {id:23,name:'Call_Off',type:'text',visible:true,width:'120px'},
        {id:24,name:'Notes',type:'textarea',visible:true,width:'300px'},
        {id:25,name:'Manifest_Notes',type:'textarea',visible:true,width:'300px'},
        {id:26,name:'Manifest_Number',type:'text',visible:true,width:'150px'},
        {id:27,name:'Generator_ID',type:'text',visible:true,width:'150px'},
        {id:28,name:'Survey',type:'text',visible:true,width:'120px'},
        {id:29,name:'Contract',type:'text',visible:true,width:'120px'},
        {id:30,name:'Manifest_Returned',type:'dropdown',visible:true,width:'120px',options:['Yes','No']},
        {id:31,name:'Samples_Returned',type:'dropdown',visible:true,width:'120px',options:['Yes','No']}
    ];

    // Helpers
    function $(selector) {
        return document.querySelector(selector);
    }
    function $$(selector) {
        return document.querySelectorAll(selector);
    }
    function showNotification(message, type='info') {
        const container = document.getElementById('notificationContainer');
        const notif = document.createElement('div');
        notif.className = `notification ${type}`;
        const icons = {success:'âœ“',error:'âœ—',info:'â„¹',warning:'âš '};
        notif.innerHTML = `<span>${icons[type]}</span><span>${message}</span>`;
        container.appendChild(notif);
        setTimeout(() => notif.remove(), 3500);
    }

    function saveLocalConfig() {
        localStorage.setItem('cve_gasUrl', gasUrl);
        localStorage.setItem('cve_columns', JSON.stringify(columns));
        // Save Opsis data
        localStorage.setItem('opsis_sheetId', opsisSheetId || '');
        localStorage.setItem('opsis_activeYear', activeYear || '');
        localStorage.setItem('opsis_token', opsisToken || '');
        localStorage.setItem('opsis_role', opsisRole || '');
        if (schemaMapping) {
            localStorage.setItem('opsis_schema', JSON.stringify(schemaMapping));
        }
        // Save current theme (light/dark/auto)
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'auto';
        localStorage.setItem('opsis_theme', currentTheme);
    }
    function loadLocalConfig() {
        const savedUrl = localStorage.getItem('cve_gasUrl');
        if (savedUrl) {
            gasUrl = savedUrl;
            $('#gasUrl').value = savedUrl;
            updateConnectionIndicator();
        }
        const savedCols = localStorage.getItem('cve_columns');
        if (savedCols) {
            try {
                columns = JSON.parse(savedCols);
                columnConfigLoaded = true;
            } catch(err) {
                columns = [];
            }
        }
        // Load Opsis data
        const savedSheet = localStorage.getItem('opsis_sheetId');
        if (savedSheet) {
            opsisSheetId = savedSheet;
            const sheetInput = document.getElementById('sheetId');
            if (sheetInput) sheetInput.value = savedSheet;
        }
        const savedYear = localStorage.getItem('opsis_activeYear');
        if (savedYear) {
            activeYear = parseInt(savedYear);
            const yearSel = document.getElementById('activeYearSelect');
            if (yearSel) yearSel.value = savedYear;
        }
        const savedToken = localStorage.getItem('opsis_token');
        const savedRole = localStorage.getItem('opsis_role');
        if (savedToken) {
            opsisToken = savedToken;
            opsisRole = savedRole || null;
            isLoggedIn = true;
        }
        const savedSchema = localStorage.getItem('opsis_schema');
        if (savedSchema) {
            try {
                schemaMapping = JSON.parse(savedSchema);
            } catch(e) {
                schemaMapping = null;
            }
        }
        // Load theme preference and apply
        const savedTheme = localStorage.getItem('opsis_theme') || 'auto';
        applyTheme(savedTheme);
    }

    // API call helper
    async function callAPI(action, payload={}) {
        if (!gasUrl) {
            showNotification('Configure API URL in Settings', 'error');
            return {success:false};
        }
        try {
            const res = await fetch(gasUrl, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({action, ...payload})
            });
            const result = await res.json();
            updateConnectionIndicator(result.success);
            return result;
        } catch(error) {
            updateConnectionIndicator(false);
            return {success:false, error:error.toString()};
        }
    }

    function updateConnectionIndicator(connected=false) {
        const indicator = document.getElementById('connectionIndicator');
        if (connected) {
            indicator.textContent = 'ðŸ“Š Connected';
            indicator.style.color = '#10b981';
        } else {
            indicator.textContent = 'ðŸ“Š Disconnected';
            indicator.style.color = '#ef4444';
        }
    }

    // Theme application helper
    function applyTheme(mode) {
        const root = document.documentElement;
        // Determine actual theme (dark or light) based on mode and OS preference
        let actualTheme;
        if (mode === 'auto') {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            actualTheme = prefersDark ? 'dark' : 'light';
        } else {
            actualTheme = mode;
        }
        // Persist the chosen mode
        localStorage.setItem('opsis_theme', mode);
        // Apply data-theme attribute to root
        root.setAttribute('data-theme', actualTheme);
        if (actualTheme === 'dark') {
            // Dark mode colours: dark backgrounds and light text
            root.style.setProperty('--card', 'rgba(255,255,255,0.05)');
            root.style.setProperty('--card-hover', 'rgba(255,255,255,0.1)');
            root.style.setProperty('--text', '#e5e7eb');
            root.style.setProperty('--muted', '#9ca3af');
            root.style.setProperty('--border', 'rgba(255,255,255,0.1)');
            root.style.setProperty('--modal-bg', 'rgba(255,255,255,0.05)');
            root.style.setProperty('--modal-text', '#e5e7eb');
            // Keep dark background gradient
            root.style.setProperty('--bg-dark-primary', '#1d1d1f');
            root.style.setProperty('--bg-dark-secondary', '#2d2d2f');
        } else {
            // Light mode colours: light backgrounds and dark text for contrast
            root.style.setProperty('--card', '#ffffff');
            root.style.setProperty('--card-hover', '#f1f5f9');
            root.style.setProperty('--text', '#374151');
            root.style.setProperty('--muted', '#6b7280');
            root.style.setProperty('--border', 'rgba(0,0,0,0.1)');
            root.style.setProperty('--modal-bg', '#ffffff');
            root.style.setProperty('--modal-text', '#374151');
            // Use a very light background gradient for light mode
            root.style.setProperty('--bg-dark-primary', '#f7f9fc');
            root.style.setProperty('--bg-dark-secondary', '#e8edf5');
        }
        // Use logo colours for buttons and gradient
        const primary = getComputedStyle(root).getPropertyValue('--timesync-primary').trim();
        const secondary = getComputedStyle(root).getPropertyValue('--timesync-secondary').trim();
        root.style.setProperty('--button-gradient-start', primary);
        root.style.setProperty('--button-gradient-end', secondary);
        root.style.setProperty('--gradient', 'linear-gradient(135deg, ' + primary + ', ' + secondary + ')');
        // Apply accent colour if stored
        const savedAccent = localStorage.getItem('opsis_accent');
        if (savedAccent) {
            root.style.setProperty('--accent', savedAccent);
        } else {
            root.style.setProperty('--accent', primary);
        }
    }
    // Watch for OS theme changes when in auto mode
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
        const saved = localStorage.getItem('opsis_theme') || 'auto';
        if (saved === 'auto') applyTheme('auto');
    });

    // Navigation
    function switchPage(page) {
        currentPage = page;
        document.querySelectorAll('.nav-icon').forEach(icon => {
            icon.classList.toggle('active', icon.dataset.page === page);
        });
        document.querySelectorAll('.content').forEach(content => {
            content.classList.toggle('active', content.id === page);
        });
        // Determine and apply page-specific border colours for modules and modals
        const root = document.documentElement;
        const borderMapping = {
            dashboard: getComputedStyle(root).getPropertyValue('--dashboard-border').trim(),
            schedule: getComputedStyle(root).getPropertyValue('--schedule-border').trim(),
            staff: getComputedStyle(root).getPropertyValue('--staff-border').trim(),
            reports: getComputedStyle(root).getPropertyValue('--reports-border').trim(),
            users: getComputedStyle(root).getPropertyValue('--users-border').trim(),
            settings: getComputedStyle(root).getPropertyValue('--settings-border').trim()
        };
        const newBorder = borderMapping[page] || borderMapping.dashboard;
        root.style.setProperty('--module-border-color', newBorder);
        root.style.setProperty('--modal-border-color', newBorder);

        if (page === 'dashboard') loadDashboard();
        if (page === 'schedule') loadSchedule();
        if (page === 'staff') loadStaff();
        if (page === 'reports') {
            if (!reportsInitialized) {
                initReportsPage();
                reportsInitialized = true;
            } else {
                loadReports();
            }
        }
        if (page === 'users') {
            loadUsers();
        }
    }

    // Subtabs within pages
    function switchSubtab(section, tab) {
        currentSubtab[section] = tab;
        if (section === 'schedule') {
            document.querySelectorAll('#schedule .tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.subtab === tab);
            });
            document.querySelectorAll('#schedule .subtab-content').forEach(cont => {
                cont.style.display = cont.id === tab ? 'flex' : 'none';
            });
            if (tab === 'columns' && !columnConfigLoaded) loadColumns();
        } else if (section === 'staff') {
            document.querySelectorAll('#staff .tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.stafftab === tab);
            });
            document.querySelectorAll('#staff .staff-content').forEach(cont => {
                cont.style.display = cont.id === tab ? 'block' : 'none';
            });
            if (tab === 'supervisors') loadSupervisors();
            if (tab === 'crew') loadCrew();
            if (tab === 'skills') loadSkillsMatrix();
            if (tab === 'certifications') loadCertifications();
        } else if (section === 'settings') {
            document.querySelectorAll('#settings .tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.settingstab === tab);
            });
            document.querySelectorAll('#settings .settings-content').forEach(cont => {
                cont.style.display = cont.id === tab ? 'block' : 'none';
            });
        }
    }

    // Dashboard Data
    async function loadDashboard() {
        const result = await callAPI('getDashboardStats');
        if (result.success) {
            const stats = result.stats || {};
            $('#dashTotalJobs').textContent = stats.activeJobs || 0;
            $('#dashActiveCrew').textContent = `${stats.availableStaff||0}/${stats.totalStaff||0}`;
            $('#dashPendingJobs').textContent = stats.pendingJobs || 0;
            $('#dashEfficiency').textContent = (stats.efficiency || 0) + '%';
        } else {
            showNotification('Failed to load dashboard', 'error');
        }
    }

    // Schedule Data
    async function loadSchedule() {
        const year = parseInt($('#yearSelect').value);
        const month = $('#monthSelect').value;
        const result = await callAPI('getJobs', {year, month});
        if (result.success) {
            jobs = result.jobs || [];
            renderJobsTable();
            document.getElementById('jobCount').textContent = result.total || jobs.length;
        } else {
            // fallback: clear jobs when API fails
            jobs = [];
            renderJobsTable();
            document.getElementById('jobCount').textContent = 0;
        }
        // update stats and mini calendar regardless of API status
        updateScheduleStats();
        renderMiniCalendar();
    }

    function renderJobsTable() {
        const tableHead = document.getElementById('jobsTableHead');
        const tableBody = document.getElementById('jobsTableBody');
        const visibleCols = columns.length ? columns.filter(c => c.visible) : DEFAULT_SCHEMA.filter(c=>c.visible);
        if (!columns.length) columns = JSON.parse(JSON.stringify(DEFAULT_SCHEMA));
        if (visibleCols.length === 0) {
            tableHead.innerHTML = '<th>Date</th><th>Job Number</th><th>Address</th><th>Status</th>';
        } else {
            tableHead.innerHTML = visibleCols.map(col => `<th>${col.name.replace(/_/g,' ')}</th>`).join('');
        }
        if (!jobs || jobs.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${visibleCols.length}" class="empty">No jobs found</td></tr>`;
            return;
        }
        tableBody.innerHTML = jobs.map(job => {
            return `<tr>` + visibleCols.map(col => {
                let value = job[col.name];
                if (value == null || value === undefined) value = '';
                if (col.type === 'date' && value) {
                    const date = new Date(value);
                    value = date.toLocaleDateString('en-US');
                }
                if (col.type === 'currency' && value) {
                    value = parseFloat(value).toLocaleString('en-US',{style:'currency',currency:'USD'});
                }
                if (Array.isArray(value)) {
                    return `<td>${value.join(', ')}</td>`;
                }
                return `<td>${value}</td>`;
            }).join('') + `</tr>`;
        }).join('');
        // Attach click handlers for row selection
        Array.from(tableBody.querySelectorAll('tr')).forEach((row, index) => {
            row.dataset.index = index;
            row.addEventListener('click', () => selectJobRow(index));
        });
    }

    function updateScheduleStats() {
        // Determine date to evaluate (selectedDate if set, else today)
        const today = new Date();
        const selected = selectedDate ? new Date(selectedDate) : today;
        selected.setHours(0,0,0,0);
        // Week boundaries (Sunday to Saturday) for selected date
        const weekStart = new Date(selected);
        weekStart.setDate(selected.getDate() - selected.getDay());
        weekStart.setHours(0,0,0,0);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        // Counters
        let jobsDay = 0;
        let jobsWeek = 0;
        const statusCounts = {};
        STATUS_LIST.forEach(s => { statusCounts[s] = {day:0, week:0}; });
        const positionCounts = {};
        POSITION_LIST.forEach(p => { positionCounts[p] = {day:0, week:0}; });
        // Count jobs by selected date and week and by status/position
        jobs.forEach(job => {
            if (!job.Date) return;
            const d = new Date(job.Date);
            d.setHours(0,0,0,0);
            const isDay = d.getTime() === selected.getTime();
            const isWeek = d >= weekStart && d <= weekEnd;
            if (isDay) jobsDay++;
            if (isWeek) jobsWeek++;
            const status = job.Status || job.status || '';
            const pos = job.Position || job.position || '';
            if (STATUS_LIST.includes(status)) {
                if (isDay) statusCounts[status].day++;
                if (isWeek) statusCounts[status].week++;
            }
            if (POSITION_LIST.includes(pos)) {
                if (isDay) positionCounts[pos].day++;
                if (isWeek) positionCounts[pos].week++;
            }
        });
        // Update titles and counts
        const year = parseInt($('#yearSelect').value);
        const monthName = $('#monthSelect').value;
        document.getElementById('jobsTitle').textContent = `${monthName} ${year} Jobs`;
        document.getElementById('statToday').textContent = jobsDay;
        document.getElementById('statWeek').textContent = jobsWeek;
        // Supervisor & worker availability counts
        const supAvail = staffData.supervisors.filter(s => (s.Status || s.status) === 'AVAILABLE').length;
        const supTotal = staffData.supervisors.length;
        const crewAvail = staffData.crew.filter(c => (c.Status || c.status) === 'AVAILABLE').length;
        const crewTotal = staffData.crew.length;
        document.getElementById('statSupAvail').textContent = `${supAvail}/${supTotal}`;
        document.getElementById('statCrewAvail').textContent = `${crewAvail}/${crewTotal}`;
        // Update UI for each status
        STATUS_LIST.forEach(s => {
            const elId = 'count' + s.replace(/\s+/g,'_');
            const el = document.getElementById(elId);
            if (el) {
                const counts = statusCounts[s];
                el.textContent = `${counts.day} (${counts.week})`;
            }
        });
        // Update UI for positions
        POSITION_LIST.forEach(p => {
            const elId = 'count' + p;
            const el = document.getElementById(elId);
            if (el) {
                const counts = positionCounts[p];
                el.textContent = `${counts.day} (${counts.week})`;
            }
        });
        // Update specialties stats
        updateSpecialtiesCounts();
    }

    // Append a log entry to the operations log panel
    function addOperationLog(action, jobNumber, message) {
        const now = new Date();
        const entry = `${now.toLocaleString()} â€¢ ${action} ${jobNumber || ''} â€“ ${message}`;
        operationLogs.unshift(entry);
        if (operationLogs.length > 50) {
            operationLogs.pop();
        }
        const logContainer = document.getElementById('operationsLog');
        if (logContainer) {
            logContainer.innerHTML = operationLogs.map(l => `<div class=\"log-entry\">${l}</div>`).join('');
        }
    }

    // Edit the selected job row
    function editJobRow() {
        if (selectedRowIndex == null || !jobs[selectedRowIndex]) return;
        const job = jobs[selectedRowIndex];
        editingRowIndex = selectedRowIndex;
        editingRowId = job.Row_ID || job.Row_id || job.rowId;
        // Prefill form with job data
        const form = document.getElementById('formAddJob');
        if (!form) return;
        form.Job_Number.value = job.Job_Number || '';
        form.Status.value = job.Status || '';
        form.Job_Address.value = job.Job_Address || '';
        form.Date.value = job.Date ? new Date(job.Date).toISOString().split('T')[0] : '';
        form.Time.value = job.Time || '';
        form.Progress.value = job.Progress || '';
        form.Location.value = job.Location || '';
        form.PM.value = job.PM || '';
        form.Position.value = job.Position || '';
        form.Supervisor.value = job.Supervisor || '';
        form.Crew.value = job.Crew || '';
        form.OSHA.value = job.OSHA || '';
        form.Manifest.value = job.Manifest || '';
        form.Notified.value = job.Notified || '';
        form.Scheduled.value = job.Scheduled || '';
        form.Notes.value = job.Notes || '';
        form.Manifest_Notes.value = job.Manifest_Notes || '';
        // Show modal on basic tab
        document.getElementById('modalAddJob').classList.add('show');
        document.querySelectorAll('#modalAddJob .jobtab').forEach(c => c.style.display='none');
        document.getElementById('basic').style.display='block';
        document.querySelectorAll('#modalAddJob [data-jobtab]').forEach(b => {
            b.style.borderBottomColor='transparent';
            b.style.color = '#374151';
        });
        document.querySelector('#modalAddJob [data-jobtab="basic"]').style.borderBottomColor='#3b82f6';
        document.querySelector('#modalAddJob [data-jobtab="basic"]').style.color='#3b82f6';
    }

    // Duplicate the selected job row
    async function duplicateJobRow() {
        if (selectedRowIndex == null || !jobs[selectedRowIndex]) return;
        const original = jobs[selectedRowIndex];
        const year = parseInt($('#yearSelect').value);
        const month = $('#monthSelect').value;
        const newJob = {};
        Object.keys(original).forEach(k => {
            if (['Row_ID','Row_id','rowId','Created_At','Modified_At','Modified_By','Active'].includes(k)) return;
            newJob[k] = original[k];
        });
        const res = await callAPI('createJob', {job:newJob, year, month, user:'System'});
        if (res.success) {
            addOperationLog('Duplicate', original.Job_Number || '', 'Job duplicated');
            showNotification('Job duplicated','success');
            loadSchedule();
        } else {
            showNotification('Failed to duplicate job','error');
        }
    }

    // Delete the selected job row
    async function deleteJobRow() {
        if (selectedRowIndex == null || !jobs[selectedRowIndex]) return;
        const job = jobs[selectedRowIndex];
        const rowId = job.Row_ID || job.Row_id || job.rowId;
        if (!rowId) return;
        if (!confirm('Are you sure you want to delete this job?')) return;
        const year = parseInt($('#yearSelect').value);
        const month = $('#monthSelect').value;
        const res = await callAPI('deleteJob', {rowId, year, month, user:'System'});
        if (res.success) {
            addOperationLog('Delete', job.Job_Number || '', 'Job deleted');
            showNotification('Job deleted','success');
            loadSchedule();
        } else {
            showNotification('Failed to delete job','error');
        }
    }

    // Calendar stub (no date selection due to complexity)
    function renderCalendar() {
        const calendarDiv = document.getElementById('calendar');
        calendarDiv.innerHTML = 'Connect API to see calendar';
    }

    // Staff Data
    async function loadStaff() {
        // Load staff overview from API (optional) and update local metrics if available
        try {
            const ovRes = await callAPI('getOverviewMetrics');
            if (ovRes.success && ovRes.metrics) {
                // We still call this for API side effects but will compute metrics locally
            }
        } catch(e) {}
        // Also load supervisors and crew lists for accurate overview counts
        try {
            await loadSupervisors();
        } catch(e) {}
        try {
            await loadCrew();
        } catch(e) {}
        // update overview metrics based on loaded staff and certifications
        updateStaffOverview();
    }

    async function loadSupervisors() {
        const result = await callAPI('getStaff', {role:'SUPERVISOR'});
        if (result.success) {
            staffData.supervisors = result.staff || [];
            const tbody = document.getElementById('supervisorsTable');
            if (!staffData.supervisors.length) {
                tbody.innerHTML = `<tr><td colspan="7" class="empty">No supervisors found</td></tr>`;
            } else {
                tbody.innerHTML = staffData.supervisors.map(s => {
                    const specialties = Array.isArray(s.Specialties) ? s.Specialties.join(', ') : (s.Specialties || '');
                    return `<tr>
                        <td>${s.Employee_Number || s.employeeNumber || ''}</td>
                        <td>${s.Full_Name || s.fullName || ''}</td>
                        <td><span class="badge badge-info">${s.Role || s.role}</span></td>
                        <td><span class="badge ${s.Status==='AVAILABLE'? 'badge-success':'badge-warning'}">${s.Status || s.status}</span></td>
                        <td>${s.Division || s.division || ''}</td>
                        <td>${specialties}</td>
                        <td><button class="btn small" data-edit="supervisor" data-id="${s.Employee_Number}">Edit</button> <button class="btn small danger" data-delete="supervisor" data-id="${s.Employee_Number}">Delete</button></td>
                    </tr>`;
                }).join('');
            }
            updateScheduleStats();
            updateStaffOverview();
        }
    }

    async function loadCrew() {
        const result = await callAPI('getStaff', {role:'CREW'});
        if (result.success) {
            staffData.crew = result.staff || [];
            const tbody = document.getElementById('crewTable');
            if (!staffData.crew.length) {
                tbody.innerHTML = `<tr><td colspan="7" class="empty">No crew members found</td></tr>`;
            } else {
                tbody.innerHTML = staffData.crew.map(c => {
                    const specialties = Array.isArray(c.Specialties) ? c.Specialties.join(', ') : (c.Specialties || '');
                    return `<tr>
                        <td>${c.Employee_Number || c.employeeNumber || ''}</td>
                        <td>${c.Full_Name || c.fullName || ''}</td>
                        <td><span class="badge badge-info">${c.Role || c.role}</span></td>
                        <td><span class="badge ${c.Status==='AVAILABLE'? 'badge-success':'badge-warning'}">${c.Status || c.status}</span></td>
                        <td>${c.Division || c.division || ''}</td>
                        <td>${specialties}</td>
                        <td><button class="btn small" data-edit="crew" data-id="${c.Employee_Number}">Edit</button> <button class="btn small danger" data-delete="crew" data-id="${c.Employee_Number}">Delete</button></td>
                    </tr>`;
                }).join('');
            }
            updateScheduleStats();
            updateStaffOverview();
        }
    }

    function updateSpecialtiesStats() {
        const statsDiv = document.getElementById('teamStats');
        const activeTab = document.getElementById('teamSupTab').classList.contains('active') ? 'sup' : 'crew';
        const list = activeTab === 'sup' ? staffData.supervisors : staffData.crew;
        const counts = {asbestos:0, lead:0, mold:0, bio:0, bacteria:0, contents:0, duct:0, drivers:0};
        list.forEach(s => {
            const specs = s.Specialties || [];
            const arr = Array.isArray(specs) ? specs : specs.toString().split(',');
            arr.forEach(sp => {
                const low = sp.toLowerCase().trim();
                if (low.includes('asbestos')) counts.asbestos++;
                if (low.includes('lead')) counts.lead++;
                if (low.includes('mold')) counts.mold++;
                if (low.includes('bio')) counts.bio++;
                if (low.includes('bacteria')) counts.bacteria++;
                if (low.includes('contents')) counts.contents++;
                if (low.includes('duct')) counts.duct++;
                if (low.includes('driver')) counts.drivers++;
            });
        });
        statsDiv.innerHTML = `
            <div>Asbestos: <strong>${counts.asbestos}</strong></div>
            <div>Lead: <strong>${counts.lead}</strong></div>
            <div>Mold: <strong>${counts.mold}</strong></div>
            <div>Bio Haz: <strong>${counts.bio}</strong></div>
            <div>Bacteria: <strong>${counts.bacteria}</strong></div>
            <div>Contents: <strong>${counts.contents}</strong></div>
            <div>Duct: <strong>${counts.duct}</strong></div>
            <div>Drivers: <strong>${counts.drivers}</strong></div>
        `;
    }

    // Calculate specialty counts for supervisors and crew and update the schedule modules.
    function updateSpecialtiesCounts() {
        const specKeys = ['Asbestos','Lead','Mold','Bio Haz','Bacteria','Contents','Duct Cleaning','Drivers'];
        const supCounts = {};
        const supAvailCounts = {};
        const crewCounts = {};
        const crewAvailCounts = {};
        specKeys.forEach(k => {
            supCounts[k] = 0;
            supAvailCounts[k] = 0;
            crewCounts[k] = 0;
            crewAvailCounts[k] = 0;
        });
        // Count supervisors
        staffData.supervisors.forEach(s => {
            const specs = s.Specialties || s.specialties || [];
            const arr = Array.isArray(specs) ? specs : specs.toString().split(',').map(sp => sp.trim());
            arr.forEach(sp => {
                specKeys.forEach(k => {
                    const spSan = sp.toLowerCase().replace(/\s+/g,'');
                    const keySan = k.toLowerCase().replace(/\s+/g,'');
                    if (spSan.includes(keySan)) {
                        supCounts[k]++;
                        if ((s.Status || s.status) === 'AVAILABLE') {
                            supAvailCounts[k]++;
                        }
                    }
                });
            });
        });
        // Count crew
        staffData.crew.forEach(c => {
            const specs = c.Specialties || c.specialties || [];
            const arr = Array.isArray(specs) ? specs : specs.toString().split(',').map(sp => sp.trim());
            arr.forEach(sp => {
                specKeys.forEach(k => {
                    const spSan = sp.toLowerCase().replace(/\s+/g,'');
                    const keySan = k.toLowerCase().replace(/\s+/g,'');
                    if (spSan.includes(keySan)) {
                        crewCounts[k]++;
                        if ((c.Status || c.status) === 'AVAILABLE') {
                            crewAvailCounts[k]++;
                        }
                    }
                });
            });
        });
        // Map display names to id segments
        const specMap = {
            'Asbestos': 'Asbestos',
            'Lead': 'Lead',
            'Mold': 'Mold',
            'Bio Haz': 'Bio',
            'Bacteria': 'Bacteria',
            'Contents': 'Contents',
            'Duct Cleaning': 'Duct',
            'Drivers': 'Drivers'
        };
        // Update DOM
        specKeys.forEach(k => {
            const idPart = specMap[k] || k.replace(/\s+/g,'');
            const supEl = document.getElementById('sup' + idPart + 'Count');
            const crewEl = document.getElementById('crew' + idPart + 'Count');
            if (supEl) supEl.textContent = `${supAvailCounts[k]}/${supCounts[k]}`;
            if (crewEl) crewEl.textContent = `${crewAvailCounts[k]}/${crewCounts[k]}`;
        });
    }

    // Render the mini calendar for the current month and attach click handlers
    function renderMiniCalendar() {
        const year = parseInt($('#yearSelect').value);
        const monthName = $('#monthSelect').value;
        const monthIndex = MONTH_NAMES.indexOf(monthName);
        currentCalendarMonth = new Date(year, monthIndex, 1);
        const calendar = document.getElementById('miniCalendar');
        const monthLabel = document.getElementById('calendarMonth');
        if (monthLabel) {
            monthLabel.textContent = `${monthName} ${year}`;
        }
        // Build job count map
        const jobsByDate = {};
        jobs.forEach(job => {
            if (!job.Date) return;
            const d = new Date(job.Date);
            const y = d.getFullYear();
            const m = d.getMonth() + 1;
            const day = d.getDate();
            const dateStr = `${y}-${String(m).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            jobsByDate[dateStr] = (jobsByDate[dateStr] || 0) + 1;
        });
        // Determine first day of month and days in month
        const firstDay = currentCalendarMonth.getDay();
        const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
        // Clear existing content
        calendar.innerHTML = '';
        // Headers
        const headers = ['S','M','T','W','T','F','S'];
        headers.forEach(h => {
            const cell = document.createElement('div');
            cell.className = 'day-header';
            cell.textContent = h;
            calendar.appendChild(cell);
        });
        // Leading blanks
        for (let i = 0; i < firstDay; i++) {
            const blank = document.createElement('div');
            blank.className = 'day other-month';
            calendar.appendChild(blank);
        }
        // Days
        for (let d = 1; d <= daysInMonth; d++) {
            const cell = document.createElement('div');
            cell.className = 'day';
            const dateStr = `${year}-${String(monthIndex+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            cell.dataset.date = dateStr;
            cell.textContent = d;
            // Add classes
            const t = new Date();
            if (t.getFullYear() === year && t.getMonth() === monthIndex && t.getDate() === d) {
                cell.classList.add('today');
            }
            if (selectedDate && selectedDate === dateStr) {
                cell.classList.add('selected');
            }
            if (jobsByDate[dateStr]) {
                cell.classList.add('has-jobs');
            }
            cell.addEventListener('click', () => {
                selectDate(dateStr);
            });
            calendar.appendChild(cell);
        }
        // Trailing blanks to fill grid
        const totalCells = headers.length + firstDay + daysInMonth;
        const remainder = totalCells % 7;
        if (remainder !== 0) {
            const blanks = 7 - remainder;
            for (let i = 0; i < blanks; i++) {
                const blank = document.createElement('div');
                blank.className = 'day other-month';
                calendar.appendChild(blank);
            }
        }
    }

    // Handle date selection from mini calendar
    function selectDate(dateStr) {
        selectedDate = dateStr;
        // highlight selection
        document.querySelectorAll('#miniCalendar .day').forEach(cell => {
            if (cell.dataset.date) {
                if (cell.dataset.date === dateStr) {
                    cell.classList.add('selected');
                } else {
                    cell.classList.remove('selected');
                }
            }
        });
        updateScheduleStats();
    }

    // Change calendar month by offset (-1 for previous, 1 for next)
    function changeCalendarMonth(offset) {
        let year = parseInt($('#yearSelect').value);
        let monthName = $('#monthSelect').value;
        let monthIndex = MONTH_NAMES.indexOf(monthName);
        monthIndex += offset;
        if (monthIndex < 0) {
            monthIndex = 11;
            year--;
        } else if (monthIndex > 11) {
            monthIndex = 0;
            year++;
        }
        $('#yearSelect').value = year;
        $('#monthSelect').value = MONTH_NAMES[monthIndex];
        // Clear selected date when changing month
        selectedDate = null;
        loadSchedule();
    }

    // Select a row in the jobs table and update the row actions panel
    function selectJobRow(index) {
        selectedRowIndex = index;
        const rows = document.querySelectorAll('#jobsTableBody tr');
        rows.forEach((r,i) => {
            if (i === index) {
                r.style.background = '#e0e7ff';
            } else {
                r.style.background = '';
            }
        });
        const job = jobs[index];
        const infoEl = document.getElementById('selectedJobInfo');
        const btnEdit = document.getElementById('btnEditRow');
        const btnDup = document.getElementById('btnDuplicateRow');
        const btnDel = document.getElementById('btnDeleteRow');
        if (job && infoEl) {
            const dateLabel = job.Date ? new Date(job.Date).toLocaleDateString('en-US') : '';
            infoEl.textContent = `Job #${job.Job_Number || ''} â€“ ${dateLabel}`;
            if (btnEdit) btnEdit.disabled = false;
            if (btnDup) btnDup.disabled = false;
            if (btnDel) btnDel.disabled = false;
        } else {
            if (infoEl) infoEl.textContent = 'Select a row';
            if (btnEdit) btnEdit.disabled = true;
            if (btnDup) btnDup.disabled = true;
            if (btnDel) btnDel.disabled = true;
        }
    }

    async function loadSkillsMatrix() {
        const res = await callAPI('getSkillsMatrix');
        if (res.success) {
            const matrix = res.matrix || [];
            const skills = res.skills || [];
            const container = document.getElementById('skillsMatrixBody');
            if (!matrix.length) {
                container.innerHTML = '<div class="empty">No skills data</div>';
                return;
            }
            // Build table with dynamic columns
            let html = '<table><thead><tr>';
            const headers = Object.keys(matrix[0]);
            headers.forEach(h => {
                html += `<th>${h.replace(/_/g,' ')}</th>`;
            });
            html += '</tr></thead><tbody>';
            matrix.forEach(row => {
                html += '<tr>';
                headers.forEach(h => {
                    html += `<td>${row[h] || ''}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }
    }

    async function loadCertifications() {
        const res = await callAPI('getCertifications');
        const container = document.getElementById('certificationsTableBody');
        const metricsContainer = document.getElementById('certMetrics');
        const filterSelect = document.getElementById('certFilterType');
        // Reset global certifications list
        certifications = [];
        if (res.success) {
            certifications = res.certifications || [];
        }
        // Build filter options based on available certificate types
        if (filterSelect) {
            const types = new Set();
            certifications.forEach(c => {
                const t = c.certificationType || c.Certification_Type || c.certification_type;
                if (t) types.add(t);
            });
            const prev = filterSelect.value;
            filterSelect.innerHTML = '<option value="">All Types</option>';
            Array.from(types).sort().forEach(t => {
                filterSelect.innerHTML += `<option value="${t}">${t.replace(/_/g,' ')}</option>`;
            });
            if (prev && types.has(prev)) {
                filterSelect.value = prev;
            }
        }
        // Render the table and update metrics
        renderCertificationsTable();
        // Update staff overview counts (active/expiring certificates)
        updateStaffOverview();
    }

    // Render the certifications table and update metrics
    function renderCertificationsTable() {
        const container = document.getElementById('certificationsTableBody');
        const metricsContainer = document.getElementById('certMetrics');
        const filterSelect = document.getElementById('certFilterType');
        if (!container) return;
        let list = certifications.slice();
        // Apply filter if a type is selected
        if (filterSelect && filterSelect.value) {
            list = list.filter(c => {
                const t = c.certificationType || c.Certification_Type || c.certification_type;
                return t === filterSelect.value;
            });
        }
        // If no rows to display
        if (!list.length) {
            container.innerHTML = '<div class="empty">No certifications found</div>';
            if (metricsContainer) metricsContainer.innerHTML = '';
            return;
        }
        // Counts for status levels
        let critical = 0;
        let warning = 0;
        let ok = 0;
        const today = new Date();
        // Build table header
        let html = '<table style="width:100%; border-collapse:collapse; font-size:11px;"><thead><tr>';
        const cols = ['Employee_Name','Certification_Type','Issue_Date','Expiry_Date','Cert_Number','Notes'];
        cols.forEach(h => {
            html += `<th style="text-transform:uppercase; font-weight:600; color:#6b7280; padding:8px 6px; border-bottom:1px solid #e5e7eb;">${h.replace(/_/g,' ')}</th>`;
        });
        html += '</tr></thead><tbody>';
        list.forEach(c => {
            const issue = c.issueDate || c.Issue_Date;
            const expiry = c.expiryDate || c.Expiry_Date;
            let expiryDate = expiry ? new Date(expiry) : null;
            let statusClass = 'cert-status-ok';
            if (expiryDate && !isNaN(expiryDate)) {
                const diff = (expiryDate.getTime() - today.getTime()) / 86400000;
                const days = Math.floor(diff);
                if (days <= 30) {
                    statusClass = 'cert-status-critical';
                    critical++;
                } else if (days <= 60) {
                    statusClass = 'cert-status-warning';
                    warning++;
                } else {
                    ok++;
                }
            } else {
                ok++;
            }
            html += `<tr class="${statusClass}">`;
            // Employee Name
            html += `<td style="padding:6px 8px; border-bottom:1px solid #f3f4f6;">${c.employeeName || c.Employee_Name || ''}</td>`;
            // Certification Type
            html += `<td style="padding:6px 8px; border-bottom:1px solid #f3f4f6;">${(c.certificationType || c.Certification_Type || '').replace(/_/g,' ')}</td>`;
            // Issue Date
            const issueStr = issue ? new Date(issue).toLocaleDateString('en-US') : '';
            html += `<td style="padding:6px 8px; border-bottom:1px solid #f3f4f6;">${issueStr}</td>`;
            // Expiry Date
            const expiryStr = expiry ? new Date(expiry).toLocaleDateString('en-US') : '';
            html += `<td style="padding:6px 8px; border-bottom:1px solid #f3f4f6;">${expiryStr}</td>`;
            // Cert Number
            html += `<td style="padding:6px 8px; border-bottom:1px solid #f3f4f6;">${c.certNumber || c.Cert_Number || ''}</td>`;
            // Notes and attachment icon
            let noteStr = (c.notes || c.Notes || '');
            if (c.fileData) {
                noteStr += ` <a href="data:application/pdf;base64,${c.fileData}" target="_blank" title="View PDF">ðŸ“Ž</a>`;
            }
            html += `<td style="padding:6px 8px; border-bottom:1px solid #f3f4f6;">${noteStr}</td>`;
            html += '</tr>';
        });
        html += '</tbody></table>';
        container.innerHTML = html;
        // Render metrics counts
        if (metricsContainer) {
            metricsContainer.innerHTML = `
                <div class="card" style="border-left:4px solid #ef4444;">
                    <div class="value">${critical}</div>
                    <div class="subtext">Critical (&lt;30d)</div>
                </div>
                <div class="card" style="border-left:4px solid #f59e0b;">
                    <div class="value">${warning}</div>
                    <div class="subtext">Expiring (&lt;60d)</div>
                </div>
                <div class="card" style="border-left:4px solid #10b981;">
                    <div class="value">${ok}</div>
                    <div class="subtext">Active (â‰¥60d)</div>
                </div>`;
        }
        // Attach click handlers to each row for editing
        const rows = container.querySelectorAll('tbody tr');
        rows.forEach((row, idx) => {
            row.style.cursor = 'pointer';
            row.addEventListener('click', () => {
                openEditCertificationModal(list[idx]);
            });
        });
    }

    // Show details of a certification in an editable form
    function openEditCertificationModal(cert) {
        const modal = document.getElementById('modalEditCertification');
        const form = document.getElementById('formEditCertification');
        if (!modal || !form) return;
        form.certId.value = cert.Cert_ID || cert.id || '';
        form.employeeName.value = cert.employeeName || cert.Employee_Name || '';
        form.certificationType.value = (cert.certificationType || cert.Certification_Type || '').replace(/_/g,' ');
        const issueVal = cert.issueDate || cert.Issue_Date || '';
        if (issueVal) {
            const d = new Date(issueVal);
            form.issueDate.value = d.toISOString().substring(0,10);
        } else {
            form.issueDate.value = '';
        }
        const expVal = cert.expiryDate || cert.Expiry_Date || '';
        if (expVal) {
            const d2 = new Date(expVal);
            form.expiryDate.value = d2.toISOString().substring(0,10);
        } else {
            form.expiryDate.value = '';
        }
        form.certNumber.value = cert.certNumber || cert.Cert_Number || '';
        form.notes.value = cert.notes || cert.Notes || '';
        const ex = document.getElementById('existingCertFile');
        if (ex) {
            if (cert.fileData) {
                ex.innerHTML = `<a href="data:application/pdf;base64,${cert.fileData}" target="_blank">${cert.fileName || 'View PDF'}</a>`;
            } else {
                ex.innerHTML = '';
            }
        }
        modal.classList.add('show');
    }

    // Columns Manager
    async function loadColumns() {
        if (columns.length) {
            renderColumnsTable();
            return;
        }
        const res = await callAPI('getColumnSchema');
        if (res.success && res.schema) {
            columns = res.schema;
        } else {
            columns = JSON.parse(JSON.stringify(DEFAULT_SCHEMA));
        }
        renderColumnsTable();
    }
    function renderColumnsTable() {
        const tbody = document.getElementById('columnsTableBody');
        if (!columns.length) {
            tbody.innerHTML = '<tr><td colspan="8" class="empty">No columns</td></tr>';
            return;
        }
        tbody.innerHTML = columns.map((col, idx) => {
            const optionsPreview = col.options && col.options.length ? col.options.slice(0,3).map(o => `<span style="background:#f3f4f6; padding:2px 4px; border-radius:4px; margin-right:4px;">${o}</span>`).join('') : '-';
            return `<tr data-index="${idx}">
                <td>${col.id}</td>
                <td>
                    <label class="switch">
                        <input type="checkbox" ${col.visible?'checked':''} data-toggle="${col.id}">
                        <span class="slider"></span>
                    </label>
                </td>
                <td>${col.name}</td>
                <td>${col.type}</td>
                <td>${col.required? 'Yes':'No'}</td>
                <td><input type="number" value="${parseInt(col.width)}" data-width="${col.id}" style="width:60px;" /></td>
                <td>${optionsPreview}</td>
                <td><button class="btn small" data-edit-column="${col.id}">Edit</button></td>
            </tr>`;
        }).join('');
        // Attach listeners after rendering rows
        attachColumnListeners();
    }

    // Attach event listeners to the columns table for toggles, width changes and drag/drop
    function attachColumnListeners() {
        const tbody = document.getElementById('columnsTableBody');
        if (!tbody) return;
        // Toggle visibility
        tbody.querySelectorAll('input[data-toggle]').forEach(input => {
            input.onchange = () => {
                const id = parseInt(input.dataset.toggle);
                const col = columns.find(c => c.id === id);
                if (col) col.visible = input.checked;
            };
        });
        // Width input changes
        tbody.querySelectorAll('input[data-width]').forEach(input => {
            input.onchange = () => {
                const id = parseInt(input.dataset.width);
                const col = columns.find(c => c.id === id);
                if (col) col.width = input.value + 'px';
            };
        });
        // Drag and drop reorder
        tbody.querySelectorAll('tr').forEach((row, idx) => {
            row.draggable = true;
            row.addEventListener('dragstart', ev => {
                ev.dataTransfer.setData('text/plain', idx.toString());
            });
            row.addEventListener('dragover', ev => {
                ev.preventDefault();
            });
            row.addEventListener('drop', ev => {
                ev.preventDefault();
                const from = parseInt(ev.dataTransfer.getData('text/plain'));
                const to = idx;
                if (!isNaN(from) && !isNaN(to) && from !== to) {
                    const moved = columns.splice(from, 1)[0];
                    columns.splice(to, 0, moved);
                    renderColumnsTable();
                }
            });
        });
    }

    // ============================================
    // Reports Dashboard Functions
    // ============================================
    function parseHours(timeStr) {
        if (!timeStr) return 0;
        const str = ('' + timeStr).toUpperCase();
        if (str.includes('8')) return 8;
        if (str.includes('6')) return 6;
        if (str.includes('1/2')) return 4;
        if (str.includes('2') && !str.includes('1/2')) return 2;
        if (str.includes('4')) return 4;
        if (str.includes('1HR')) return 1;
        const num = parseFloat(str);
        return isNaN(num) ? 0 : num;
    }

    function onReportPeriodChange() {
        const periodEl = $('#reportPeriod');
        if (!periodEl) return;
        const period = periodEl.value;
        const showCustom = (period === 'custom');
        const fromEl = $('#reportFrom');
        const toEl = $('#reportTo');
        if (fromEl) fromEl.style.display = showCustom ? 'block' : 'none';
        if (toEl) toEl.style.display = showCustom ? 'block' : 'none';
        if (!showCustom) {
            loadReports();
        }
    }

    async function populateReportFilters() {
        const supSelect = $('#reportSupervisor');
        if (supSelect) {
            supSelect.innerHTML = '<option value="">All Supervisors</option>';
            if (staffData && staffData.supervisors) {
                staffData.supervisors.forEach(s => {
                    const name = s.Full_Name || s.fullName || '';
                    if (name) {
                        supSelect.innerHTML += `<option value="${name}">${name}</option>`;
                    }
                });
            }
        }
        const locSelect = $('#reportLocation');
        if (locSelect) {
            locSelect.innerHTML = '<option value="">All Locations</option>';
            LOCATION_LIST.forEach(loc => {
                locSelect.innerHTML += `<option value="${loc}">${loc}</option>`;
            });
        }
        const statusSelect = $('#reportStatus');
        if (statusSelect) {
            statusSelect.innerHTML = '<option value="">All Statuses</option>';
            REPORT_STATUS_LIST.forEach(s => {
                statusSelect.innerHTML += `<option value="${s}">${s.replace(/_/g,' ')}</option>`;
            });
        }
        const posSelect = $('#reportPosition');
        if (posSelect) {
            posSelect.innerHTML = '<option value="">All Positions</option>';
            POSITION_LIST.forEach(p => {
                posSelect.innerHTML += `<option value="${p}">${p}</option>`;
            });
        }
    }

    function getPeriodDates() {
        const now = new Date();
        const periodEl = $('#reportPeriod');
        const period = periodEl ? periodEl.value : 'month';
        let startDate, endDate;
        if (period === 'today') {
            startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            endDate = new Date(startDate);
        } else if (period === 'week') {
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - now.getDay());
            startDate = new Date(weekStart.getFullYear(), weekStart.getMonth(), weekStart.getDate());
            endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
        } else if (period === 'month') {
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        } else {
            const fromVal = $('#reportFrom') ? $('#reportFrom').value : '';
            const toVal = $('#reportTo') ? $('#reportTo').value : '';
            startDate = fromVal ? new Date(fromVal) : new Date(now.getFullYear(), now.getMonth(), 1);
            endDate = toVal ? new Date(toVal) : new Date(now.getFullYear(), now.getMonth() + 1, 0);
        }
        startDate.setHours(0,0,0,0);
        endDate.setHours(23,59,59,999);
        return {startDate, endDate};
    }

    async function loadReports() {
        const {startDate, endDate} = getPeriodDates();
        reportJobs = [];
        const startYear = startDate.getFullYear();
        const endYear = endDate.getFullYear();
        const calls = [];
        for (let year = startYear; year <= endYear; year++) {
            const monthStart = (year === startYear ? startDate.getMonth() : 0);
            const monthEnd = (year === endYear ? endDate.getMonth() : 11);
            for (let m = monthStart; m <= monthEnd; m++) {
                calls.push(callAPI('getJobs', {year: year, month: MONTH_NAMES[m]}));
            }
        }
        try {
            const results = await Promise.all(calls);
            results.forEach(res => {
                if (res && res.success) {
                    reportJobs = reportJobs.concat(res.jobs || []);
                }
            });
        } catch(err) {
            reportJobs = jobs || [];
        }
        const supFilter = $('#reportSupervisor') ? $('#reportSupervisor').value : '';
        const locFilter = $('#reportLocation') ? $('#reportLocation').value : '';
        const statusFilter = $('#reportStatus') ? $('#reportStatus').value : '';
        const posFilter = $('#reportPosition') ? $('#reportPosition').value : '';
        reportFilteredJobs = reportJobs.filter(job => {
            if (!job.Date) return false;
            const d = new Date(job.Date);
            if (d < startDate || d > endDate) return false;
            if (supFilter) {
                const sups = job.Supervisor || '';
                if (!sups.includes(supFilter)) return false;
            }
            if (locFilter && (job.Location || '') !== locFilter) return false;
            if (statusFilter && (job.Status || '') !== statusFilter) return false;
            if (posFilter && (job.Position || '') !== posFilter) return false;
            return true;
        });
        updateReportMetrics();
        updateTrendJobs();
        updateReportTable();
        reportLastSync = new Date();
        updateReportLastSync();
    }

    function updateReportMetrics() {
        const total = reportFilteredJobs.length;
        let completed = 0;
        let hours = 0;
        reportFilteredJobs.forEach(job => {
            const prog = job.Progress || '';
            if (prog === '100%' || prog === 'COMPLETE' || prog === '100') completed++;
            hours += parseHours(job.Time);
        });
        const pending = total - completed;
        const efficiency = total ? Math.round((completed / total) * 100) : 0;
        if ($('#kpiTotalJobs')) $('#kpiTotalJobs').textContent = total;
        if ($('#kpiCompleted')) $('#kpiCompleted').textContent = completed;
        if ($('#kpiPending')) $('#kpiPending').textContent = pending;
        if ($('#kpiHours')) $('#kpiHours').textContent = hours;
        if ($('#kpiEfficiency')) $('#kpiEfficiency').textContent = efficiency + '%';
        const progBar = document.getElementById('kpiProgressBar');
        if (progBar) {
            const width = total ? (completed / total * 100) : 0;
            progBar.style.width = width + '%';
        }

        // Compute worker efficiencies and alerts
        const workerStats = {};
        let alertCount = 0;
        reportFilteredJobs.forEach(job => {
            const progVal = job.Progress || '';
            const notified = job.Notified || '';
            const scheduled = job.Scheduled || '';
            if (progVal === 'HOLD' || progVal === 'PUSH' || notified === 'No' || scheduled === 'No') alertCount++;
            const names = [];
            if (job.Supervisor) {
                job.Supervisor.split(',').forEach(n => {
                    const t = n.trim();
                    if (t) names.push(t);
                });
            }
            if (job.Crew) {
                job.Crew.split(',').forEach(n => {
                    const t = n.trim();
                    if (t) names.push(t);
                });
            }
            names.forEach(name => {
                if (!workerStats[name]) workerStats[name] = {total:0, completed:0};
                workerStats[name].total++;
                if (progVal === '100%' || progVal === 'COMPLETE' || progVal === '100') workerStats[name].completed++;
            });
        });
        let totalEff = 0;
        let workerCount = 0;
        for (const name in workerStats) {
            const ws = workerStats[name];
            if (ws.total) {
                totalEff += (ws.completed / ws.total);
                workerCount++;
            }
        }
        const avgEff = workerCount ? Math.round((totalEff / workerCount) * 100) : 0;
        const avgEffEl = document.getElementById('kpiAvgEff');
        if (avgEffEl) avgEffEl.textContent = avgEff + '%';
        const alertEl = document.getElementById('kpiAlerts');
        if (alertEl) alertEl.textContent = alertCount;

        // Update all report panels
        updateStatusDonut();
        updateProductivityPanel();
        updateEquipmentPanel();
        updateFinancePanel();
        updateHRPanel();
        updateWeeklySummaryPanel();
        updateAlertsPanel();
    }

    function updateStatusDistribution() {
        const container = document.getElementById('statusDistributionList');
        if (!container) return;
        container.innerHTML = '';
        const total = reportFilteredJobs.length;
        const counts = {};
        REPORT_STATUS_LIST.forEach(s => { counts[s] = 0; });
        reportFilteredJobs.forEach(job => {
            const s = job.Status || '';
            if (counts.hasOwnProperty(s)) counts[s] = (counts[s] || 0) + 1;
        });
        REPORT_STATUS_LIST.forEach(s => {
            const count = counts[s] || 0;
            const perc = total ? (count / total * 100) : 0;
            const row = document.createElement('div');
            row.className = 'status-row';
            const label = document.createElement('div');
            label.textContent = s;
            const bar = document.createElement('div');
            bar.className = 'bar';
            bar.style.background = REPORT_STATUS_COLORS[s] || '#3b82f6';
            // override flex to allow width to represent percentage
            bar.style.flex = '0 0 ' + perc + '%';
            const countText = document.createElement('span');
            countText.textContent = count;
            row.appendChild(label);
            row.appendChild(bar);
            row.appendChild(countText);
            container.appendChild(row);
        });
    }

    function updateTopWorkers() {
        const container = document.getElementById('topWorkersList');
        if (!container) return;
        container.innerHTML = '';
        const map = {};
        reportFilteredJobs.forEach(job => {
            const sup = job.Supervisor || '';
            sup.split(',').map(s => s.trim()).forEach(w => {
                if (!w) return;
                if (!map[w]) map[w] = {jobs:0,hours:0};
                map[w].jobs++;
                map[w].hours += parseHours(job.Time);
            });
            const crew = job.Crew || '';
            crew.split(',').map(c => c.trim()).forEach(w => {
                if (!w) return;
                if (!map[w]) map[w] = {jobs:0,hours:0};
                map[w].jobs++;
                map[w].hours += parseHours(job.Time);
            });
        });
        const entries = Object.entries(map);
        entries.sort((a,b) => b[1].jobs - a[1].jobs);
        const top = entries.slice(0,5);
        const maxJobs = top.length ? top[0][1].jobs : 0;
        top.forEach(([name,data]) => {
            const row = document.createElement('div');
            row.className = 'worker-row';
            const label = document.createElement('div');
            label.textContent = name;
            const bar = document.createElement('div');
            bar.className = 'bar';
            const width = maxJobs ? (data.jobs / maxJobs * 100) : 0;
            bar.style.background = '#10b981';
            // override flex to allow width to represent percentage
            bar.style.flex = '0 0 ' + width + '%';
            const countText = document.createElement('span');
            countText.textContent = data.jobs;
            row.appendChild(label);
            row.appendChild(bar);
            row.appendChild(countText);
            container.appendChild(row);
        });
    }

    function updateTrendJobs() {
        const container = document.getElementById('jobsTrendList');
        if (!container) return;
        container.innerHTML = '';
        const {startDate, endDate} = getPeriodDates();
        const trendMap = {};
        reportFilteredJobs.forEach(job => {
            if (!job.Date) return;
            const d = new Date(job.Date);
            if (d < startDate || d > endDate) return;
            const ws = new Date(d);
            ws.setDate(d.getDate() - d.getDay());
            ws.setHours(0,0,0,0);
            const key = ws.toISOString().slice(0,10);
            trendMap[key] = (trendMap[key] || 0) + 1;
        });
        const keys = Object.keys(trendMap).sort();
        const counts = keys.map(k => trendMap[k]);
        const maxCount = counts.length ? Math.max(...counts) : 0;
        keys.forEach(k => {
            const count = trendMap[k];
            const item = document.createElement('div');
            item.className = 'trend-item';
            const barContainer = document.createElement('div');
            barContainer.className = 'bar-container';
            const bar = document.createElement('div');
            bar.className = 'bar';
            const heightPerc = maxCount ? (count / maxCount * 100) : 0;
            bar.style.height = heightPerc + '%';
            bar.style.background = '#f59e0b';
            barContainer.appendChild(bar);
            const label = document.createElement('div');
            const dateObj = new Date(k);
            label.textContent = (dateObj.getMonth()+1) + '/' + dateObj.getDate();
            const val = document.createElement('div');
            val.textContent = count;
            item.appendChild(barContainer);
            item.appendChild(label);
            item.appendChild(val);
            container.appendChild(item);
        });
    }

    function updateReportTable() {
        const head = document.getElementById('reportsTableHeaders');
        const body = document.getElementById('reportsTableBody');
        if (!head || !body) return;
        const cols = [
            {name:'Date', key:'Date', type:'date'},
            {name:'Job #', key:'Job_Number'},
            {name:'Status', key:'Status'},
            {name:'Supervisor', key:'Supervisor'},
            {name:'Crew', key:'Crew'},
            {name:'Hours', key:'Time'}
        ];
        head.innerHTML = cols.map(c => `<th>${c.name}</th>`).join('');
        if (!reportFilteredJobs.length) {
            body.innerHTML = `<tr><td colspan="${cols.length}" class="empty">No jobs found</td></tr>`;
            return;
        }
        body.innerHTML = reportFilteredJobs.map(job => {
            return '<tr>' + cols.map(c => {
                let v = job[c.key] || '';
                if (c.type === 'date' && v) {
                    v = new Date(v).toLocaleDateString('en-US');
                } else if (c.name === 'Hours') {
                    v = parseHours(v);
                }
                return `<td>${v}</td>`;
            }).join('') + '</tr>';
        }).join('');
    }

    function updateReportLastSync() {
        const label = document.getElementById('reportLastSync');
        if (!label || !reportLastSync) return;
        const now = new Date();
        const diffMin = Math.round((now - reportLastSync) / 60000);
        if (diffMin <= 0) {
            label.textContent = 'Updated just now';
        } else if (diffMin === 1) {
            label.textContent = 'Updated 1 min ago';
        } else {
            label.textContent = `Updated ${diffMin} mins ago`;
        }
    }

    function exportReports() {
        const cols = ['Date','Job_Number','Status','Supervisor','Crew','Hours'];
        let csv = cols.join(',') + '\n';
        reportFilteredJobs.forEach(job => {
            const row = [];
            row.push(job.Date ? new Date(job.Date).toLocaleDateString('en-US') : '');
            row.push(job.Job_Number || '');
            row.push(job.Status || '');
            row.push(job.Supervisor || '');
            row.push(job.Crew || '');
            row.push(parseHours(job.Time));
            csv += row.map(cell => {
                const cellStr = (cell||'').toString().replace(/"/g,'""');
                if (cellStr.includes(',') || cellStr.includes('"')) {
                    return '"' + cellStr + '"';
                }
                return cellStr;
            }).join(',') + '\n';
        });
        const blob = new Blob([csv], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'report.csv';
        link.click();
        URL.revokeObjectURL(url);
    }

    function compareReports() {
        showNotification('Compare periods feature coming soon','info');
    }

    // Update the status distribution donut chart and legend
    function updateStatusDonut() {
        const total = reportFilteredJobs.length;
        const counts = {};
        REPORT_STATUS_LIST.forEach(s => { counts[s] = 0; });
        reportFilteredJobs.forEach(job => {
            const s = job.Status || '';
            if (counts.hasOwnProperty(s)) counts[s]++;
        });
        const donut = document.getElementById('statusDonutChart');
        const center = document.getElementById('statusDonutCenter');
        const legend = document.getElementById('statusLegend');
        if (!donut || !center || !legend) return;
        let offset = 0;
        const parts = [];
        REPORT_STATUS_LIST.forEach(s => {
            const count = counts[s];
            const pct = total ? (count / total) : 0;
            if (pct > 0) {
                const startDeg = offset * 360;
                offset += pct;
                const endDeg = offset * 360;
                parts.push(`${REPORT_STATUS_COLORS[s]} ${startDeg}deg ${endDeg}deg`);
            }
        });
        if (parts.length === 0) {
            donut.style.background = '#e5e7eb';
        } else {
            donut.style.background = `conic-gradient(${parts.join(',')})`;
        }
        center.textContent = total;
        // Build legend
        legend.innerHTML = '';
        REPORT_STATUS_LIST.forEach(s => {
            const count = counts[s];
            if (typeof count === 'undefined') return;
            const div = document.createElement('div');
            div.className = 'legend-item';
            div.innerHTML = `<span class="color-box" style="background:${REPORT_STATUS_COLORS[s]}"></span>${s} (${count})`;
            div.addEventListener('click', () => {
                const select = document.getElementById('reportStatus');
                if (!select) return;
                if (select.value === s) {
                    select.value = '';
                } else {
                    select.value = s;
                }
                loadReports();
            });
            legend.appendChild(div);
        });
    }

    // Update productivity bar chart for workers
    function updateProductivityPanel() {
        const listEl = document.getElementById('productivityList');
        if (!listEl) return;
        listEl.innerHTML = '';
        const workerCounts = {};
        reportFilteredJobs.forEach(job => {
            const names = [];
            if (job.Supervisor) {
                job.Supervisor.split(',').forEach(n => { const t = n.trim(); if (t) names.push(t); });
            }
            if (job.Crew) {
                job.Crew.split(',').forEach(n => { const t = n.trim(); if (t) names.push(t); });
            }
            names.forEach(name => {
                if (!workerCounts[name]) workerCounts[name] = {total:0, completed:0};
                workerCounts[name].total++;
                const progVal = job.Progress || '';
                if (progVal === '100%' || progVal === 'COMPLETE' || progVal === '100') workerCounts[name].completed++;
            });
        });
        let arr = [];
        for (const name in workerCounts) {
            const info = workerCounts[name];
            arr.push({name, total: info.total, completed: info.completed, efficiency: info.total ? info.completed / info.total : 0});
        }
        arr.sort((a,b) => b.total - a.total);
        const top = arr.slice(0, 5);
        let maxTotal = 0;
        top.forEach(w => { if (w.total > maxTotal) maxTotal = w.total; });
        top.forEach(w => {
            const pct = maxTotal ? (w.total / maxTotal * 100) : 0;
            const efficiencyPct = w.total ? Math.round(w.efficiency * 100) : 0;
            const row = document.createElement('div');
            row.className = 'worker-row';
            row.innerHTML = `<span style="width:80px; overflow:hidden; text-overflow:ellipsis;" title="${w.name}">${w.name}</span>` +
                `<div style="flex:1; margin:0 8px;"><div style="height:6px; border-radius:3px; background:#e5e7eb; overflow:hidden;"><div style="width:${pct}%; height:100%; background:#3b82f6;"></div></div></div>` +
                `<span style="width:40px; text-align:right;">${w.total}</span><span style="margin-left:4px; font-size:10px;">(${efficiencyPct}%)</span>`;
            listEl.appendChild(row);
        });
    }

    // Update equipment state summary
    function updateEquipmentPanel() {
        const container = document.getElementById('equipmentSummary');
        if (!container) return;
        let total = 0, used = 0, active = 0;
        reportFilteredJobs.forEach(job => {
            total += parseFloat(job.MP_Total) || 0;
            used += parseFloat(job.MP_Used) || 0;
            active += parseFloat(job.MP_Active) || 0;
        });
        const available = total - used;
        container.innerHTML = '';
        const summary = document.createElement('div');
        summary.className = 'report-summary';
        const items = [
            {label:'Total', value: total, color:'#3b82f6'},
            {label:'Used', value: used, color:'#ef4444'},
            {label:'Active', value: active, color:'#f59e0b'},
            {label:'Available', value: available, color:'#10b981'}
        ];
        let maxVal = 0;
        items.forEach(it => { if (it.value > maxVal) maxVal = it.value; });
        items.forEach(it => {
            const row = document.createElement('div');
            row.className = 'summary-row';
            const label = document.createElement('span');
            label.textContent = it.label;
            const val = document.createElement('span');
            val.textContent = Math.round(it.value);
            row.appendChild(label);
            row.appendChild(val);
            summary.appendChild(row);
            const barContainer = document.createElement('div');
            barContainer.className = 'bar-container';
            const barFill = document.createElement('div');
            barFill.className = 'bar-fill';
            const width = maxVal ? (it.value / maxVal * 100) : 0;
            barFill.style.width = width + '%';
            barFill.style.background = it.color;
            barContainer.appendChild(barFill);
            summary.appendChild(barContainer);
        });
        container.appendChild(summary);
    }

    // Update financial analysis summary
    function updateFinancePanel() {
        const container = document.getElementById('financeSummary');
        if (!container) return;
        let total = 0;
        reportFilteredJobs.forEach(job => {
            total += parseFloat(job.Change_Order) || 0;
        });
        const avg = reportFilteredJobs.length ? (total / reportFilteredJobs.length) : 0;
        container.innerHTML = '';
        const summary = document.createElement('div');
        summary.className = 'report-summary';
        const format = val => {
            return val.toLocaleString('en-US', {style:'currency', currency:'USD', minimumFractionDigits:2});
        };
        summary.innerHTML = `
            <div class="summary-row"><span>Total Cost</span><span>${format(total)}</span></div>
            <div class="summary-row"><span>Average per Job</span><span>${format(avg)}</span></div>
        `;
        container.appendChild(summary);
    }

    // Update HR summary
    function updateHRPanel() {
        const container = document.getElementById('hrSummary');
        if (!container) return;
        // Ensure staff data is loaded
        if (!staffData || !staffData.supervisors || !staffData.crew) {
            container.textContent = 'No staff data';
            return;
        }
        const totalSup = staffData.supervisors.length;
        const totalCrew = staffData.crew.length;
        const availableSup = staffData.supervisors.filter(s => (s.Status || s.status) === 'AVAILABLE').length;
        const availableCrew = staffData.crew.filter(c => (c.Status || c.status) === 'AVAILABLE').length;
        container.innerHTML = '';
        const summary = document.createElement('div');
        summary.className = 'report-summary';
        summary.innerHTML = `
            <div class="summary-row"><span>Total Supervisors</span><span>${totalSup}</span></div>
            <div class="summary-row"><span>Available Supervisors</span><span>${availableSup}</span></div>
            <div class="summary-row"><span>Total Crew</span><span>${totalCrew}</span></div>
            <div class="summary-row"><span>Available Crew</span><span>${availableCrew}</span></div>
        `;
        container.appendChild(summary);
    }

    // Update weekly summary
    function updateWeeklySummaryPanel() {
        const container = document.getElementById('weeklySummary');
        if (!container) return;
        container.innerHTML = '';
        const counts = {};
        reportFilteredJobs.forEach(job => {
            if (!job.Date) return;
            const date = new Date(job.Date);
            // Monday-based week start
            const monday = new Date(date);
            const day = monday.getDay();
            const diff = day === 0 ? 6 : day - 1;
            monday.setDate(monday.getDate() - diff);
            const key = monday.toISOString().split('T')[0];
            counts[key] = (counts[key] || 0) + 1;
        });
        const entries = Object.entries(counts).sort((a,b) => new Date(a[0]) - new Date(b[0]));
        if (!entries.length) {
            container.textContent = 'No data';
            return;
        }
        let maxCount = 0;
        entries.forEach(([_,c]) => { if (c > maxCount) maxCount = c; });
        entries.forEach(([weekStart, count]) => {
            const dateObj = new Date(weekStart);
            const label = 'Week of ' + dateObj.toLocaleDateString('en-US', {month:'short', day:'numeric'});
            const pct = maxCount ? (count / maxCount * 100) : 0;
            const row = document.createElement('div');
            row.className = 'week-item';
            row.innerHTML = `<div style="display:flex; justify-content:space-between;"><span>${label}</span><span>${count}</span></div>` +
                `<div class="bar-container"><div class="bar-fill" style="width:${pct}%; background:#3b82f6;"></div></div>`;
            container.appendChild(row);
        });
    }

    // Update alerts and notifications panel
    function updateAlertsPanel() {
        const container = document.getElementById('alertsList');
        const kpiAlerts = document.getElementById('kpiAlerts');
        if (!container) return;
        container.innerHTML = '';
        const alerts = [];
        reportFilteredJobs.forEach(job => {
            const progVal = job.Progress || '';
            const notified = job.Notified || '';
            const scheduled = job.Scheduled || '';
            if (progVal === 'HOLD' || progVal === 'PUSH' || notified === 'No' || scheduled === 'No') {
                alerts.push(job);
            }
        });
        if (kpiAlerts) kpiAlerts.textContent = alerts.length;
        if (!alerts.length) {
            container.textContent = 'No alerts';
            return;
        }
        alerts.forEach(job => {
            const dateStr = job.Date ? new Date(job.Date).toLocaleDateString('en-US') : '';
            const status = job.Status || '';
            const row = document.createElement('div');
            let level = 'ok';
            const progVal = job.Progress || '';
            const notified = job.Notified || '';
            const scheduled = job.Scheduled || '';
            if (progVal === 'HOLD' || progVal === 'PUSH') level = 'critical';
            else if (notified === 'No' || scheduled === 'No') level = 'warning';
            row.className = `alert-item alert-${level}`;
            row.innerHTML = `<span>${dateStr} - ${job.Job_Number || ''}</span><span class="badge">${status}</span>`;
            container.appendChild(row);
        });
    }

    async function initReportsPage() {
        await populateReportFilters();
        const periodEl = $('#reportPeriod');
        if (periodEl && !periodEl.dataset.bound) {
            periodEl.addEventListener('change', onReportPeriodChange);
            periodEl.dataset.bound = '1';
        }
        const supEl = $('#reportSupervisor');
        if (supEl && !supEl.dataset.bound) {
            supEl.addEventListener('change', loadReports);
            supEl.dataset.bound = '1';
        }
        const locEl = $('#reportLocation');
        if (locEl && !locEl.dataset.bound) {
            locEl.addEventListener('change', loadReports);
            locEl.dataset.bound = '1';
        }
        const statusEl = $('#reportStatus');
        if (statusEl && !statusEl.dataset.bound) {
            statusEl.addEventListener('change', loadReports);
            statusEl.dataset.bound = '1';
        }
        const posEl = $('#reportPosition');
        if (posEl && !posEl.dataset.bound) {
            posEl.addEventListener('change', loadReports);
            posEl.dataset.bound = '1';
        }
        const fromEl = $('#reportFrom');
        if (fromEl && !fromEl.dataset.bound) {
            fromEl.addEventListener('change', loadReports);
            fromEl.dataset.bound = '1';
        }
        const toEl = $('#reportTo');
        if (toEl && !toEl.dataset.bound) {
            toEl.addEventListener('change', loadReports);
            toEl.dataset.bound = '1';
        }
        const refreshBtn = $('#reportRefresh');
        if (refreshBtn && !refreshBtn.dataset.bound) {
            refreshBtn.addEventListener('click', loadReports);
            refreshBtn.dataset.bound = '1';
        }
        const exportBtn = $('#reportExport');
        if (exportBtn && !exportBtn.dataset.bound) {
            exportBtn.addEventListener('click', exportReports);
            exportBtn.dataset.bound = '1';
        }
        const compareBtn = $('#reportCompare');
        if (compareBtn && !compareBtn.dataset.bound) {
            compareBtn.addEventListener('click', compareReports);
            compareBtn.dataset.bound = '1';
        }
        loadReports();
    }

    // Users Management Functions
    // Load list of users from backend and render table
    async function loadUsers() {
        try {
            const res = await callAPI('getUsers');
            if (res.success) {
                users = res.users || [];
            } else {
                users = [];
            }
        } catch (e) {
            console.error('Failed to load users', e);
            users = [];
        }
        renderUsersTable();
    }
    // Render the users table
    function renderUsersTable() {
        const container = document.getElementById('usersTableContainer');
        if (!container) return;
        if (!users || !users.length) {
            container.innerHTML = '<div class="empty">No users found</div>';
            return;
        }
        let html = '<table style="width:100%; border-collapse:collapse; font-size:12px;">';
        html += '<thead><tr><th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">Username</th><th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">Role</th><th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">Status</th><th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">Actions</th></tr></thead><tbody>';
        users.forEach((u, idx) => {
            const uname = u.username || u.email || u.name || '';
            const role = u.role || '';
            const active = (u.active === false || u.active === 'false') ? 'Inactive' : 'Active';
            html += `<tr><td style="padding:6px 8px; border-bottom:1px solid var(--border);">${uname}</td>`;
            html += `<td style="padding:6px 8px; border-bottom:1px solid var(--border);">${role}</td>`;
            html += `<td style="padding:6px 8px; border-bottom:1px solid var(--border);">${active}</td>`;
            html += `<td style="padding:6px 8px; border-bottom:1px solid var(--border);"><button class="btn small" data-edit-user="${idx}">Edit</button> <button class="btn small btn-danger" data-delete-user="${idx}">Delete</button></td></tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
        // Attach edit and delete handlers
        container.querySelectorAll('button[data-edit-user]').forEach(btn => {
            if (!btn.dataset.bound) {
                btn.addEventListener('click', () => {
                    const idx = parseInt(btn.dataset.editUser);
                    openUserModal(users[idx], idx);
                });
                btn.dataset.bound = '1';
            }
        });
        container.querySelectorAll('button[data-delete-user]').forEach(btn => {
            if (!btn.dataset.bound) {
                btn.addEventListener('click', async () => {
                    const idx = parseInt(btn.dataset.deleteUser);
                    const user = users[idx];
                    if (!confirm('Delete this user?')) return;
                    try {
                        const res = await callAPI('deleteUser', { username: user.username || user.email || user.name });
                        if (res.success) {
                            showNotification('User deleted', 'success');
                            loadUsers();
                        } else {
                            showNotification(res.error || 'Failed to delete user', 'error');
                        }
                    } catch (e) {
                        console.error('Delete user failed', e);
                        showNotification('Error deleting user', 'error');
                    }
                });
                btn.dataset.bound = '1';
            }
        });
    }
    // Open modal for adding or editing a user
    function openUserModal(user = null, index = null) {
        const modal = document.getElementById('modalUser');
        if (!modal) return;
        const title = modal.querySelector('.modal-title');
        const usernameInput = document.getElementById('userUsername');
        const passwordInput = document.getElementById('userPassword');
        const roleSelect = document.getElementById('userRole');
        const activeSelect = document.getElementById('userActive');
        if (user) {
            title.textContent = 'Edit User';
            usernameInput.value = user.username || user.email || user.name || '';
            passwordInput.value = '';
            roleSelect.value = user.role || 'USER';
            activeSelect.value = (user.active === false || user.active === 'false') ? 'false' : 'true';
            usernameInput.disabled = true;
            modal.dataset.editIndex = index;
        } else {
            title.textContent = 'Add User';
            usernameInput.value = '';
            passwordInput.value = '';
            roleSelect.value = 'USER';
            activeSelect.value = 'true';
            usernameInput.disabled = false;
            delete modal.dataset.editIndex;
        }
        modal.classList.add('show');
    }

    // Handle click for Add User button, ensuring the event doesn't propagate and cause unexpected navigation
    function openUserModalClick(event) {
        if (event) event.stopPropagation();
        openUserModal();
    }
    // Close the user modal
    function closeUserModal() {
        const modal = document.getElementById('modalUser');
        if (modal) modal.classList.remove('show');
    }
    // Save user (add or edit)
    async function saveUser() {
        const modal = document.getElementById('modalUser');
        if (!modal) return;
        const username = document.getElementById('userUsername').value.trim();
        const password = document.getElementById('userPassword').value.trim();
        const role = document.getElementById('userRole').value;
        const active = document.getElementById('userActive').value === 'true';
        if (!username) {
            showNotification('Username is required', 'error');
            return;
        }
        const editIndex = modal.dataset.editIndex ? parseInt(modal.dataset.editIndex) : null;
        if (editIndex !== null) {
            // update existing
            const oldUser = users[editIndex];
            const payload = { username: oldUser.username || oldUser.email || oldUser.name, updates: { role, active } };
            if (password) payload.updates.password = password;
            try {
                const res = await callAPI('updateUser', payload);
                if (res.success) {
                    showNotification('User updated', 'success');
                    closeUserModal();
                    loadUsers();
                } else {
                    showNotification(res.error || 'Failed to update user', 'error');
                }
            } catch (e) {
                console.error('Update user error', e);
                showNotification('Error updating user', 'error');
            }
        } else {
            // create new
            if (!password) {
                showNotification('Password is required', 'error');
                return;
            }
            const payload = { username, password, role, active };
            try {
                const res = await callAPI('addUser', payload);
                if (res.success) {
                    showNotification('User added', 'success');
                    closeUserModal();
                    loadUsers();
                } else {
                    showNotification(res.error || 'Failed to add user', 'error');
                }
            } catch (e) {
                console.error('Add user error', e);
                showNotification('Error adding user', 'error');
            }
        }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
        // Load local config
        loadLocalConfig();
        // Initialize theme based on saved preference
        const savedTheme = localStorage.getItem('opsis_theme') || 'auto';
        applyTheme(savedTheme);
        const themeSelectEl = document.getElementById('themeSelect');
        if (themeSelectEl) {
            themeSelectEl.value = savedTheme;
            if (!themeSelectEl.dataset.bound) {
                themeSelectEl.addEventListener('change', () => {
                    localStorage.setItem('opsis_theme', themeSelectEl.value);
                    applyTheme(themeSelectEl.value);
                });
                themeSelectEl.dataset.bound = '1';
            }
        }

        // Move appearance section into settings page-body if defined
        const appearanceSection = document.getElementById('appearance');
        const settingsBody = document.querySelector('#settings .page-body');
        if (appearanceSection && settingsBody && !appearanceSection.dataset.moved) {
            settingsBody.appendChild(appearanceSection);
            appearanceSection.dataset.moved = '1';
        }
        // Initialize company name display
        const companyNameDisplay = document.getElementById('companyNameDisplay');
        const companyNameInput = document.getElementById('companyName');
        if (companyNameInput && companyNameDisplay) {
            const storedCompany = localStorage.getItem('cve_companyName') || companyNameInput.value || '';
            companyNameInput.value = storedCompany;
            companyNameDisplay.textContent = storedCompany;
            if (!companyNameInput.dataset.bound) {
                companyNameInput.addEventListener('input', () => {
                    const name = companyNameInput.value.trim();
                    localStorage.setItem('cve_companyName', name);
                    companyNameDisplay.textContent = name;
                });
                companyNameInput.dataset.bound = '1';
            }
        }
        // No custom button radius input in this simplified appearance panel
        // Appearance reset button is not used in the simplified appearance configuration

        // User management: bind add and save buttons
        const addUserBtn = document.getElementById('btnAddUser');
        if (addUserBtn && !addUserBtn.dataset.bound) {
            addUserBtn.addEventListener('click', () => {
                openUserModal();
            });
            addUserBtn.dataset.bound = '1';
        }
        const saveUserBtn = document.getElementById('btnSaveUser');
        if (saveUserBtn && !saveUserBtn.dataset.bound) {
            saveUserBtn.addEventListener('click', () => {
                saveUser();
            });
            saveUserBtn.dataset.bound = '1';
        }
        // Setup nav clicks
        document.querySelectorAll('.nav-icon').forEach(icon => {
            icon.addEventListener('click', () => {
                switchPage(icon.dataset.page);
            });
        });
        // Setup schedule subtabs
        document.querySelectorAll('#schedule .tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.subtab;
                switchSubtab('schedule', tab);
            });
        });
        // Setup staff subtabs
        document.querySelectorAll('#staff .tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.stafftab;
                switchSubtab('staff', tab);
            });
        });

        // After binding navigation, ensure the current page's border colour is applied
        const activeIcon = document.querySelector('.nav-icon.active');
        if (activeIcon) {
            const activePage = activeIcon.dataset.page;
            if (activePage) switchPage(activePage);
        }
        // Settings tabs
        document.querySelectorAll('#settings .tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.settingstab;
                switchSubtab('settings', tab);
            });
        });
        // Switch schedule view mode
        document.getElementById('viewSimple').addEventListener('click', () => {viewMode='simple'; renderJobsTable();});
        document.getElementById('viewExtended').addEventListener('click', () => {viewMode='extended'; renderJobsTable();});
        document.getElementById('viewComplete').addEventListener('click', () => {viewMode='complete'; renderJobsTable();});
        // Year/Month change
        $('#yearSelect').addEventListener('change', loadSchedule);
        $('#monthSelect').addEventListener('change', loadSchedule);
        // Search jobs
        $('#searchJobs').addEventListener('input', () => {
            const term = $('#searchJobs').value.trim().toLowerCase();
            if (!term) {renderJobsTable(); return;}
            const filtered = jobs.filter(job => {
                return Object.values(job).some(val => (val+'').toLowerCase().includes(term));
            });
            const oldJobs = jobs;
            jobs = filtered;
            renderJobsTable();
            jobs = oldJobs;
        });
        // Column toggling & width changing
        document.getElementById('columnsTableBody').addEventListener('change', (e) => {
            const target = e.target;
            if (target.dataset.toggle) {
                const id = parseInt(target.dataset.toggle);
                const col = columns.find(c => c.id === id);
                if (col) col.visible = target.checked;
                saveLocalConfig();
                renderJobsTable();
            }
            if (target.dataset.width) {
                const id = parseInt(target.dataset.width);
                const col = columns.find(c => c.id === id);
                if (col) col.width = target.value + 'px';
            }
        });
        // Edit column button
        document.getElementById('columnsTableBody').addEventListener('click', e => {
            const btn = e.target.closest('button[data-edit-column]');
            if (btn) {
                const id = parseInt(btn.dataset.editColumn);
                openEditColumnModal(id);
            }
        });
        // Save columns
        $('#btnSaveColumns').addEventListener('click', async () => {
            const result = await callAPI('syncColumns', {columns});
            if (result.success) {
                showNotification('Columns synced!','success');
                saveLocalConfig();
            }
        });
        // Add column: open modal and reset fields
        $('#btnAddColumn').addEventListener('click', () => {
            $('#addColumnName').value = '';
            $('#addColumnType').value = 'text';
            $('#addColumnWidth').value = 120;
            $('#addColumnRequired').value = 'false';
            $('#addColumnVisible').value = 'true';
            $('#addColumnOptions').value = '';
            document.getElementById('addColumnOptionsContainer').style.display = 'none';
            document.getElementById('modalAddColumn').classList.add('show');
        });

        // Show or hide options textarea based on selected column type
        $('#addColumnType').addEventListener('change', () => {
            const val = $('#addColumnType').value;
            const cont = document.getElementById('addColumnOptionsContainer');
            cont.style.display = (val === 'dropdown' || val === 'multiselect') ? 'block' : 'none';
        });
        // Save new column
        $('#btnSaveAddColumn').addEventListener('click', async () => {
            const name = $('#addColumnName').value.trim();
            if (!name) {
                showNotification('Enter column name','error');
                return;
            }
            const type = $('#addColumnType').value;
            const widthVal = $('#addColumnWidth').value || '120';
            const required = $('#addColumnRequired').value === 'true';
            const visible = $('#addColumnVisible').value === 'true';
            let options = [];
            if (type === 'dropdown' || type === 'multiselect') {
                options = $('#addColumnOptions').value.split('\n').map(o => o.trim()).filter(o => o);
            }
            const newCol = {name, type, width: widthVal + 'px', required, visible, options};
            let result;
            try {
                result = await callAPI('addColumn', newCol);
            } catch(e) {
                result = {success:false};
            }
            if (result && result.success) {
                showNotification('Column added','success');
                document.getElementById('modalAddColumn').classList.remove('show');
                // Refresh columns from server to get new ID
                await loadColumns();
            } else {
                showNotification('Failed to add column','error');
            }
        });
        // Add job modal
        $('#btnAddJob').addEventListener('click', () => {
            document.getElementById('modalAddJob').classList.add('show');
            $('#formAddJob').reset();
            // Show basic tab by default
            document.querySelectorAll('#modalAddJob .jobtab').forEach(t => t.style.display='none');
            document.getElementById('basic').style.display='block';
            // highlight basic tab button
            document.querySelectorAll('#modalAddJob [data-jobtab]').forEach(btn => {
                btn.style.borderBottomColor='transparent';
                btn.style.color = '#374151';
            });
            document.querySelector('#modalAddJob [data-jobtab="basic"]').style.borderBottomColor='#3b82f6';
            document.querySelector('#modalAddJob [data-jobtab="basic"]').style.color='#3b82f6';
        });
        // Job form tab switching
        document.querySelectorAll('#modalAddJob [data-jobtab]').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.jobtab;
                document.querySelectorAll('#modalAddJob .jobtab').forEach(c => c.style.display='none');
                document.getElementById(tab).style.display='block';
                document.querySelectorAll('#modalAddJob [data-jobtab]').forEach(b => {
                    b.style.borderBottomColor='transparent';
                    b.style.color = '#374151';
                });
                btn.style.borderBottomColor='#3b82f6';
                btn.style.color='#3b82f6';
            });
        });
        // Save job (create new or update existing)
        $('#btnSaveJob').addEventListener('click', async () => {
            const form = document.getElementById('formAddJob');
            const data = Object.fromEntries(new FormData(form).entries());
            if (!data.Job_Number || !data.Job_Address || !data.Date) {
                showNotification('Fill required fields','error');
                return;
            }
            const year = parseInt($('#yearSelect').value);
            const month = $('#monthSelect').value;
            // If editing an existing job, call updateJob
            if (editingRowId) {
                const updates = Object.assign({}, data);
                const res = await callAPI('updateJob', {rowId: editingRowId, updates: updates, year, month, user:'System'});
                if (res.success) {
                    addOperationLog('Update', data.Job_Number, 'Job updated');
                    showNotification('Job updated','success');
                    editingRowId = null;
                    editingRowIndex = null;
                    document.getElementById('modalAddJob').classList.remove('show');
                    loadSchedule();
                } else {
                    showNotification('Failed to update job','error');
                }
            } else {
                // Create new job
                const res = await callAPI('createJob', {job:data, year, month, user:'System'});
                if (res.success) {
                    addOperationLog('Create', data.Job_Number, 'Job created');
                    showNotification('Job created','success');
                    document.getElementById('modalAddJob').classList.remove('show');
                    loadSchedule();
                } else {
                    showNotification('Failed to create job','error');
                }
            }
        });
        // Add supervisor & crew modals
        $('#btnAddSupervisor').addEventListener('click', () => {
            document.getElementById('formAddSupervisor').reset();
            document.getElementById('modalAddSupervisor').classList.add('show');
        });
        $('#btnAddCrew').addEventListener('click', () => {
            document.getElementById('formAddCrew').reset();
            document.getElementById('modalAddCrew').classList.add('show');
        });
        // Save supervisor
        $('#btnSaveSupervisor').addEventListener('click', async () => {
            const form = document.getElementById('formAddSupervisor');
            const data = Object.fromEntries(new FormData(form).entries());
            if (!data.employeeNumber || !data.fullName) {
                showNotification('Fill Employee # and Full Name','error');
                return;
            }
            const specials = [...form.elements['specialties'].selectedOptions].map(opt => opt.value);
            const staffObj = {
                employeeNumber: data.employeeNumber.trim(),
                fullName: data.fullName.trim(),
                role: 'SUPERVISOR',
                status: data.status,
                division: data.division,
                specialties: specials
            };
            const res = await callAPI('addStaff', {type:'supervisor', data: staffObj});
            if (res.success) {
                showNotification('Supervisor added','success');
                document.getElementById('modalAddSupervisor').classList.remove('show');
                loadSupervisors();
            } else {
                showNotification('Failed to add supervisor','error');
            }
        });
        // Save crew
        $('#btnSaveCrew').addEventListener('click', async () => {
            const form = document.getElementById('formAddCrew');
            const data = Object.fromEntries(new FormData(form).entries());
            if (!data.employeeNumber || !data.fullName) {
                showNotification('Fill Employee # and Full Name','error');
                return;
            }
            const specials = [...form.elements['specialties'].selectedOptions].map(opt => opt.value);
            const staffObj = {
                employeeNumber: data.employeeNumber.trim(),
                fullName: data.fullName.trim(),
                role: 'CREW',
                status: data.status,
                division: data.division,
                specialties: specials
            };
            const res = await callAPI('addStaff', {type:'crew', data: staffObj});
            if (res.success) {
                showNotification('Crew member added','success');
                document.getElementById('modalAddCrew').classList.remove('show');
                loadCrew();
            } else {
                showNotification('Failed to add crew member','error');
            }
        });
        // Add skill modal
        $('#btnAddSkill').addEventListener('click', () => {
            document.getElementById('modalAddSkill').classList.add('show');
        });
        $('#btnSaveSkill').addEventListener('click', async () => {
            const name = $('#newSkillName').value.trim();
            if (!name) { showNotification('Enter skill name','error'); return; }
            const type = $('#newSkillType').value;
            const desc = $('#newSkillDescription').value;
            const res = await callAPI('addSkill', {name, type, description: desc});
            if (res.success) {
                showNotification('Skill added','success');
                document.getElementById('modalAddSkill').classList.remove('show');
                loadSkillsMatrix();
            } else {
                showNotification('Failed to add skill','error');
            }
        });
        // Add certification modal
        $('#btnAddCertification').addEventListener('click', () => {
            loadCertificationEmployees();
            document.getElementById('modalAddCertification').classList.add('show');
        });
        $('#btnSaveCertification').addEventListener('click', async () => {
            const form = document.getElementById('formAddCertification');
            const data = Object.fromEntries(new FormData(form).entries());
            if (!data.employee || !data.certificationType || !data.issueDate || !data.expiryDate) {
                showNotification('Fill required fields','error');
                return;
            }
            // Handle file upload (optional)
            const fileInput = document.getElementById('certFile');
            if (fileInput && fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];
                const base64 = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const result = e.target.result || '';
                        const b64 = result.split(',')[1] || '';
                        resolve(b64);
                    };
                    reader.readAsDataURL(file);
                });
                data.fileData = base64;
                data.fileName = file.name;
            }
            const res = await callAPI('addCertification', data);
            if (res.success) {
                showNotification('Certification added','success');
                document.getElementById('modalAddCertification').classList.remove('show');
                loadCertifications();
            } else {
                showNotification('Failed to add certification','error');
            }
        });

        // Update certifications table when filter changes
        const filterTypeSelect = document.getElementById('certFilterType');
        if (filterTypeSelect) {
            filterTypeSelect.addEventListener('change', () => {
                renderCertificationsTable();
            });
        }
        // Certification edit modal actions
        const btnUpdateCert = document.getElementById('btnUpdateCertification');
        if (btnUpdateCert) {
            btnUpdateCert.addEventListener('click', async () => {
                const form = document.getElementById('formEditCertification');
                const certId = form.certId.value;
                const updates = {
                    issueDate: form.issueDate.value,
                    expiryDate: form.expiryDate.value,
                    certNumber: form.certNumber.value,
                    notes: form.notes.value
                };
                const fileInput = document.getElementById('editCertFile');
                if (fileInput && fileInput.files && fileInput.files[0]) {
                    const file = fileInput.files[0];
                    const base64 = await new Promise(resolve => {
                        const reader = new FileReader();
                        reader.onload = e => {
                            const resData = e.target.result || '';
                            resolve(resData.split(',')[1] || '');
                        };
                        reader.readAsDataURL(file);
                    });
                    updates.fileData = base64;
                    updates.fileName = file.name;
                }
                const res = await callAPI('updateCertification', {id: certId, updates});
                if (res.success) {
                    showNotification('Certification updated','success');
                    const idx = certifications.findIndex(c => (c.Cert_ID || c.id) === certId);
                    if (idx !== -1) {
                        Object.assign(certifications[idx], updates);
                    }
                    document.getElementById('modalEditCertification').classList.remove('show');
                    renderCertificationsTable();
                } else {
                    showNotification('Failed to update','error');
                }
            });
        }
        const btnDeleteCert = document.getElementById('btnDeleteCertification');
        if (btnDeleteCert) {
            btnDeleteCert.addEventListener('click', async () => {
                const form = document.getElementById('formEditCertification');
                const certId = form.certId.value;
                if (!confirm('Delete this certification?')) return;
                const res = await callAPI('deleteCertification', {id: certId});
                if (res.success) {
                    showNotification('Certification deleted','success');
                    certifications = certifications.filter(c => (c.Cert_ID || c.id) !== certId);
                    document.getElementById('modalEditCertification').classList.remove('show');
                    renderCertificationsTable();
                } else {
                    showNotification('Failed to delete','error');
                }
            });
        }
        // Test API connection
        $('#btnTestApi').addEventListener('click', async () => {
            if (!gasUrl) { showNotification('Enter API URL','error'); return; }
            const res = await callAPI('getDashboardStats');
            if (res.success) {
                showNotification('Connected!','success');
            } else {
                showNotification('Connection failed','error');
            }
        });
        // Save API URL
        $('#btnSaveApi').addEventListener('click', () => {
            gasUrl = $('#gasUrl').value.trim();
            if (!gasUrl) {
                showNotification('Enter API URL','error'); return;
            }
            saveLocalConfig();
            showNotification('API URL saved','success');
        });
        // Initialize sheets
        document.querySelectorAll('#settings [data-year]').forEach(btn => {
            btn.addEventListener('click', async () => {
                const year = parseInt(btn.dataset.year);
                const res = await callAPI('initializeYearSheet', {year});
                if (res.success) {
                    showNotification(`Year ${year} sheet initialized`,'success');
                } else {
                    showNotification(`Failed to init ${year}`, 'error');
                }
            });
        });
        // Modal close buttons
        document.querySelectorAll('[data-close]').forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.dataset.close;
                document.getElementById(target).classList.remove('show');
            });
        });
        // Staff specialties tab toggling
        document.getElementById('teamSupTab').addEventListener('click', () => {
            document.getElementById('teamSupTab').classList.add('active');
            document.getElementById('teamCrewTab').classList.remove('active');
            updateSpecialtiesStats();
        });
        document.getElementById('teamCrewTab').addEventListener('click', () => {
            document.getElementById('teamCrewTab').classList.add('active');
            document.getElementById('teamSupTab').classList.remove('active');
            updateSpecialtiesStats();
        });
        // View modes highlight
        ['viewSimple','viewExtended','viewComplete'].forEach(id => {
            document.getElementById(id).addEventListener('click', (e) => {
                document.getElementById('viewSimple').style.background = 'rgba(255,255,255,0.15)';
                document.getElementById('viewExtended').style.background = 'rgba(255,255,255,0.15)';
                document.getElementById('viewComplete').style.background = 'rgba(255,255,255,0.3)';
            });
        });
        // Filter buttons
        $('#btnApplyFilters').addEventListener('click', async () => {
            const filters = {
                dateFrom: $('#filterDateFrom').value,
                dateTo: $('#filterDateTo').value,
                jobNumber: $('#filterJobNumber').value,
                pm: $('#filterPM').value,
                position: $('#filterPosition').value,
                status: $('#filterStatus').value,
                progress: $('#filterProgress').value,
                location: $('#filterLocation').value
            };
            const res = await callAPI('applyAdvancedFilters', {filters});
            if (res.success) {
                jobs = res.jobs || [];
                renderJobsTable();
                $('#jobCount').textContent = res.total;
                updateScheduleStats();
                showNotification('Filters applied','success');
            } else {
                showNotification('Failed to apply filters','error');
            }
        });
        $('#btnClearFilters').addEventListener('click', () => {
            $('#filterDateFrom').value = '';
            $('#filterDateTo').value = '';
            $('#filterJobNumber').value = '';
            $('#filterPM').value = '';
            $('#filterPosition').value = '';
            $('#filterStatus').value = '';
            $('#filterProgress').value = '';
            $('#filterLocation').value = '';
            loadSchedule();
        });
        // Refresh data
        $('#btnRefresh').addEventListener('click', () => {
            loadSchedule();
            loadDashboard();
        });
        // Export CSV
        $('#btnExport').addEventListener('click', async () => {
            const year = parseInt($('#yearSelect').value);
            const month = $('#monthSelect').value;
            const res = await callAPI('exportJobsToCSV', {year, month});
            if (res.success) {
                const blob = new Blob([res.csv], {type:'text/csv'});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = res.filename || `jobs_${year}_${month}.csv`;
                link.click();
                showNotification('CSV exported','success');
            } else {
                showNotification('Failed to export','error');
            }
        });
        // Row action buttons event handlers
        const btnEditRow = document.getElementById('btnEditRow');
        const btnDuplicateRow = document.getElementById('btnDuplicateRow');
        const btnDeleteRow = document.getElementById('btnDeleteRow');
        if (btnEditRow) {
            btnEditRow.addEventListener('click', () => {
                editJobRow();
            });
        }
        if (btnDuplicateRow) {
            btnDuplicateRow.addEventListener('click', () => {
                duplicateJobRow();
            });
        }
        if (btnDeleteRow) {
            btnDeleteRow.addEventListener('click', () => {
                deleteJobRow();
            });
        }
        // Month navigation buttons for mini calendar
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        if (prevMonthBtn) {
            prevMonthBtn.addEventListener('click', () => changeCalendarMonth(-1));
        }
        if (nextMonthBtn) {
            nextMonthBtn.addEventListener('click', () => changeCalendarMonth(1));
        }

        // Apply initial state
        switchPage('dashboard');
        loadSchedule();
        loadDashboard();
        loadStaff();
    });

    // ------- Inline handlers to ensure core actions always work ---------
    // Open the Add Job modal and initialize its fields and tabs
    function openAddJobModal() {
        const modal = document.getElementById('modalAddJob');
        if (!modal) return;
        modal.classList.add('show');
        const form = document.getElementById('formAddJob');
        if (form && form.reset) form.reset();
        // Hide all job tabs and show the basic tab
        document.querySelectorAll('#modalAddJob .jobtab').forEach(c => c.style.display = 'none');
        const basic = document.getElementById('basic');
        if (basic) basic.style.display = 'block';
        // Reset tab button styles
        document.querySelectorAll('#modalAddJob [data-jobtab]').forEach(btn => {
            btn.style.borderBottomColor = 'transparent';
            btn.style.color = '#374151';
        });
        const basicBtn = document.querySelector('#modalAddJob [data-jobtab="basic"]');
        if (basicBtn) {
            basicBtn.style.borderBottomColor = '#3b82f6';
            basicBtn.style.color = '#3b82f6';
        }

    // Expose commonly used modal helper functions globally so they can be invoked from inline HTML attributes
    window.openAddJobModal = openAddJobModal;
    window.openScheduleFilters = openScheduleFilters;
    window.refreshPage = refreshPage;
    window.exportSchedule = exportSchedule;
    window.closeModal = closeModal;
    }

    // Show the Filters subtab within the Schedule page
    function openScheduleFilters() {
        switchSubtab('schedule', 'filters');
    }

    // Refresh both schedule and dashboard data
    function refreshPage() {
        loadSchedule();
        loadDashboard();
    }

    // Export the currently selected month of jobs to CSV
    async function exportSchedule() {
        const yearSelect = document.getElementById('yearSelect');
        const monthSelect = document.getElementById('monthSelect');
        if (!yearSelect || !monthSelect) return;
        const year = parseInt(yearSelect.value);
        const month = monthSelect.value;
        try {
            const res = await callAPI('exportJobsToCSV', { year, month });
            if (res && res.success) {
                const blob = new Blob([res.csv], { type: 'text/csv' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = res.filename || `jobs_${year}_${month}.csv`;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showNotification('CSV exported', 'success');
            } else {
                showNotification((res && res.error) || 'Failed to export', 'error');
            }
        } catch (e) {
            showNotification('Export error', 'error');
        }
    }

    // Close any modal by id
    function closeModal(id) {
        const modal = document.getElementById(id);
        if (modal) modal.classList.remove('show');
    }

async function loadCertificationEmployees() {
        const result = await callAPI('getStaff', {});
        const select = document.getElementById('certificationEmployee');
        select.innerHTML = '<option value="">Select Employee</option>';
        if (result.success) {
            const staff = result.staff || [];
            staff.forEach(s => {
                select.innerHTML += `<option value="${s.Employee_Number || s.employeeNumber}">${s.Full_Name || s.fullName}</option>`;
            });
        }
    }

    // Update staff overview metrics based on loaded staff and certifications
    function updateStaffOverview() {
        try {
            const totalSup = staffData && staffData.supervisors ? staffData.supervisors.length : 0;
            const totalCrew = staffData && staffData.crew ? staffData.crew.length : 0;
            const total = totalSup + totalCrew;
            let availableSup = 0;
            let availableCrew = 0;
            if (staffData && staffData.supervisors) {
                availableSup = staffData.supervisors.filter(s => (s.Status || s.status) === 'AVAILABLE').length;
            }
            if (staffData && staffData.crew) {
                availableCrew = staffData.crew.filter(c => (c.Status || c.status) === 'AVAILABLE').length;
            }
            const available = availableSup + availableCrew;
            if (document.getElementById('overviewTotal')) document.getElementById('overviewTotal').textContent = total;
            if (document.getElementById('overviewAvailable')) document.getElementById('overviewAvailable').textContent = available;
            if (document.getElementById('overviewSupervisors')) document.getElementById('overviewSupervisors').textContent = totalSup;
            if (document.getElementById('overviewCrew')) document.getElementById('overviewCrew').textContent = totalCrew;
            // Compute certifications metrics
            let active = 0;
            let expiring = 0;
            const today = new Date();
            (certifications || []).forEach(cert => {
                const expiry = cert.expiryDate || cert.Expiry_Date;
                if (!expiry) return;
                const expiryDate = new Date(expiry);
                if (isNaN(expiryDate.getTime())) return;
                const diff = (expiryDate.getTime() - today.getTime()) / 86400000;
                const days = Math.floor(diff);
                if (days < 0) return; // expired not counted
                if (days <= 60) expiring++;
                else active++;
            });
            if (document.getElementById('overviewCertified')) document.getElementById('overviewCertified').textContent = active + expiring;
            if (document.getElementById('overviewCertActive')) document.getElementById('overviewCertActive').textContent = active;
            if (document.getElementById('overviewCertExpiring')) document.getElementById('overviewCertExpiring').textContent = expiring;
        } catch(e) {
            console.error('updateStaffOverview error', e);
        }
    }

    function openEditColumnModal(id) {
        const col = columns.find(c => c.id === id);
        if (!col) return;
        $('#editColumnId').value = col.id;
        $('#editColumnName').value = col.name;
        $('#editColumnType').value = col.type;
        $('#editColumnWidth').value = parseInt(col.width);
        $('#editColumnRequired').value = col.required ? 'true' : 'false';
        $('#editColumnDescription').value = col.description || '';
        if (col.type === 'dropdown' || col.type === 'multiselect') {
            $('#editColumnOptionsContainer').style.display = 'block';
            $('#editColumnOptions').value = col.options ? col.options.join('\n') : '';
        } else {
            $('#editColumnOptionsContainer').style.display = 'none';
            $('#editColumnOptions').value = '';
        }
        // Show modal
        document.getElementById('modalEditColumn').classList.add('show');
    }
    // Save edited column
    $('#btnSaveColumn').addEventListener('click', () => {
        const id = parseInt($('#editColumnId').value);
        const col = columns.find(c => c.id === id);
        if (!col) return;
        col.name = $('#editColumnName').value.trim();
        col.type = $('#editColumnType').value;
        col.width = $('#editColumnWidth').value + 'px';
        col.required = $('#editColumnRequired').value === 'true';
        if (col.type === 'dropdown' || col.type === 'multiselect') {
            const opts = $('#editColumnOptions').value.split('\n').map(o => o.trim()).filter(o => o);
            col.options = opts;
        } else {
            col.options = [];
        }
        col.description = $('#editColumnDescription').value;
        renderColumnsTable();
        document.getElementById('modalEditColumn').classList.remove('show');
        saveLocalConfig();
        showNotification('Column saved','success');
    });
    </script>
    <script>
// OPSIS TimeSync integration script
(function(){
    async function postAction(action, body = {}) {
        if (!gasUrl) {
            showNotification('Configure API URL first','error');
            return { ok:false };
        }
        try {
            const res = await fetch(gasUrl, {
                method:'POST',
                headers:{ 'Content-Type':'application/json' },
                body: JSON.stringify(Object.assign({ action }, body))
            });
            return await res.json();
        } catch(err) {
            console.error('postAction error', err);
            return { ok:false, error: err.message };
        }
    }
    function showLogin() { const m=document.getElementById('modalLogin'); if(m) m.classList.add('show'); }
    function hideLogin() { const m=document.getElementById('modalLogin'); if(m) m.classList.remove('show'); }
    async function doLogin() {
        const userEl = document.getElementById('loginUsername');
        const passEl  = document.getElementById('loginPassword');
        const username = userEl ? userEl.value.trim() : '';
        const pass  = passEl ? passEl.value : '';
        if (!username || !pass) {
            showNotification('Enter username and password','error');
            return;
        }
        // Send username as email field for compatibility; backend can treat it as username
        const res = await postAction('auth.login', { email: username, password: pass });
        if (res.ok) {
            opsisToken = res.token;
            opsisRole  = res.role;
            isLoggedIn = true;
            saveLocalConfig();
            hideLogin();
            showNotification('Welcome '+ (res.name || username),'success');
            loadDashboard();
            loadSchedule();
            loadStaff();
        } else {
            showNotification(res.error || 'Login failed','error');
        }
    }
    async function testSheetConnection() {
        const idEl = document.getElementById('sheetId');
        if (!idEl) { showNotification('Spreadsheet input missing','error'); return; }
        const id = idEl.value.trim();
        if (!id) { showNotification('Enter Spreadsheet ID','error'); return; }
        const res = await postAction('setup.test', { spreadsheetId:id });
        const statusEl = document.getElementById('sheetStatus');
        if (res.ok) {
            opsisSheetId = id;
            if (statusEl) statusEl.textContent = 'Connected: ' + res.name;
            saveLocalConfig();
            showNotification('Spreadsheet connected','success');
        } else {
            if (statusEl) statusEl.textContent = res.error || 'Connection failed';
            showNotification(res.error || 'Connection failed','error');
        }
    }
    async function ensureYear() {
        const idEl = document.getElementById('sheetId');
        const yearSel = document.getElementById('activeYearSelect');
        const id = idEl ? idEl.value.trim() : '';
        const yearVal = yearSel ? yearSel.value : '';
        if (!id || !yearVal) { showNotification('Enter Spreadsheet ID and Year','error'); return; }
        const res = await postAction('setup.ensureYear', { spreadsheetId:id, year: yearVal });
        if (res.ok) {
            showNotification('Year ' + yearVal + ' initialized','success');
        } else {
            showNotification(res.error || 'Init failed','error');
        }
    }
    async function switchYearSheet() {
        const idEl = document.getElementById('sheetId');
        const yearSel = document.getElementById('activeYearSelect');
        const id = idEl ? idEl.value.trim() : '';
        const yearVal = yearSel ? yearSel.value : '';
        if (!id || !yearVal) { showNotification('Enter Spreadsheet ID and Year','error'); return; }
        const res = await postAction('setup.switchYear', { spreadsheetId:id, year: yearVal });
        if (res.ok) {
            activeYear = parseInt(yearVal);
            saveLocalConfig();
            showNotification('Active year set to ' + yearVal,'success');
            loadSchedule();
        } else {
            showNotification(res.error || 'Switch failed','error');
        }
    }
    async function readSchema() {
        const idEl = document.getElementById('sheetId');
        const sheetNameEl = document.getElementById('jobsSheetName');
        const id = idEl ? idEl.value.trim() : '';
        const sheetName = sheetNameEl ? sheetNameEl.value.trim() : '';
        if (!id || !sheetName) { showNotification('Enter Spreadsheet ID and jobs sheet name','error'); return; }
        const res = await postAction('schema.read', { spreadsheetId:id, jobsSheet: sheetName });
        if (res.ok) {
            schemaMapping = res.map || null;
            renderSchemaEditor(res.headers, res.map);
            showNotification('Schema loaded','success');
        } else {
            showNotification(res.error || 'Read schema failed','error');
        }
    }
    async function appendReserved() {
        const idEl = document.getElementById('sheetId');
        const sheetNameEl = document.getElementById('jobsSheetName');
        const id = idEl ? idEl.value.trim() : '';
        const sheetName = sheetNameEl ? sheetNameEl.value.trim() : '';
        if (!id || !sheetName) { showNotification('Enter Spreadsheet ID and jobs sheet name','error'); return; }
        const res = await postAction('schema.appendReserved', { spreadsheetId:id, jobsSheet: sheetName });
        if (res.ok) {
            showNotification('Reserved columns appended','success');
        } else {
            showNotification(res.error || 'Failed to append','error');
        }
    }
    async function saveSchemaMapping() {
        const idEl = document.getElementById('sheetId');
        const sheetNameEl = document.getElementById('jobsSheetName');
        const id = idEl ? idEl.value.trim() : '';
        const sheetName = sheetNameEl ? sheetNameEl.value.trim() : '';
        if (!id || !sheetName) { showNotification('Enter Spreadsheet ID and jobs sheet name','error'); return; }
        const selects = document.querySelectorAll('#schemaForm select');
        const mapping = {};
        selects.forEach(function(sel){ mapping[sel.dataset.key] = sel.value || null; });
        const res = await postAction('schema.save', { spreadsheetId:id, jobsSheet: sheetName, schema: mapping });
        if (res.ok) {
            schemaMapping = mapping;
            saveLocalConfig();
            showNotification('Schema saved','success');
        } else {
            showNotification(res.error || 'Save schema failed','error');
        }
    }
    function renderSchemaEditor(headers, map) {
        const container = document.getElementById('schemaForm');
        if (!container) return;
        const fields = [ ['date','Date'], ['type','Type'], ['status','Status'], ['jobNumber','Job Number'], ['time','Time'], ['supervisor','Supervisor'], ['employee','Employee'], ['hours','Hours'], ['location','Location'], ['notes','Notes'], ['id','ID'], ['updatedAt','UpdatedAt'], ['year','Year'], ['deleted','_DELETED'] ];
        let html = '';
        fields.forEach(function(field) {
            const key = field[0];
            const label = field[1];
            html += '<div class="form-row"><div class="form-group" style="flex:1;">';
            html += '<label style="font-size:12px;">' + label + '</label>';
            html += '<select data-key="' + key + '" class="form-control">';
            html += '<option value="">â€” Unassigned â€”</option>';
            headers.forEach(function(h) {
                const sel = (map && map[key] === h) ? 'selected' : '';
                html += '<option value="' + h + '" ' + sel + '>' + h + '</option>';
            });
            html += '</select></div></div>';
        });
        container.innerHTML = html;
    }
    document.addEventListener('DOMContentLoaded', function() {
        if (!isLoggedIn) {
            showLogin();
        }
        const loginBtn = document.getElementById('btnLogin');
        if (loginBtn && !loginBtn.dataset.bound) {
            loginBtn.addEventListener('click', doLogin);
            loginBtn.dataset.bound = '1';
        }
        const testBtn = document.getElementById('btnTestSheet');
        if (testBtn && !testBtn.dataset.bound) {
            testBtn.addEventListener('click', testSheetConnection);
            testBtn.dataset.bound = '1';
        }
        const ensureBtn = document.getElementById('btnEnsureYear');
        if (ensureBtn && !ensureBtn.dataset.bound) {
            ensureBtn.addEventListener('click', ensureYear);
            ensureBtn.dataset.bound = '1';
        }
        const switchBtn = document.getElementById('btnSwitchYear');
        if (switchBtn && !switchBtn.dataset.bound) {
            switchBtn.addEventListener('click', switchYearSheet);
            switchBtn.dataset.bound = '1';
        }
        const readBtn = document.getElementById('btnReadSchema');
        if (readBtn && !readBtn.dataset.bound) {
            readBtn.addEventListener('click', readSchema);
            readBtn.dataset.bound = '1';
        }
        const appendBtn = document.getElementById('btnAppendReserved');
        if (appendBtn && !appendBtn.dataset.bound) {
            appendBtn.addEventListener('click', appendReserved);
            appendBtn.dataset.bound = '1';
        }
        const saveBtn = document.getElementById('btnSaveSchema');
        if (saveBtn && !saveBtn.dataset.bound) {
            saveBtn.addEventListener('click', saveSchemaMapping);
            saveBtn.dataset.bound = '1';
        }
    });
    // After all definitions and event bindings, expose functions globally for inline handlers
    window.openAddJobModal = openAddJobModal;
    window.openScheduleFilters = openScheduleFilters;
    window.refreshPage = refreshPage;
    window.exportSchedule = exportSchedule;
    window.closeModal = closeModal;
    window.openUserModal = openUserModal;
    window.openUserModalClick = openUserModalClick;
    window.saveUser = saveUser;
})();
</script>


</body></html>
